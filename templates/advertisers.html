{% extends "base.html" %}

{% block title %}Campaigns - WeAD Platform{% endblock %}

{% block nav_links %}
<a href="/" class="nav-link">
    <i class="fas fa-home"></i>
    <span>Home</span>
</a>
<a href="/analytics" class="nav-link">
    <i class="fas fa-graduation-cap"></i>
    <span>Intro</span>
</a>
<a href="/advertisers" class="nav-link active">
    <i class="fas fa-bullhorn"></i>
    <span>Campaigns</span>
</a>
<a href="/campaigns" class="nav-link">
    <i class="fas fa-chart-line"></i>
    <span>Analytics</span>
</a>
<a href="/devices" class="nav-link">
    <i class="fas fa-tv"></i>
    <span>Static Displays</span>
</a>
{% endblock %}

{% block extra_head %}
    <!-- Merriweather Font -->
    <link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@300;400;700&display=swap" rel="stylesheet">
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Interactive Maps System -->
    <!-- Leaflet (Fallback) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- Google Maps API (Primary) - CONFIGURED ‚úÖ -->
    <!-- API Key: AIzaSyA9MNaF0W285rf1cvDjxCYgQNwgHKeR5Yk -->
    <!-- Enabled: Maps JavaScript API, Places API, Geocoding API -->
    <script>
        // Google Maps Configuration
        const GOOGLE_MAPS_CONFIG = {
            API_KEY: 'AIzaSyA9MNaF0W285rf1cvDjxCYgQNwgHKeR5Yk',
            LIBRARIES: ['places', 'geometry', 'visualization'],
            USE_GOOGLE: true // ‚úÖ Google Maps enabled!
        };
    </script>
    <!-- Load Google Maps if API key is provided -->
    <script>
        if (GOOGLE_MAPS_CONFIG.API_KEY && GOOGLE_MAPS_CONFIG.API_KEY.length > 0) {
            const script = document.createElement('script');
            script.src = `https://maps.googleapis.com/maps/api/js?key=${GOOGLE_MAPS_CONFIG.API_KEY}&libraries=${GOOGLE_MAPS_CONFIG.LIBRARIES.join(',')}&callback=initGoogleMap`;
            script.async = true;
            script.defer = true;
            document.head.appendChild(script);
            GOOGLE_MAPS_CONFIG.USE_GOOGLE = true;
            console.log('‚úÖ Loading Google Maps API...');
        } else {
            console.log('‚ö†Ô∏è No Google Maps API key found - Using Leaflet fallback');
        }
    </script>

    <!-- Google Sign-In -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>

    <!-- Location Targeting System -->
    <!-- <script src="/static/location_targeting.js"></script> -->

    <!-- Analytics Dashboard -->
    <!-- <script src="/static/analytics_dashboard.js"></script> -->
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="/static/manifest.json">
    
    <!-- Preload Critical Resources -->
    <link rel="preload" href="/static/styles.css" as="style">
    <link rel="preload" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" as="style">
    
    <!-- Performance Optimization -->
    <link rel="dns-prefetch" href="//fonts.googleapis.com">
    <link rel="dns-prefetch" href="//cdnjs.cloudflare.com">
    <link rel="dns-prefetch" href="//cdn.jsdelivr.net">
    
    <!-- Security Headers -->
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta http-equiv="X-Frame-Options" content="DENY">
    <meta http-equiv="X-XSS-Protection" content="1; mode=block">
    
    <style>
        /* Advertiser Section - Dark Red Theme Override */
        :root {
            --quantum-primary: #8B0000 !important;
            --primary: #8B0000 !important;
            --secondary: #5c0000 !important;
            --glow-primary: #8B0000 !important;
            --glow-secondary: #5c0000 !important;
        }
        
        /* Override h1 - White titles */
        h1 {
            background: none !important;
            color: white !important;
            -webkit-text-fill-color: white !important;
            text-shadow: 0 0 20px rgba(139, 0, 0, 0.5) !important;
        }
        
        /* Override h2 - White subtitles */
        h2 {
            color: white !important;
        }
        
        /* Override h3 - White section headers */
        h3 {
            color: white !important;
        }
        
        /* Override button primary styles */
        .btn-primary {
            background: linear-gradient(135deg, #8B0000, #5c0000) !important;
            border-color: #8B0000 !important;
        }
        
        .btn-primary:hover {
            background: linear-gradient(135deg, #5c0000, #3d0000) !important;
            box-shadow: 0 5px 15px rgba(139, 0, 0, 0.4) !important;
        }
        
        /* Override nav-link styles for advertiser section */
        .nav-link:hover,
        .nav-link.active {
            color: #DC143C !important;
            border: 2px solid rgba(220, 20, 60, 0.5) !important;
            box-shadow: 0 4px 15px rgba(220, 20, 60, 0.3) !important;
        }
        
        .nav-link.active {
            border: 2px solid rgba(220, 20, 60, 0.8) !important;
            box-shadow: 0 0 20px rgba(220, 20, 60, 0.5), 0 0 40px rgba(220, 20, 60, 0.3) !important;
        }
        
        /* Override stat-icon background to lighter red */
        .stat-icon {
            background: linear-gradient(135deg, #DC143C, #B22222) !important;
        }
        
        /* Chart Container Styling */
        .chart-container {
            position: relative;
            width: 100% !important;
            height: 400px !important;
            min-height: 400px !important;
            padding: 1.5rem !important;
            background: rgba(0, 0, 0, 0.3) !important;
            border-radius: 12px !important;
            border: 2px solid rgba(139, 0, 0, 0.3) !important;
            backdrop-filter: blur(10px) !important;
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
        }
        
        .chart-container canvas {
            display: block !important;
            width: 100% !important;
            height: 100% !important;
            max-height: 360px !important;
            visibility: visible !important;
            opacity: 1 !important;
        }
        
        #performanceChart {
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
        }
        
        /* Tabs Container */
        .tabs-container {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            border-bottom: 2px solid rgba(139, 0, 0, 0.3);
            padding-bottom: 0;
            overflow-x: auto;
            scrollbar-width: none; /* Firefox */
            -ms-overflow-style: none; /* IE and Edge */
        }
        
        .tabs-container::-webkit-scrollbar {
            display: none; /* Chrome, Safari, Opera */
        }
        
        .tab-btn {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            padding: 1rem 2rem;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
            white-space: nowrap;
        }
        
        .tab-btn:hover {
            color: #A52A2A;
            background: rgba(139, 0, 0, 0.05);
        }
        
        .tab-btn.active {
            color: #8B0000;
            border-bottom-color: #8B0000;
        }
        
        .tab-btn i {
            font-size: 1.1rem;
        }
        
        /* Tab Content */
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* ========================================
           DESKTOP MAP STYLES (Default)
           ======================================== */
        
        /* Map controls - desktop layout */
        .map-controls {
            display: flex;
            flex-direction: row;
            gap: 1.5rem;
            margin-bottom: 2rem;
            align-items: flex-end;
        }
        
        .control-group {
            flex: 1;
            min-width: 200px;
        }
        
        /* Map container - desktop */
        .map-container {
            position: relative;
            margin-bottom: 2rem;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }
        
        #locationMap {
            height: 500px;
            width: 100%;
            border-radius: 15px;
            background: #f0f0f0;
        }
        
        /* Map legend - desktop */
        .map-legend {
            display: flex;
            flex-wrap: wrap;
            gap: 1.5rem;
            padding: 1rem;
            margin-top: 1.5rem;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 12px;
            border: 2px solid rgba(139, 0, 0, 0.3);
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 0.95rem;
            color: var(--text-secondary);
        }
        
        .legend-color {
            width: 30px;
            height: 30px;
            border-radius: 6px;
            flex-shrink: 0;
            border: 2px solid rgba(255, 255, 255, 0.2);
        }
        
        .legend-color.high-density {
            background: rgba(139, 0, 0, 0.8);
        }
        
        .legend-color.medium-density {
            background: rgba(220, 20, 60, 0.6);
        }
        
        .legend-color.low-density {
            background: rgba(255, 99, 71, 0.4);
        }
        
        .legend-color.selected-area {
            background: rgba(16, 185, 129, 0.6);
        }
        
        /* ========================================
           TABLET STYLES (Medium Screens)
           ======================================== */
        @media (max-width: 1024px) and (min-width: 769px) {
            .map-controls {
                flex-direction: column;
                gap: 1rem;
            }
            
            .control-group {
                width: 100%;
            }
            
            #locationMap {
                height: 400px;
            }
            
            .map-legend {
                gap: 1rem;
            }
        }
        
        /* Mobile Optimization - Complete Overhaul */
        @media (max-width: 768px) {
            /* Remove excessive padding from page container */
            .page-container {
                padding: 0 !important;
            }
            
            .container {
                padding: 0 !important;
                margin: 0 !important;
            }
            
            /* Simplify page header */
            .page-header {
                padding: 1rem !important;
                margin-bottom: 0.5rem !important;
                background: none !important;
                border: none !important;
            }
            
            .page-header h1 {
                font-size: 1.5rem !important;
                margin-bottom: 0.5rem !important;
            }
            
            .page-header p {
                font-size: 0.9rem !important;
            }
            
            /* Make tabs horizontal scroll - IMPROVED VISIBILITY */
            .tabs-container {
                display: flex !important;
                overflow-x: auto !important;
                scrollbar-width: none !important;
                gap: 0.5rem !important;
                padding: 0.75rem 1rem !important;
                margin-bottom: 1rem !important;
                background: rgba(139, 0, 0, 0.15) !important;
                border-top: 2px solid rgba(139, 0, 0, 0.3) !important;
                border-bottom: 2px solid rgba(139, 0, 0, 0.3) !important;
                scroll-snap-type: x mandatory !important;
                -webkit-overflow-scrolling: touch !important;
            }
            
            .tabs-container::-webkit-scrollbar {
                display: none !important;
            }
            
            .tab-btn {
                white-space: nowrap !important;
                font-size: 0.9rem !important;
                padding: 0.75rem 1.25rem !important;
                min-width: auto !important;
                flex-shrink: 0 !important;
                scroll-snap-align: center !important;
                background: rgba(0, 0, 0, 0.4) !important;
                border: 1px solid rgba(139, 0, 0, 0.4) !important;
                border-radius: 8px !important;
                color: #cbd5e1 !important;
                transition: all 0.3s ease !important;
            }
            
            .tab-btn.active {
                background: linear-gradient(135deg, #8B0000, #5c0000) !important;
                border-color: #DC143C !important;
                color: white !important;
                box-shadow: 0 4px 12px rgba(139, 0, 0, 0.4) !important;
                transform: scale(1.05) !important;
            }
            
            .tab-btn i {
                display: inline-block !important; /* Show icons on mobile for better recognition */
                margin-right: 0.4rem !important;
                font-size: 0.9rem !important;
            }
            
            /* Remove ALL nested glass effects on mobile */
            .section.glass {
                background: transparent !important;
                backdrop-filter: none !important;
                border: none !important;
                padding: 0.5rem 1rem !important;
                margin-bottom: 0.5rem !important;
                box-shadow: none !important;
            }
            
            .form-section.glass {
                background: rgba(0, 0, 0, 0.2) !important;
                backdrop-filter: none !important;
                border: 1px solid rgba(139, 0, 0, 0.3) !important;
                border-radius: 12px !important;
                padding: 1rem !important;
                margin-bottom: 1rem !important;
                box-shadow: none !important;
            }
            
            .form-grid {
                display: block !important;
                gap: 0 !important;
            }
            
            /* Simplify section titles */
            .section-title {
                font-size: 1.3rem !important;
                margin-bottom: 0.75rem !important;
                padding-bottom: 0.5rem !important;
            }
            
            .section-subtitle {
                font-size: 0.85rem !important;
                margin-bottom: 1rem !important;
            }
            
            /* Form elements */
            .form-group {
                margin-bottom: 1rem !important;
            }
            
            .form-label {
                font-size: 0.9rem !important;
                margin-bottom: 0.4rem !important;
            }
            
            .form-input,
            .form-textarea,
            .form-select {
                font-size: 16px !important; /* Prevents iOS zoom */
                padding: 0.75rem !important;
            }
            
            /* Upload area */
            .upload-area {
                padding: 1.5rem 1rem !important;
                min-height: 150px !important;
            }
            
            .upload-icon {
                font-size: 2rem !important;
            }
            
            /* Tab navigation buttons - Make them equal size */
            .tab-navigation {
                padding: 1rem !important;
                margin-top: 1rem !important;
            }
            
            .tab-navigation .btn {
                padding: 0.75rem 1rem !important;
                font-size: 0.9rem !important;
                font-weight: 600 !important;
                flex: 1 !important;
                white-space: nowrap !important;
            }
            
            .tab-navigation .btn-primary,
            .tab-navigation .btn-secondary {
                padding: 0.75rem 1rem !important;
                font-size: 0.9rem !important;
            }
            
            /* Display options - horizontal scroll */
            .display-options {
                display: flex !important;
                overflow-x: auto !important;
                scroll-snap-type: x mandatory !important;
                gap: 0.75rem !important;
                padding: 0.5rem !important;
                scrollbar-width: none !important;
            }
            
            .display-options::-webkit-scrollbar {
                display: none !important;
            }
            
            .display-option {
                flex: 0 0 45% !important;
                scroll-snap-align: start !important;
                font-size: 0.85rem !important;
                padding: 0.75rem !important;
                min-width: 140px !important;
            }
            
            .display-icon {
                font-size: 1.5rem !important;
            }
            
            .display-name {
                font-size: 0.85rem !important;
            }
            
            /* Size options */
            .size-options {
                margin-top: 0.5rem !important;
            }
            
            .size-select {
                font-size: 14px !important;
                padding: 0.5rem !important;
            }
            
            /* Map controls - stack vertically on mobile */
            .map-controls {
                display: flex !important;
                flex-direction: column !important;
                gap: 1rem !important;
                margin-bottom: 1.5rem !important;
            }
            
            .control-group {
                width: 100% !important;
            }
            
            .control-group .form-select,
            .control-group .btn {
                width: 100% !important;
                font-size: 16px !important; /* Prevents iOS zoom */
            }
            
            /* Map container - mobile */
            .map-container {
                position: relative !important;
                margin-bottom: 1.5rem !important;
                border-radius: 12px !important;
                overflow: hidden !important;
            }
            
            #locationMap {
                height: 350px !important; /* Smaller height on mobile */
                width: 100% !important;
                border-radius: 12px !important;
                background: #f0f0f0 !important;
            }
            
            /* Map legend - horizontal scroll on mobile */
            .map-legend {
                display: flex !important;
                overflow-x: auto !important;
                scroll-snap-type: x mandatory !important;
                gap: 0.75rem !important;
                padding: 0.75rem !important;
                margin-top: 1rem !important;
                background: rgba(0, 0, 0, 0.3) !important;
                border-radius: 8px !important;
                scrollbar-width: none !important;
                -webkit-overflow-scrolling: touch !important;
            }
            
            .map-legend::-webkit-scrollbar {
                display: none !important;
            }
            
            .legend-item {
                flex: 0 0 auto !important;
                white-space: nowrap !important;
                font-size: 0.85rem !important;
                padding: 0.5rem !important;
                display: flex !important;
                align-items: center !important;
                gap: 0.5rem !important;
            }
            
            .legend-color {
                width: 20px !important;
                height: 20px !important;
                min-width: 20px !important;
                border-radius: 4px !important;
                flex-shrink: 0 !important;
            }
            
            /* Location stats - horizontal scroll */
            .location-stats-panel {
                padding: 0.5rem !important;
                margin-top: 1rem !important;
            }
            
            .stats-grid {
                display: flex !important;
                overflow-x: auto !important;
                scroll-snap-type: x mandatory !important;
                gap: 0.75rem !important;
                padding: 0.5rem !important;
                scrollbar-width: none !important;
            }
            
            .stats-grid::-webkit-scrollbar {
                display: none !important;
            }
            
            .stat-card {
                flex: 0 0 70% !important;
                scroll-snap-align: center !important;
                min-width: 200px !important;
                padding: 1rem !important;
            }
            
            .stat-icon {
                width: 40px !important;
                height: 40px !important;
                font-size: 1.2rem !important;
            }
            
            .stat-value {
                font-size: 1.5rem !important;
            }
            
            .stat-label {
                font-size: 0.8rem !important;
            }
            
            /* Map container */
            #map {
                height: 300px !important;
                border-radius: 8px !important;
            }
            
            /* Selected areas */
            .selected-areas-panel {
                padding: 1rem !important;
                background: rgba(0, 0, 0, 0.2) !important;
                border-radius: 12px !important;
                margin-top: 1rem !important;
            }
            
            .selected-areas-panel h3 {
                font-size: 1.1rem !important;
                margin-bottom: 1rem !important;
            }
            
            .selected-areas-list {
                display: flex !important;
                flex-wrap: wrap !important;
                gap: 0.5rem !important;
            }
            
            .area-tag {
                font-size: 0.8rem !important;
                padding: 0.5rem 0.75rem !important;
                background: rgba(139, 0, 0, 0.2) !important;
                border: 1px solid rgba(139, 0, 0, 0.4) !important;
                border-radius: 8px !important;
                color: white !important;
                display: inline-flex !important;
                align-items: center !important;
                gap: 0.5rem !important;
            }
            
            /* Review section */
            .review-section {
                padding: 1rem !important;
                margin-bottom: 1rem !important;
            }
            
            .review-item {
                padding: 0.75rem !important;
                font-size: 0.9rem !important;
            }
            
            /* Checkout */
            .pricing-card {
                padding: 1rem !important;
                margin-bottom: 1rem !important;
            }
            
            .price-amount {
                font-size: 1.8rem !important;
            }
            
            /* Performance charts */
            .chart-container {
                padding: 1rem !important;
                margin-bottom: 1rem !important;
            }
            
            canvas {
                max-height: 200px !important;
            }
            
            /* Buttons */
            .btn,
            button {
                width: 100% !important;
                padding: 0.875rem 1rem !important;
                font-size: 0.95rem !important;
                margin-bottom: 0.5rem !important;
            }
            
            .btn-group {
                display: flex !important;
                flex-direction: column !important;
                gap: 0.5rem !important;
            }
            
            /* Campaign cards */
            .campaign-card {
                padding: 1rem !important;
                margin-bottom: 1rem !important;
            }
            
            .campaign-header {
                flex-direction: column !important;
                align-items: flex-start !important;
                gap: 0.5rem !important;
            }
            
            .campaign-header h3 {
                font-size: 1.2rem !important;
            }
            
            .campaign-stats {
                grid-template-columns: repeat(2, 1fr) !important;
                gap: 0.5rem !important;
                padding: 0.75rem !important;
            }
            
            .campaign-actions {
                flex-direction: column !important;
                gap: 0.5rem !important;
            }
            
            /* Info modal */
            #tab-info-content-wrapper {
                width: 95% !important;
                padding: 1.5rem 1rem !important;
                max-height: 85vh !important;
            }
            
            /* Hide unnecessary elements on mobile */
            .tooltip,
            [onmouseover],
            .hover-effect {
                pointer-events: none !important;
            }
            
            /* Swipe indicators - only show on mobile */
            .tabs-wrapper {
                position: relative !important;
            }
            
            .swipe-indicator {
                display: flex !important;
            }
        }
        
        /* Swipe pulse animation */
        @keyframes swipePulse {
            0%, 100% {
                transform: translateX(0);
                opacity: 1;
            }
            50% {
                transform: translateX(5px);
                opacity: 0.6;
            }
        }
        
        /* Hide swipe indicators on desktop */
        @media (min-width: 769px) {
            .swipe-indicator {
                display: none !important;
            }
        }
    </style>
{% endblock %}

{% block content %}
    
    <!-- Main Container -->
    <div class="page-container">
        <!-- Page Title -->
        <div class="page-header">
        <h1><i class="fas fa-bullhorn"></i> Create Campaign</h1>
        <p>Set up and launch your advertising campaign</p>
        </div>
        
        <div class="container">
        
        <!-- Tabs Navigation with Swipe Indicators -->
        <div class="tabs-wrapper" style="position: relative;">
            <!-- Left Swipe Indicator -->
            <div class="swipe-indicator swipe-left" style="position: absolute; left: 0; top: 0; bottom: 0; width: 40px; background: linear-gradient(to right, rgba(139, 0, 0, 0.6), transparent); display: flex; align-items: center; justify-content: center; pointer-events: none; z-index: 10; opacity: 0; transition: opacity 0.3s ease;">
                <i class="fas fa-chevron-left" style="color: white; font-size: 1.2rem; text-shadow: 0 2px 4px rgba(0,0,0,0.5);"></i>
            </div>
            
            <!-- Right Swipe Indicator -->
            <div class="swipe-indicator swipe-right" style="position: absolute; right: 0; top: 0; bottom: 0; width: 40px; background: linear-gradient(to left, rgba(139, 0, 0, 0.6), transparent); display: flex; align-items: center; justify-content: center; pointer-events: none; z-index: 10; opacity: 1; transition: opacity 0.3s ease;">
                <i class="fas fa-chevron-right" style="color: white; font-size: 1.2rem; text-shadow: 0 2px 4px rgba(0,0,0,0.5); animation: swipePulse 2s ease-in-out infinite;"></i>
            </div>
            
            <div class="tabs-container">
                <button class="tab-btn active" onclick="switchCampaignTab('setup')">
                    <i class="fas fa-rocket"></i> Campaign Setup
                </button>
                <button class="tab-btn" onclick="switchCampaignTab('display')">
                    <i class="fas fa-tv"></i> Display Targeting
                </button>
                <button class="tab-btn" onclick="switchCampaignTab('location')">
                    <i class="fas fa-map-marked-alt"></i> Location Targeting
                </button>
                <button class="tab-btn" onclick="switchCampaignTab('review')">
                    <i class="fas fa-clipboard-check"></i> Review
                </button>
                <button class="tab-btn" onclick="switchCampaignTab('checkout')">
                    <i class="fas fa-shopping-cart"></i> Checkout
                </button>
                <button class="tab-btn" onclick="switchCampaignTab('performance')">
                    <i class="fas fa-chart-line"></i> Performance
                </button>
            </div>
        </div>
                
        <!-- Tab Info Modal -->
        <div id="tab-info-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); z-index: 10000; align-items: center; justify-content: center;">
            <div id="tab-info-content-wrapper" style="background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); border: 2px solid rgba(139, 0, 0, 0.5); border-radius: 20px; padding: 2rem; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto; position: relative; font-family: 'Merriweather', Georgia, serif;">
                <button onclick="forceCloseModal()" style="position: absolute; top: 1rem; right: 1rem; background: rgba(139, 0, 0, 0.2); border: 2px solid rgba(139, 0, 0, 0.5); color: white; font-size: 1.5rem; cursor: pointer; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; border-radius: 50%; transition: all 0.3s ease; z-index: 10001;">
                    <i class="fas fa-times"></i>
                </button>
                <div id="tab-info-content"></div>
            </div>
        </div>
                
        <!-- TAB 1: CAMPAIGN SETUP -->
        <div id="setup-tab" class="tab-content active">
        
        <!-- Campaign Creation Section -->
        <section class="section glass">
            <h2 class="section-title">
                Create New Campaign
                <i class="fas fa-info-circle" onmouseover="showTabInfo('setup')" onmouseout="closeTabInfo()" style="font-size: 1em; margin-left: 0.75rem; opacity: 0.7; cursor: help; transition: all 0.3s ease;"></i>
            </h2>
            <p class="section-subtitle text-quantum">Upload your video and set your advertising parameters</p>
            
            <div class="form-grid">
                <!-- Campaign Details -->
                <div class="form-section glass">
                    <h3 style="color: var(--quantum-primary); margin-bottom: 2rem; font-size: 1.5rem;">
                        <i class="fas fa-info-circle"></i> Campaign Details
                    </h3>
                    
                    <div class="form-group">
                        <label class="form-label">Campaign Name</label>
                        <input type="text" class="form-input" id="campaignName" placeholder="Enter campaign name">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Campaign Description</label>
                        <textarea class="form-textarea" id="campaignDescription" placeholder="Describe your campaign..."></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Target Audience</label>
                        <select class="form-select" id="targetAudience">
                            <option value="">Select target audience</option>
                            <option value="general">General Public</option>
                            <option value="youth">Youth (18-25)</option>
                            <option value="adults">Adults (26-40)</option>
                            <option value="seniors">Seniors (40+)</option>
                            <option value="business">Business Professionals</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Campaign Duration (Days)</label>
                        <input type="number" class="form-input" id="campaignDuration" placeholder="7" min="1" max="365">
                    </div>
                </div>
                
                <!-- Video Upload -->
                <div class="form-section glass">
                    <h3 style="color: var(--quantum-primary); margin-bottom: 2rem; font-size: 1.5rem;">
                        <i class="fas fa-video"></i> Video Upload
                    </h3>
                    
                    <div class="upload-area" onclick="document.getElementById('videoFile').click()">
                        <div class="upload-icon">
                            <i class="fas fa-cloud-upload-alt"></i>
                        </div>
                        <div class="upload-text">Click to upload your video</div>
                        <div class="upload-subtext">MP4, AVI, MOV up to 100MB</div>
                        <div class="video-note" style="margin-top: 1rem; padding: 1rem; background: rgba(139, 0, 0, 0.1); border-radius: 10px; border: 1px solid rgba(139, 0, 0, 0.3);">
                            <i class="fas fa-info-circle" style="color: var(--quantum-primary); margin-right: 0.5rem;"></i>
                            <strong>Note:</strong> Video length should be between 50-60 minutes for optimal outdoor advertising performance. Content should be suitable for public display.
                        </div>
                        <input type="file" id="videoFile" class="hidden" accept="video/*" onchange="handleVideoUpload(this)">
                    </div>
                    
                    <div id="videoPreview" style="display: none; margin-top: 2rem;">
                        <video id="previewVideo" controls style="width: 100%; border-radius: 15px;"></video>
                        <p style="text-align: center; margin-top: 1rem; color: var(--quantum-success);">
                            <i class="fas fa-check-circle"></i> Video uploaded successfully!
                        </p>
                    </div>
                </div>
            </div>
        </section>

                <!-- Tab Navigation Buttons -->
                <div class="tab-navigation" style="display: flex; justify-content: space-between; align-items: center; margin-top: 2rem; padding: 1.5rem; background: rgba(139, 0, 0, 0.1); border-radius: 15px; border: 2px solid rgba(139, 0, 0, 0.3);">
                    <button class="btn btn-secondary" onclick="switchCampaignTab('setup')" style="opacity: 0.5; cursor: not-allowed;" disabled>
                        <i class="fas fa-chevron-left"></i> Previous
                    </button>
                    <button class="btn btn-primary" onclick="saveSetupAndContinue()" style="padding: 1rem 2rem; font-size: 1.1rem; font-weight: 700;">
                        Save & Continue <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
                </div>
        <!-- END TAB 1: CAMPAIGN SETUP -->
        
        <!-- TAB 2: DISPLAY TARGETING -->
        <div id="display-tab" class="tab-content">

        <!-- Outdoor Micro-Advertisers Payment Section -->
        <section class="section glass payment-section">
            <div class="section-content">
                <h2 class="section-title">
                    Outdoor Micro-Advertisers Setup
                    <i class="fas fa-info-circle" onmouseover="showTabInfo('display')" onmouseout="closeTabInfo()" style="font-size: 1em; margin-left: 0.75rem; opacity: 0.7; cursor: help; transition: all 0.3s ease;"></i>
                </h2>
                <p class="section-subtitle">Set payout per hour for outdoor advertising with mobile WeAD display owners</p>

            <div class="token-input-group">
                <input type="number" class="token-input" id="tokenPerHour" placeholder="5.0" step="0.1" min="0.1" onchange="calculateOutdoorPayment()">
                <span class="token-label">WEAD per hour</span>
            </div>

            <div class="payment-breakdown">
                <div class="breakdown-item">
                    <div class="breakdown-label">Number of Outdoor Advertisers</div>
                    <input type="number" class="form-input small-input" id="advertiserCount" placeholder="50" min="1" max="1000" onchange="calculateOutdoorPayment()">
                </div>
                <div class="breakdown-item">
                    <div class="breakdown-label">Total Payout per Hour</div>
                    <div class="breakdown-value" id="totalPayoutHour">250.00 WEAD</div>
                </div>
                <div class="breakdown-item">
                    <div class="breakdown-label">Platform Fee (5%)</div>
                    <div class="breakdown-value" id="platformFee">12.50 WEAD</div>
                </div>
                <div class="breakdown-item">
                    <div class="breakdown-label">Total Cost per Hour</div>
                    <div class="breakdown-value" id="totalCostHour">262.50 WEAD</div>
                </div>
            </div>
            
            <div class="duration-input-container">
                <label class="form-label">Campaign Duration (Hours)</label>
                <input type="number" id="campaignHours" placeholder="8" min="1" max="24" onchange="calculateOutdoorPayment()">
            </div>
            </div>
        </section>

        <!-- Display Type Targeting Section -->
        <section class="section glass">
            <div class="section-content">
                <h2 class="section-title">Display Type Targeting</h2>
                <p class="section-subtitle">Choose which types of outdoor displays to target</p>

            <div class="form-grid">
                <div class="form-section glass">
                    <h3 style="color: var(--quantum-primary); margin-bottom: 2rem; font-size: 1.5rem;">
                        <i class="fas fa-mobile-alt"></i> Mobile Display Types
                    </h3>

                    <div class="form-group">
                        <label class="form-label">Available Display Types</label>
                        <div class="display-types-grid">
                            <!-- Vehicle Displays -->
                            <div class="display-category">
                                <h4>
                                    <i class="fas fa-car"></i> Vehicle Displays
                                </h4>
                                <div class="display-options">
                                    <label class="display-option">
                                        <input type="checkbox" id="carDisplays" value="car" onchange="updateDisplayTypes()">
                                        <span class="display-icon"><i class="fas fa-car"></i></span>
                                        <span class="display-name">Car Displays</span>
                                        <button type="button" class="size-toggle" onclick="toggleSizes('car')">üìè</button>
                                    </label>
                                    <div id="carSizes" class="size-options" style="display: none;">
                                        <select class="size-select" onchange="updateSelectedSize('car', this.value)">
                                            <option value="">Select Size</option>
                                            <option value="25x15">25cm √ó 15cm (Dashboard)</option>
                                            <option value="40x25">40cm √ó 25cm (Window)</option>
                                            <option value="60x35">60cm √ó 35cm (Rear)</option>
                                            <option value="80x45">80cm √ó 45cm (Side)</option>
                                            <option value="100x60">100cm √ó 60cm (Hood)</option>
                                            <option value="120x80">120cm √ó 80cm (Roof)</option>
                                        </select>
                                    </div>

                                    <label class="display-option">
                                        <input type="checkbox" id="motorbikeDisplays" value="motorbike" onchange="updateDisplayTypes()">
                                        <span class="display-icon"><i class="fas fa-motorcycle"></i></span>
                                        <span class="display-name">Motorbike Displays</span>
                                        <button type="button" class="size-toggle" onclick="toggleSizes('motorbike')">üìè</button>
                                    </label>
                                    <div id="motorbikeSizes" class="size-options" style="display: none;">
                                        <select class="size-select" onchange="updateSelectedSize('motorbike', this.value)">
                                            <option value="">Select Size</option>
                                            <option value="20x10">20cm √ó 10cm (Handlebar)</option>
                                            <option value="30x15">30cm √ó 15cm (Side)</option>
                                            <option value="40x20">40cm √ó 20cm (Rear)</option>
                                            <option value="50x25">50cm √ó 25cm (Front)</option>
                                            <option value="60x30">60cm √ó 30cm (Backrest)</option>
                                            <option value="70x35">70cm √ó 35cm (Luggage)</option>
                                        </select>
                                    </div>

                                    <label class="display-option">
                                        <input type="checkbox" id="truckDisplays" value="truck" onchange="updateDisplayTypes()">
                                        <span class="display-icon"><i class="fas fa-truck"></i></span>
                                        <span class="display-name">Truck Displays</span>
                                        <button type="button" class="size-toggle" onclick="toggleSizes('truck')">üìè</button>
                                    </label>
                                    <div id="truckSizes" class="size-options" style="display: none;">
                                        <select class="size-select" onchange="updateSelectedSize('truck', this.value)">
                                            <option value="">Select Size</option>
                                            <option value="80x40">80cm √ó 40cm (Door)</option>
                                            <option value="120x60">120cm √ó 60cm (Side)</option>
                                            <option value="150x80">150cm √ó 80cm (Rear)</option>
                                            <option value="200x100">200cm √ó 100cm (Trailer)</option>
                                            <option value="250x120">250cm √ó 120cm (Container)</option>
                                            <option value="300x150">300cm √ó 150cm (Cargo)</option>
                                        </select>
                                    </div>

                                    <label class="display-option">
                                        <input type="checkbox" id="tuktukDisplays" value="tuktuk" onchange="updateDisplayTypes()">
                                        <span class="display-icon"><i class="fas fa-taxi"></i></span>
                                        <span class="display-name">TukTuk Displays</span>
                                        <button type="button" class="size-toggle" onclick="toggleSizes('tuktuk')">üìè</button>
                                    </label>
                                    <div id="tuktukSizes" class="size-options" style="display: none;">
                                        <select class="size-select" onchange="updateSelectedSize('tuktuk', this.value)">
                                            <option value="">Select Size</option>
                                            <option value="25x15">25cm √ó 15cm (Handle)</option>
                                            <option value="40x25">40cm √ó 25cm (Side)</option>
                                            <option value="60x35">60cm √ó 35cm (Rear)</option>
                                            <option value="80x45">80cm √ó 45cm (Canopy)</option>
                                            <option value="100x60">100cm √ó 60cm (Roof)</option>
                                            <option value="120x80">120cm √ó 80cm (Body)</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <!-- Wearable Displays -->
                            <div class="display-category">
                                <h4>
                                    <i class="fas fa-tshirt"></i> Wearable Displays
                                </h4>
                                <div class="display-options">
                                    <label class="display-option">
                                        <input type="checkbox" id="clothesDisplays" value="clothes" onchange="updateDisplayTypes()">
                                        <span class="display-icon"><i class="fas fa-tshirt"></i></span>
                                        <span class="display-name">Clothes Displays</span>
                                        <button type="button" class="size-toggle" onclick="toggleSizes('clothes')">üìè</button>
                                    </label>
                                    <div id="clothesSizes" class="size-options" style="display: none;">
                                        <select class="size-select" onchange="updateSelectedSize('clothes', this.value)">
                                            <option value="">Select Size</option>
                                            <option value="30x20">30cm √ó 20cm (Chest Small)</option>
                                            <option value="40x30">40cm √ó 30cm (Chest Medium)</option>
                                            <option value="50x40">50cm √ó 40cm (Chest Large)</option>
                                            <option value="30x50">30cm √ó 50cm (Back Small)</option>
                                            <option value="40x60">40cm √ó 60cm (Back Medium)</option>
                                            <option value="50x80">50cm √ó 80cm (Back Large)</option>
                                        </select>
                                    </div>

                                    <label class="display-option">
                                        <input type="checkbox" id="backpackDisplays" value="backpack" onchange="updateDisplayTypes()">
                                        <span class="display-icon"><i class="fas fa-hiking"></i></span>
                                        <span class="display-name">Backpack Displays</span>
                                        <button type="button" class="size-toggle" onclick="toggleSizes('backpack')">üìè</button>
                                    </label>
                                    <div id="backpackSizes" class="size-options" style="display: none;">
                                        <select class="size-select" onchange="updateSelectedSize('backpack', this.value)">
                                            <option value="">Select Size</option>
                                            <option value="25x15">25cm √ó 15cm (Front Pocket)</option>
                                            <option value="35x25">35cm √ó 25cm (Main Panel)</option>
                                            <option value="45x30">45cm √ó 30cm (Side Panel)</option>
                                            <option value="20x30">20cm √ó 30cm (Shoulder Strap)</option>
                                            <option value="30x40">30cm √ó 40cm (Back Panel)</option>
                                            <option value="40x50">40cm √ó 50cm (Full Back)</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <!-- Aerial & Stationary Displays -->
                            <div class="display-category">
                                <h4>
                                    <i class="fas fa-plane"></i> Aerial & Stationary
                                </h4>
                                <div class="display-options">
                                    <label class="display-option">
                                        <input type="checkbox" id="droneDisplays" value="drone" onchange="updateDisplayTypes()">
                                        <span class="display-icon"><i class="fas fa-helicopter"></i></span>
                                        <span class="display-name">Drone Displays</span>
                                        <button type="button" class="size-toggle" onclick="toggleSizes('drone')">üìè</button>
                                    </label>
                                    <div id="droneSizes" class="size-options" style="display: none;">
                                        <select class="size-select" onchange="updateSelectedSize('drone', this.value)">
                                            <option value="">Select Size</option>
                                            <option value="15x10">15cm √ó 10cm (Small Drone)</option>
                                            <option value="25x15">25cm √ó 15cm (Medium Drone)</option>
                                            <option value="35x20">35cm √ó 20cm (Large Drone)</option>
                                            <option value="45x25">45cm √ó 25cm (Cargo Drone)</option>
                                            <option value="20x30">20cm √ó 30cm (Banner Drone)</option>
                                            <option value="30x40">30cm √ó 40cm (Delivery Drone)</option>
                                        </select>
                                    </div>

                                    <label class="display-option">
                                        <input type="checkbox" id="mobileDisplays" value="mobile" onchange="updateDisplayTypes()">
                                        <span class="display-icon"><i class="fas fa-mobile-alt"></i></span>
                                        <span class="display-name">Mobile Displays</span>
                                        <button type="button" class="size-toggle" onclick="toggleSizes('mobile')">üìè</button>
                                    </label>
                                    <div id="mobileSizes" class="size-options" style="display: none;">
                                        <select class="size-select" onchange="updateSelectedSize('mobile', this.value)">
                                            <option value="">Select Size</option>
                                            <option value="15x10">15cm √ó 10cm (Small Screen)</option>
                                            <option value="20x12">20cm √ó 12cm (Phone Screen)</option>
                                            <option value="25x15">25cm √ó 15cm (Tablet Screen)</option>
                                            <option value="30x18">30cm √ó 18cm (Large Tablet)</option>
                                            <option value="35x20">35cm √ó 20cm (Small Monitor)</option>
                                            <option value="40x25">40cm √ó 25cm (Medium Monitor)</option>
                                        </select>
                                    </div>

                                    <label class="display-option">
                                        <input type="checkbox" id="outdoorDisplays" value="outdoor" onchange="updateDisplayTypes()">
                                        <span class="display-icon"><i class="fas fa-tree"></i></span>
                                        <span class="display-name">Outdoor Displays</span>
                                        <button type="button" class="size-toggle" onclick="toggleSizes('outdoor')">üìè</button>
                                    </label>
                                    <div id="outdoorSizes" class="size-options" style="display: none;">
                                        <select class="size-select" onchange="updateSelectedSize('outdoor', this.value)">
                                            <option value="">Select Size</option>
                                            <option value="50x30">50cm √ó 30cm (Small Sign)</option>
                                            <option value="80x50">80cm √ó 50cm (Medium Sign)</option>
                                            <option value="120x80">120cm √ó 80cm (Large Sign)</option>
                                            <option value="150x100">150cm √ó 100cm (Billboard)</option>
                                            <option value="200x120">200cm √ó 120cm (Poster)</option>
                                            <option value="250x150">250cm √ó 150cm (Banner)</option>
                                        </select>
                                    </div>

                                    <label class="display-option">
                                        <input type="checkbox" id="buildingDisplays" value="building" onchange="updateDisplayTypes()">
                                        <span class="display-icon"><i class="fas fa-building"></i></span>
                                        <span class="display-name">Building Displays</span>
                                        <button type="button" class="size-toggle" onclick="toggleSizes('building')">üìè</button>
                                    </label>
                                    <div id="buildingSizes" class="size-options" style="display: none;">
                                        <select class="size-select" onchange="updateSelectedSize('building', this.value)">
                                            <option value="">Select Size</option>
                                            <option value="100x60">100cm √ó 60cm (Window)</option>
                                            <option value="150x90">150cm √ó 90cm (Door)</option>
                                            <option value="200x120">200cm √ó 120cm (Wall)</option>
                                            <option value="300x150">300cm √ó 150cm (Facade)</option>
                                            <option value="400x200">400cm √ó 200cm (Roof)</option>
                                            <option value="500x250">500cm √ó 250cm (Building)</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            </div>
        </section>

                <!-- Tab Navigation Buttons -->
                <div class="tab-navigation" style="display: flex; justify-content: space-between; align-items: center; margin-top: 2rem; padding: 1.5rem; background: rgba(139, 0, 0, 0.1); border-radius: 15px; border: 2px solid rgba(139, 0, 0, 0.3);">
                    <button class="btn btn-secondary" onclick="switchCampaignTab('setup')" style="padding: 1rem 2rem;">
                        <i class="fas fa-chevron-left"></i> Previous
                    </button>
                    <button class="btn btn-primary" onclick="saveDisplayAndContinue()" style="padding: 1rem 2rem; font-size: 1.1rem; font-weight: 700;">
                        Save & Continue <i class="fas fa-chevron-right"></i>
                    </button>
                </div>

        </div>
        <!-- END TAB 2: DISPLAY TARGETING -->
        
        <!-- TAB 3: LOCATION TARGETING -->
        <div id="location-tab" class="tab-content">
        
        <!-- Interactive Location Targeting Section -->
        <section class="section glass">
            <h2 class="section-title">
                Interactive Location Targeting
                <i class="fas fa-info-circle" onmouseover="showTabInfo('location')" onmouseout="closeTabInfo()" style="font-size: 1em; margin-left: 0.75rem; opacity: 0.7; cursor: help; transition: all 0.3s ease;"></i>
            </h2>
            <p class="section-subtitle">Click on the map to select areas with highest WeAD micro-advertiser concentration</p>

            <!-- Map Controls -->
            <div class="map-controls">
                <div class="control-group">
                    <label class="form-label">Country</label>
                    <select class="form-select" id="countrySelect" onchange="changeCountry()">
                        <option value="us">United States</option>
                        <option value="uk">United Kingdom</option>
                        <option value="ca">Canada</option>
                        <option value="au">Australia</option>
                        <option value="sg">Singapore</option>
                        <option value="jp">Japan</option>
                        <option value="kr">South Korea</option>
                        <option value="de">Germany</option>
                        <option value="fr">France</option>
                        <option value="vn">Vietnam</option>
                        <option value="th">Thailand</option>
                        <option value="tw">Taiwan</option>
                        <option value="hk">Hong Kong</option>
                        <option value="id">Indonesia</option>
                        <option value="ph">Philippines</option>
                    </select>
            </div>
            
                <div class="control-group">
                    <label class="form-label">City/Region</label>
                    <select class="form-select" id="citySelect" onchange="changeCity()">
                        <option value="">Select city...</option>
                    </select>
                </div>

                <div class="control-group">
                    <button class="btn btn-primary" onclick="resetMap()">
                        <i class="fas fa-undo"></i> Reset View
                    </button>
                </div>
            </div>

            <!-- Interactive Map Container -->
            <div class="map-container">
                <div id="locationMap"></div>
                <div class="map-legend">
                    <div class="legend-item">
                        <div class="legend-color high-density"></div>
                        <span>High Advertiser Density (500+)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color medium-density"></div>
                        <span>Medium Density (200-499)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color low-density"></div>
                        <span>Low Density (50-199)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color selected-area"></div>
                        <span>Selected Area</span>
                    </div>
                </div>
            </div>

            <!-- Location Statistics -->
            <div class="location-stats-panel">
                <div class="stats-grid">
                    <div class="stat-card">
                    <div class="stat-icon">
                            <i class="fas fa-users"></i>
                    </div>
                        <div class="stat-content">
                            <div class="stat-value" id="totalAdvertisers">0</div>
                            <div class="stat-label">Active Advertisers</div>
                        </div>
                </div>
                
                    <div class="stat-card">
                    <div class="stat-icon">
                            <i class="fas fa-eye"></i>
                    </div>
                        <div class="stat-content">
                            <div class="stat-value" id="estimatedImpressions">0</div>
                            <div class="stat-label">Daily Impressions</div>
                        </div>
                </div>
                
                    <div class="stat-card">
                    <div class="stat-icon">
                            <i class="fas fa-map-marker-alt"></i>
                    </div>
                        <div class="stat-content">
                            <div class="stat-value" id="selectedAreas">0</div>
                            <div class="stat-label">Selected Areas</div>
                        </div>
                </div>
                
                    <div class="stat-card">
                    <div class="stat-icon">
                            <i class="fas fa-chart-line"></i>
                    </div>
                        <div class="stat-content">
                            <div class="stat-value" id="reachPotential">0%</div>
                            <div class="stat-label">Reach Potential</div>
                </div>
                    </div>
                </div>
            </div>

            <!-- Selected Areas Panel -->
            <div class="selected-areas-panel">
                <h3 style="color: var(--quantum-primary); margin-bottom: 1rem;">
                    <i class="fas fa-check-circle"></i> Selected Target Areas
                </h3>
                <div id="selectedAreasList" class="selected-areas-list">
                    <p style="color: var(--text-secondary); font-style: italic;">Click on areas on the map to select them</p>
            </div>
            </div>
        </section>

                <!-- Tab Navigation Buttons -->
                <div class="tab-navigation" style="display: flex; justify-content: space-between; align-items: center; margin-top: 2rem; padding: 1.5rem; background: rgba(139, 0, 0, 0.1); border-radius: 15px; border: 2px solid rgba(139, 0, 0, 0.3);">
                    <button class="btn btn-secondary" onclick="switchCampaignTab('display')" style="padding: 1rem 2rem;">
                        <i class="fas fa-chevron-left"></i> Previous
                    </button>
                    <button class="btn btn-primary" onclick="saveLocationAndContinue()" style="padding: 1rem 2rem; font-size: 1.1rem; font-weight: 700;">
                        Save & Continue <i class="fas fa-chevron-right"></i>
                    </button>
                </div>

        </div>
        <!-- END TAB 3: LOCATION TARGETING -->
        
        <!-- TAB 4: PERFORMANCE -->
        <div id="performance-tab" class="tab-content">

        <!-- Campaign Analytics Preview -->
        <section class="section glass">
            <div class="section-content">
                <h2 class="section-title">
                    Expected Performance Analytics
                    <i class="fas fa-info-circle" onmouseover="showTabInfo('performance')" onmouseout="closeTabInfo()" style="font-size: 1em; margin-left: 0.75rem; opacity: 0.7; cursor: help; transition: all 0.3s ease;"></i>
                </h2>
                <p class="section-subtitle">Projected campaign performance metrics over 7 days</p>
            
            <div class="chart-container">
                <canvas id="performanceChart"></canvas>
            </div>
            </div>
        </section>

        <!-- Industry Impression Benchmarks -->
        <section class="section glass">
            <h2 class="section-title">Industry Impression Benchmarks</h2>
            <p class="section-subtitle">Average impression rates by display type in mid-size cities</p>
            
            <div style="display: grid; gap: 1rem; margin-top: 2rem;">
                <!-- Car Displays -->
                <div style="background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(139, 0, 0, 0.3); border-radius: 12px; padding: 1.5rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <div style="display: flex; align-items: center; gap: 1rem;">
                            <div style="width: 50px; height: 50px; background: linear-gradient(135deg, #8B0000, #5c0000); border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem;">
                                üöó
                </div>
                            <div>
                                <h3 style="color: var(--text-primary); font-size: 1.1rem; margin-bottom: 0.25rem;">Car Rooftop Displays</h3>
                                <p style="color: var(--text-secondary); font-size: 0.85rem;">Mobile advertising on vehicles</p>
                </div>
                </div>
                        <div style="text-align: right;">
                            <div style="color: #8B0000; font-weight: 700; font-size: 1.5rem;">5K-10K</div>
                            <div style="color: var(--text-secondary); font-size: 0.8rem;">impressions/hour</div>
                        </div>
                    </div>
                    <div style="width: 100%; height: 6px; background: rgba(255, 255, 255, 0.1); border-radius: 10px; overflow: hidden;">
                        <div style="width: 75%; height: 100%; background: linear-gradient(90deg, #8B0000, #5c0000);"></div>
                    </div>
                </div>

                <!-- Building Displays -->
                <div style="background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(139, 0, 0, 0.3); border-radius: 12px; padding: 1.5rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <div style="display: flex; align-items: center; gap: 1rem;">
                            <div style="width: 50px; height: 50px; background: linear-gradient(135deg, #8B0000, #5c0000); border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem;">
                                üè¢
                            </div>
                            <div>
                                <h3 style="color: var(--text-primary); font-size: 1.1rem; margin-bottom: 0.25rem;">Building & Store Displays</h3>
                                <p style="color: var(--text-secondary); font-size: 0.85rem;">Static displays in high-traffic areas</p>
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <div style="color: #8B0000; font-weight: 700; font-size: 1.5rem;">10K-20K</div>
                            <div style="color: var(--text-secondary); font-size: 0.8rem;">impressions/hour</div>
                        </div>
                    </div>
                    <div style="width: 100%; height: 6px; background: rgba(255, 255, 255, 0.1); border-radius: 10px; overflow: hidden;">
                        <div style="width: 95%; height: 100%; background: linear-gradient(90deg, #8B0000, #5c0000);"></div>
                    </div>
                </div>

                <!-- Wearable Displays -->
                <div style="background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(139, 0, 0, 0.3); border-radius: 12px; padding: 1.5rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <div style="display: flex; align-items: center; gap: 1rem;">
                            <div style="width: 50px; height: 50px; background: linear-gradient(135deg, #8B0000, #5c0000); border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem;">
                                üéí
                            </div>
                            <div>
                                <h3 style="color: var(--text-primary); font-size: 1.1rem; margin-bottom: 0.25rem;">Wearable Displays</h3>
                                <p style="color: var(--text-secondary); font-size: 0.85rem;">Backpacks, clothing, accessories</p>
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <div style="color: #8B0000; font-weight: 700; font-size: 1.5rem;">2K-5K</div>
                            <div style="color: var(--text-secondary); font-size: 0.8rem;">impressions/hour</div>
                        </div>
                    </div>
                    <div style="width: 100%; height: 6px; background: rgba(255, 255, 255, 0.1); border-radius: 10px; overflow: hidden;">
                        <div style="width: 45%; height: 100%; background: linear-gradient(90deg, #8B0000, #5c0000);"></div>
                    </div>
                </div>

                <!-- Food Cart Displays -->
                <div style="background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(139, 0, 0, 0.3); border-radius: 12px; padding: 1.5rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <div style="display: flex; align-items: center; gap: 1rem;">
                            <div style="width: 50px; height: 50px; background: linear-gradient(135deg, #8B0000, #5c0000); border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem;">
                                üçï
                            </div>
                            <div>
                                <h3 style="color: var(--text-primary); font-size: 1.1rem; margin-bottom: 0.25rem;">Food Cart & Mobile Vendor Displays</h3>
                                <p style="color: var(--text-secondary); font-size: 0.85rem;">Street vendors and mobile businesses</p>
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <div style="color: #8B0000; font-weight: 700; font-size: 1.5rem;">3K-8K</div>
                            <div style="color: var(--text-secondary); font-size: 0.8rem;">impressions/hour</div>
                        </div>
                    </div>
                    <div style="width: 100%; height: 6px; background: rgba(255, 255, 255, 0.1); border-radius: 10px; overflow: hidden;">
                        <div style="width: 60%; height: 100%; background: linear-gradient(90deg, #8B0000, #5c0000);"></div>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- Impression Rate by Time of Day -->
        <section class="section glass">
            <h2 class="section-title">Impression Rate by Time of Day</h2>
            <p class="section-subtitle">Optimize your campaign timing for maximum reach</p>
            
            <div class="chart-container" style="margin-top: 2rem;">
                <canvas id="impressionTimeChart"></canvas>
                </div>
        </section>

        <!-- Cost Per Impression Statistics -->
        <section class="section glass">
            <h2 class="section-title">Cost Per Impression Statistics</h2>
            <p class="section-subtitle">Average costs across different display types and locations</p>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1.5rem; margin-top: 2rem;">
                <div style="background: rgba(139, 0, 0, 0.05); border: 2px solid rgba(139, 0, 0, 0.3); border-radius: 12px; padding: 1.5rem; text-align: center;">
                    <div style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 0.5rem; text-transform: uppercase; letter-spacing: 1px;">Downtown Areas</div>
                    <div style="color: #8B0000; font-weight: 700; font-size: 2rem; margin-bottom: 0.25rem;">$0.008</div>
                    <div style="color: var(--text-secondary); font-size: 0.85rem;">per impression</div>
            </div>
                <div style="background: rgba(139, 0, 0, 0.05); border: 2px solid rgba(139, 0, 0, 0.3); border-radius: 12px; padding: 1.5rem; text-align: center;">
                    <div style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 0.5rem; text-transform: uppercase; letter-spacing: 1px;">Suburban Areas</div>
                    <div style="color: #8B0000; font-weight: 700; font-size: 2rem; margin-bottom: 0.25rem;">$0.005</div>
                    <div style="color: var(--text-secondary); font-size: 0.85rem;">per impression</div>
                </div>
                <div style="background: rgba(139, 0, 0, 0.05); border: 2px solid rgba(139, 0, 0, 0.3); border-radius: 12px; padding: 1.5rem; text-align: center;">
                    <div style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 0.5rem; text-transform: uppercase; letter-spacing: 1px;">Shopping Districts</div>
                    <div style="color: #8B0000; font-weight: 700; font-size: 2rem; margin-bottom: 0.25rem;">$0.010</div>
                    <div style="color: var(--text-secondary); font-size: 0.85rem;">per impression</div>
                </div>
                <div style="background: rgba(139, 0, 0, 0.05); border: 2px solid rgba(139, 0, 0, 0.3); border-radius: 12px; padding: 1.5rem; text-align: center;">
                    <div style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 0.5rem; text-transform: uppercase; letter-spacing: 1px;">Event Venues</div>
                    <div style="color: #8B0000; font-weight: 700; font-size: 2rem; margin-bottom: 0.25rem;">$0.012</div>
                    <div style="color: var(--text-secondary); font-size: 0.85rem;">per impression</div>
                </div>
            </div>
        </section>
        
        </div>
        <!-- END TAB 4: PERFORMANCE -->
        
        <!-- TAB 5: REVIEW -->
        <div id="review-tab" class="tab-content">
        
        <!-- Review Campaign Section -->
        <section class="section glass">
            <h2 class="section-title">
                Review Your Campaign
                <i class="fas fa-info-circle" onmouseover="showTabInfo('review')" onmouseout="closeTabInfo()" style="font-size: 1em; margin-left: 0.75rem; opacity: 0.7; cursor: help; transition: all 0.3s ease;"></i>
            </h2>
            <p class="section-subtitle">Review all campaign details before proceeding to checkout</p>
            
            <!-- Campaign Progress -->
            <div class="progress-container" style="margin: 2rem 0;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                    <span style="color: var(--text-primary); font-weight: 600;">Campaign Completion:</span>
                    <span id="completionPercentage" style="color: #8B0000; font-weight: 700; font-size: 1.2rem;">0%</span>
                </div>
                <div class="progress-bar" style="width: 100%; height: 12px; background: rgba(255, 255, 255, 0.1); border-radius: 10px; overflow: hidden;">
                    <div id="progressFill" style="width: 0%; height: 100%; background: linear-gradient(90deg, #8B0000, #5c0000); transition: width 0.5s ease;"></div>
                </div>
            </div>
            
                <!-- Campaign Summary -->
            <div id="campaignSummary" style="display: grid; gap: 1.5rem; margin: 2rem 0;">
                <!-- Video & Basic Info -->
                <div style="background: rgba(0, 0, 0, 0.3); border: 2px solid rgba(139, 0, 0, 0.3); border-radius: 12px; padding: 1.5rem;">
                    <h3 style="color: #8B0000; margin-bottom: 1rem;"><i class="fas fa-video"></i> Campaign Details</h3>
                    <div style="display: grid; gap: 0.75rem; font-family: 'Merriweather', Georgia, serif;">
                        <div style="display: flex; justify-content: space-between;">
                            <span style="color: var(--text-secondary);">Campaign Name:</span>
                            <span id="reviewCampaignName" style="color: var(--text-primary); font-weight: 600;">Not set</span>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span style="color: var(--text-secondary);">Description:</span>
                            <span id="reviewDescription" style="color: var(--text-primary); max-width: 60%; text-align: right;">Not set</span>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span style="color: var(--text-secondary);">Duration:</span>
                            <span id="reviewDuration" style="color: var(--text-primary); font-weight: 600;">Not set</span>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span style="color: var(--text-secondary);">Target Audience:</span>
                            <span id="reviewAudience" style="color: var(--text-primary); font-weight: 600;">Not set</span>
                        </div>
                    </div>
                </div>
                
                <!-- Display Targeting -->
                <div style="background: rgba(0, 0, 0, 0.3); border: 2px solid rgba(139, 0, 0, 0.3); border-radius: 12px; padding: 1.5rem;">
                    <h3 style="color: #8B0000; margin-bottom: 1rem;"><i class="fas fa-tv"></i> Display Targeting</h3>
                    <div style="display: grid; gap: 0.75rem; font-family: 'Merriweather', Georgia, serif;">
                        <div style="display: flex; justify-content: space-between;">
                            <span style="color: var(--text-secondary);">Token per Hour:</span>
                            <span id="reviewTokenPerHour" style="color: var(--text-primary); font-weight: 600;">Not set</span>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span style="color: var(--text-secondary);">Number of Advertisers:</span>
                            <span id="reviewAdvertisers" style="color: var(--text-primary); font-weight: 600;">Not set</span>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span style="color: var(--text-secondary);">Campaign Hours:</span>
                            <span id="reviewHours" style="color: var(--text-primary); font-weight: 600;">Not set</span>
                        </div>
                        <div>
                            <span style="color: var(--text-secondary); margin-bottom: 0.5rem; display: block;">Display Types:</span>
                            <div id="reviewDisplayTypes" style="display: flex; flex-wrap: wrap; gap: 0.5rem; margin-top: 0.5rem;">
                                <p style="color: var(--text-secondary);">Not selected</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Location Targeting -->
                <div style="background: rgba(0, 0, 0, 0.3); border: 2px solid rgba(139, 0, 0, 0.3); border-radius: 12px; padding: 1.5rem;">
                    <h3 style="color: #8B0000; margin-bottom: 1rem;"><i class="fas fa-map-marker-alt"></i> Location Targeting</h3>
                    <div style="display: grid; gap: 0.75rem; font-family: 'Merriweather', Georgia, serif;">
                        <div>
                            <span style="color: var(--text-secondary); margin-bottom: 0.5rem; display: block;">Target Locations:</span>
                            <div id="reviewLocations" style="display: flex; flex-wrap: wrap; gap: 0.5rem; margin-top: 0.5rem;">
                                <p style="color: var(--text-secondary);">Not selected</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Cost & Projections -->
                <div style="background: rgba(0, 0, 0, 0.3); border: 2px solid rgba(139, 0, 0, 0.3); border-radius: 12px; padding: 1.5rem;">
                    <h3 style="color: #8B0000; margin-bottom: 1rem;"><i class="fas fa-dollar-sign"></i> Cost Summary</h3>
                    <div style="display: grid; gap: 0.75rem; font-family: 'Merriweather', Georgia, serif;">
                        <div style="display: flex; justify-content: space-between;">
                            <span style="color: var(--text-secondary);">Cost per Hour:</span>
                            <span id="reviewCostPerHour" style="color: var(--text-primary); font-weight: 600;">0 WEAD</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding-top: 1rem; border-top: 2px solid rgba(139, 0, 0, 0.3);">
                            <span style="color: var(--text-secondary); font-size: 1.1rem;">Total Cost:</span>
                            <span id="reviewTotalCost" style="color: #8B0000; font-weight: 700; font-size: 1.3rem;">0 WEAD</span>
                        </div>
                    </div>
                </div>
                
                <!-- Projected Results -->
                <div style="background: rgba(0, 0, 0, 0.3); border: 2px solid rgba(139, 0, 0, 0.3); border-radius: 12px; padding: 1.5rem;">
                    <h3 style="color: #8B0000; margin-bottom: 1rem;"><i class="fas fa-chart-line"></i> Projected Results</h3>
                    <div style="display: grid; gap: 0.75rem; font-family: 'Merriweather', Georgia, serif;">
                        <div style="display: flex; justify-content: space-between;">
                            <span style="color: var(--text-secondary);">Estimated Reach:</span>
                            <span id="reviewEstimatedReach" style="color: #10b981; font-weight: 700;">0</span>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span style="color: var(--text-secondary);">Estimated Impressions:</span>
                            <span id="reviewEstimatedImpressions" style="color: #10b981; font-weight: 700;">0</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Action Buttons -->
            <div style="display: flex; justify-content: center; gap: 1.5rem; margin: 2rem 0;">
                <button class="btn btn-secondary" onclick="saveDraft()">
                    <i class="fas fa-save"></i> Save as Draft
                </button>
                <button class="btn btn-primary" onclick="switchCampaignTab('checkout')" style="background: linear-gradient(135deg, #8B0000, #5c0000) !important;">
                    <i class="fas fa-arrow-right"></i> Proceed to Checkout
                </button>
            </div>
        </section>

                <!-- Tab Navigation Buttons -->
                <div class="tab-navigation" style="display: flex; justify-content: space-between; align-items: center; margin-top: 2rem; padding: 1.5rem; background: rgba(139, 0, 0, 0.1); border-radius: 15px; border: 2px solid rgba(139, 0, 0, 0.3);">
                    <button class="btn btn-secondary" onclick="switchCampaignTab('location')" style="padding: 1rem 2rem;">
                        <i class="fas fa-chevron-left"></i> Previous
                    </button>
                    <button class="btn btn-primary" onclick="proceedToCheckout()" style="padding: 1rem 2rem; font-size: 1.1rem; font-weight: 700;">
                        Proceed to Checkout <i class="fas fa-shopping-cart"></i>
                    </button>
                </div>
        
        </div>
        <!-- END TAB 5: REVIEW -->
        
        <!-- TAB 6: CHECKOUT -->
        <div id="checkout-tab" class="tab-content">
        
        <!-- Checkout Section -->
        <section class="section glass">
            <h2 class="section-title">
                <i class="fas fa-shopping-cart"></i> Checkout
                <i class="fas fa-info-circle" onmouseover="showTabInfo('checkout')" onmouseout="closeTabInfo()" style="font-size: 1em; margin-left: 0.75rem; opacity: 0.7; cursor: help; transition: all 0.3s ease;"></i>
            </h2>
            <p class="section-subtitle">Complete your payment to launch the campaign</p>
            
            <!-- Order Summary -->
            <div style="max-width: 800px; margin: 2rem auto;">
                <div style="background: rgba(0, 0, 0, 0.4); border: 2px solid rgba(139, 0, 0, 0.4); border-radius: 15px; padding: 2rem;">
                    <h3 style="color: #8B0000; margin-bottom: 1.5rem; font-size: 1.5rem;">
                        <i class="fas fa-file-invoice-dollar"></i> Order Summary
                    </h3>
                    
                    <!-- Campaign Info -->
                    <div style="border-bottom: 1px solid rgba(255, 255, 255, 0.1); padding-bottom: 1.5rem; margin-bottom: 1.5rem;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 1rem;">
                            <span style="color: var(--text-secondary); font-family: 'Merriweather', Georgia, serif;">Campaign Name:</span>
                            <span id="checkoutName" style="color: var(--text-primary); font-weight: 600;">-</span>
                    </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 1rem;">
                            <span style="color: var(--text-secondary); font-family: 'Merriweather', Georgia, serif;">Duration:</span>
                            <span id="checkoutDuration" style="color: var(--text-primary); font-weight: 600;">-</span>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span style="color: var(--text-secondary); font-family: 'Merriweather', Georgia, serif;">Display Types:</span>
                            <span id="checkoutDisplays" style="color: var(--text-primary); font-weight: 600;">-</span>
                        </div>
                        </div>
                    
                    <!-- Pricing Breakdown -->
                    <div style="border-bottom: 1px solid rgba(255, 255, 255, 0.1); padding-bottom: 1.5rem; margin-bottom: 1.5rem;">
                        <h4 style="color: #8B0000; margin-bottom: 1rem;">Pricing Breakdown</h4>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.75rem;">
                            <span style="color: var(--text-secondary); font-family: 'Merriweather', Georgia, serif;">Campaign Budget:</span>
                            <span id="checkoutBudget" style="color: var(--text-primary); font-weight: 600;">0 WEAD</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.75rem;">
                            <span style="color: var(--text-secondary); font-family: 'Merriweather', Georgia, serif;">Platform Fee (5%):</span>
                            <span id="checkoutFee" style="color: var(--text-primary); font-weight: 600;">0 WEAD</span>
                    </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.75rem;">
                            <span style="color: var(--text-secondary); font-family: 'Merriweather', Georgia, serif;">Estimated Gas Fee:</span>
                            <span style="color: var(--text-primary); font-weight: 600;">~0.001 BNB</span>
                        </div>
                    </div>
                    
                    <!-- Total -->
                    <div style="padding: 1.5rem; background: linear-gradient(135deg, rgba(139, 0, 0, 0.1), rgba(220, 20, 60, 0.1)); border-radius: 12px; margin-bottom: 2rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <span style="color: var(--text-primary); font-size: 1.3rem; font-weight: 700;">Total Amount:</span>
                            <span id="checkoutTotal" style="color: #8B0000; font-size: 1.8rem; font-weight: 800;">0 WEAD</span>
                        </div>
                        <div style="text-align: right; margin-top: 0.5rem;">
                            <span style="color: var(--text-secondary); font-size: 0.9rem;">+ Gas Fee</span>
                        </div>
                    </div>
                    
                    <!-- Payment Method -->
                    <div style="margin-bottom: 2rem;">
                        <h4 style="color: #8B0000; margin-bottom: 1rem;"><i class="fas fa-wallet"></i> Payment Method</h4>
                        
                        <!-- WEAD Token Coming Soon Message -->
                        <div style="background: linear-gradient(135deg, rgba(59, 130, 246, 0.2), rgba(37, 99, 235, 0.1)); border: 2px solid #3b82f6; border-radius: 10px; padding: 1rem; margin-bottom: 1rem;">
                            <div style="color: #3b82f6; font-weight: 700; font-size: 1.1rem; margin-bottom: 0.5rem;">
                                <i class="fas fa-clock"></i> Coming Soon: WEAD Tokens - 10% Discount on All Services
                            </div>
                            <div style="color: #cbd5e1; font-size: 0.9rem;">
                                WEAD Token payments will be available soon! Save 10% on all services when you pay with WEAD tokens. For now, please use BNB for payments.
                            </div>
                        </div>
                        
                        <div style="background: rgba(0, 0, 0, 0.3); border: 2px solid rgba(251, 191, 36, 0.3); border-radius: 12px; padding: 1.5rem; display: flex; align-items: center; gap: 1rem;">
                            <img src="https://cryptologos.cc/logos/bnb-bnb-logo.png" alt="BNB" style="width: 40px; height: 40px;">
                            <div style="flex: 1;">
                                <div style="color: var(--text-primary); font-weight: 600; margin-bottom: 0.25rem;">BNB (Binance Coin)</div>
                                <div style="color: var(--text-secondary); font-size: 0.9rem;">BSC Mainnet (BEP-20)</div>
                            </div>
                            <div id="walletStatus" style="padding: 0.5rem 1rem; background: rgba(251, 191, 36, 0.2); color: #fbbf24; border-radius: 20px; font-size: 0.85rem; font-weight: 600;">
                                <i class="fas fa-check-circle"></i> Available
                            </div>
                        </div>
                    </div>
                    
                    <!-- Important Notes -->
                    <div style="background: rgba(139, 0, 0, 0.05); border: 1px solid rgba(139, 0, 0, 0.2); border-radius: 10px; padding: 1rem; margin-bottom: 2rem;">
                        <div style="display: flex; align-items: start; gap: 0.75rem;">
                            <i class="fas fa-info-circle" style="color: #8B0000; margin-top: 0.25rem;"></i>
                            <div style="color: var(--text-secondary); font-size: 0.9rem; line-height: 1.6; font-family: 'Merriweather', Georgia, serif;">
                                By clicking "Complete Payment", you authorize the transfer of WEAD tokens from your wallet. 
                                This transaction will be recorded on the BSC blockchain and cannot be reversed once confirmed.
                            </div>
                        </div>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div style="display: flex; gap: 1rem;">
                        <button class="btn btn-secondary" onclick="switchCampaignTab('review')" style="flex: 1;">
                            <i class="fas fa-arrow-left"></i> Back to Review
                        </button>
                        <button class="btn btn-primary" onclick="launchCampaign()" id="checkoutBtn" style="flex: 2; background: linear-gradient(135deg, #8B0000, #5c0000) !important; font-size: 1.1rem; padding: 1rem;">
                            <i class="fas fa-lock"></i> Complete Payment
                        </button>
                    </div>
                </div>
            </div>
        </section>

                <!-- Tab Navigation Buttons -->
                <div class="tab-navigation" style="display: flex; justify-content: space-between; align-items: center; margin-top: 2rem; padding: 1.5rem; background: rgba(139, 0, 0, 0.1); border-radius: 15px; border: 2px solid rgba(139, 0, 0, 0.3);">
                    <button class="btn btn-secondary" onclick="switchCampaignTab('review')" style="padding: 1rem 2rem;">
                        <i class="fas fa-chevron-left"></i> Back to Review
                    </button>
                    <button class="btn btn-success" onclick="launchCampaignFinal()" style="padding: 1rem 2.5rem; font-size: 1.2rem; font-weight: 700; background: linear-gradient(135deg, #10b981, #059669) !important;">
                        <i class="fas fa-rocket"></i> Launch Campaign
                    </button>
                </div>
        
        </div>
        <!-- END TAB 6: CHECKOUT -->
        
        </div>
    </div>
    
    <!-- Toast Notification -->
    <div id="toast" class="toast"></div>
    
    <script>
        // Global Variables
        let currentUser = null;
        let walletConnected = false;
        let campaignData = {};
        
        // Note: BSC_CONFIG is available globally as window.WEAD_CONFIG.BSC_CONFIG (from config.js loaded in base.html)
        
        let performanceChart = null;
        let impressionTimeChart = null;
        
        // Initialize App
        document.addEventListener('DOMContentLoaded', function() {
            // Hide quantum loader after page loads
            setTimeout(() => {
                const loader = document.getElementById('quantumLoader');
                if (loader) {
                loader.classList.add('hidden');
                }
            }, 2000);
            
            initializeQuantumBackground();
            
            // Initialize chart with a delay to ensure DOM is ready
            setTimeout(() => {
            initializeChart();
            }, 500);
            
            updateCampaignProgress();

            // Check for existing authentication
            checkExistingAuth();

            // Add event listeners for form updates
            setupEventListeners();
        });

        // Check Existing Authentication
        async function checkExistingAuth() {
            const token = localStorage.getItem('access_token');
            const wallet = localStorage.getItem('user_wallet');

            if (token) {
                try {
                    // Verify token with backend
                    const response = await fetch('/api/auth/verify', {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });

                    if (response.ok) {
                        // Token is valid, load user data
                        if (wallet) {
                            walletConnected = true;
                            document.getElementById('metamaskText').textContent =
                                wallet.substring(0, 6) + '...' + wallet.substring(38);
                            document.getElementById('walletInfo').style.display = 'block';
                            await updateWalletBalance(wallet);
                        }

                        await loadUserCampaigns();
                    } else {
                        // Token expired, clear storage
                        localStorage.removeItem('access_token');
                        localStorage.removeItem('user_wallet');
                    }
                } catch (error) {
                    console.error('Auth verification error:', error);
                }
            }
        }

        // Setup Event Listeners
        function setupEventListeners() {
            // Location targeting changes
            document.getElementById('targetCountry').addEventListener('change', loadMicroAdvertisers);
            document.getElementById('timeSchedule').addEventListener('change', loadMicroAdvertisers);

            // Form input changes for auto-save
            const inputs = ['campaignName', 'campaignDescription', 'targetAudience',
                          'campaignDuration', 'tokenPerView', 'maxViews'];
            inputs.forEach(id => {
                document.getElementById(id).addEventListener('input', () => {
                    updateCampaignProgress();
                    // Auto-save draft every 10 seconds
                    clearTimeout(autoSaveTimer);
                    autoSaveTimer = setTimeout(saveDraft, 10000);
                });
            });
        }

        let autoSaveTimer;
        
        // Quantum Background Animation
        function initializeQuantumBackground() {
            const bg = document.getElementById('quantumBg');
            if (!bg) {
                console.log('Quantum background element not found, skipping...');
                return;
            }
            const particleCount = 50;
            
            for (let i = 0; i < particleCount; i++) {
                const particle = document.createElement('div');
                particle.className = 'quantum-particle';
                particle.style.left = Math.random() * 100 + '%';
                particle.style.animationDelay = Math.random() * 15 + 's';
                particle.style.animationDuration = (15 + Math.random() * 10) + 's';
                bg.appendChild(particle);
            }
        }
        
        // Enhanced MetaMask Connection with Backend Integration
        async function connectMetaMask() {
            if (typeof window.ethereum !== 'undefined') {
                try {
                    const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                    walletConnected = true;
                    
                    const account = accounts[0];
                    const shortAccount = account.substring(0, 6) + '...' + account.substring(38);

                    // Sign message for authentication
                    const message = `WeAD Authentication\n\nWallet: ${account}\nTimestamp: ${Date.now()}`;
                    const signature = await window.ethereum.request({
                        method: 'personal_sign',
                        params: [message, account],
                    });

                    // Authenticate with backend
                    const authResponse = await fetch('/api/auth/metamask', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            address: account,
                            signature: signature,
                            message: message
                        })
                    });

                    if (authResponse.ok) {
                        const authData = await authResponse.json();
                        localStorage.setItem('access_token', authData.access_token);
                        localStorage.setItem('user_wallet', account);
                    
                    document.getElementById('metamaskText').textContent = shortAccount;
                    document.getElementById('walletInfo').style.display = 'block';
                    
                        // Get wallet balance
                        await updateWalletBalance(account);

                        showToast('MetaMask connected and authenticated!', 'success');
                    updateCampaignProgress();

                        // Load user campaigns
                        await loadUserCampaigns();
                    } else {
                        throw new Error('Authentication failed');
                    }
                } catch (error) {
                    console.error('MetaMask connection error:', error);
                    showToast('Failed to connect MetaMask', 'error');
                }
            } else {
                showToast('MetaMask not installed. Please install it to continue.', 'error');
                window.open('https://metamask.io/download/', '_blank');
            }
        }
        
        // Update Wallet Balance
        async function updateWalletBalance(address) {
            try {
                // First try to get balance from blockchain directly
                if (window.ethereum) {
                    try {
                        const WEAD_TOKEN_ADDRESS = '0xCF99bF2cbD83A580437d39A5092C1665Faa9898B';
                        
                        // ERC20 balanceOf function signature
                        const balanceOfData = '0x70a08231000000000000000000000000' + address.slice(2).toLowerCase();
                        
                        const balance = await window.ethereum.request({
                            method: 'eth_call',
                            params: [{
                                to: WEAD_TOKEN_ADDRESS,
                                data: balanceOfData
                            }, 'latest']
                        });
                        
                        // Convert hex balance to decimal and from wei to WEAD
                        const balanceInWEAD = parseInt(balance, 16) / 1e18;
                        
                        const balanceElement = document.getElementById('walletBalance');
                        if (balanceElement) {
                            balanceElement.textContent = `${balanceInWEAD.toLocaleString()} WEAD`;
                        }
                        
                        console.log('‚úÖ WEAD Balance:', balanceInWEAD.toLocaleString(), 'WEAD');
                        return;
                    } catch (blockchainError) {
                        console.warn('Blockchain balance check failed, trying API...', blockchainError);
                    }
                }
                
                // Fallback to API
                const token = localStorage.getItem('access_token');
                if (!token) return;

                const response = await fetch('/api/wallet/balance', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('walletBalance').textContent =
                        `${data.balance.toFixed(2)} WEAD ($${data.usd_value.toFixed(2)})`;
                }
            } catch (error) {
                console.error('Error updating wallet balance:', error);
            }
        }
        
        // Enhanced Google Sign In with Backend Integration
        async function connectGoogle() {
            try {
                // Initialize Google Sign-In if not already done
                if (!window.google || !window.google.accounts) {
                    showToast('Google Sign-In not available', 'error');
                    return;
                }

                const client = window.google.accounts.oauth2.initTokenClient({
                    client_id: 'YOUR_GOOGLE_CLIENT_ID', // Replace with actual client ID
                    scope: 'openid email profile',
                    callback: async (response) => {
                        if (response.error) {
                            showToast('Google sign-in failed', 'error');
                            return;
                        }

                        // Verify token with backend
                        const authResponse = await fetch('/api/auth/google', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                token: response.access_token
                            })
                        });

                        if (authResponse.ok) {
                            const authData = await authResponse.json();
                            localStorage.setItem('access_token', authData.access_token);

                currentUser = {
                                name: authData.user.name,
                                email: authData.user.email,
                                id: authData.user.id
                            };

                            document.getElementById('googleText').textContent = authData.user.name;
                showToast('Google account connected!', 'success');
                updateCampaignProgress();

                            // Load user campaigns
                            await loadUserCampaigns();
                        } else {
                            showToast('Google authentication failed', 'error');
                        }
                    }
                });

                client.requestAccessToken();
            } catch (error) {
                console.error('Google sign-in error:', error);
                showToast('Google sign-in failed', 'error');
            }
        }

        // Load User Campaigns
        async function loadUserCampaigns() {
            try {
                const token = localStorage.getItem('access_token');
                if (!token) return;

                const response = await fetch('/api/campaigns', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const campaigns = await response.json();
                    updateCampaignStats(campaigns);
                    displayUserCampaigns(campaigns);
                }
            } catch (error) {
                console.error('Error loading campaigns:', error);
            }
        }

        // Update Campaign Statistics
        function updateCampaignStats(campaigns) {
            const totalCampaigns = campaigns.length;
            const activeCampaigns = campaigns.filter(c => c.status === 'active').length;
            const totalViews = campaigns.reduce((sum, c) => sum + (c.total_views || 0), 0);
            const totalSpent = campaigns.reduce((sum, c) => sum + parseFloat(c.spent_budget || 0), 0);

            document.getElementById('totalCampaigns').textContent = totalCampaigns;
            document.getElementById('totalViews').textContent = totalViews.toLocaleString();
            document.getElementById('totalSpent').textContent = totalSpent.toFixed(2);
            document.getElementById('activeAdvertisers').textContent = Math.floor(Math.random() * 50) + 10; // Mock data
        }

        // Display User Campaigns
        function displayUserCampaigns(campaigns) {
            const container = document.getElementById('recentCampaigns');

            if (campaigns.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: var(--text-secondary);">No campaigns yet. Create your first campaign!</p>';
                return;
            }

            container.innerHTML = campaigns.map(campaign => `
                <div class="glass" style="padding: 2rem; border-radius: 15px; margin-bottom: 1rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h4 style="color: var(--quantum-primary);">${campaign.name}</h4>
                        <span style="padding: 0.5rem 1rem; background: var(--quantum-${campaign.status === 'active' ? 'success' : 'warning'}); color: white; border-radius: 20px; font-size: 0.8rem;">${campaign.status}</span>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-bottom: 1rem;">
                        <div>
                            <div style="color: var(--text-secondary); font-size: 0.9rem;">Views</div>
                            <div style="color: var(--text-primary); font-weight: 600;">${(campaign.total_views || 0).toLocaleString()}</div>
                        </div>
                        <div>
                            <div style="color: var(--text-secondary); font-size: 0.9rem;">Spent</div>
                            <div style="color: var(--text-primary); font-weight: 600;">${parseFloat(campaign.spent_budget || 0).toFixed(2)} WEAD</div>
                        </div>
                        <div>
                            <div style="color: var(--text-secondary); font-size: 0.9rem;">Budget</div>
                            <div style="color: var(--text-primary); font-weight: 600;">${parseFloat(campaign.total_budget || 0).toFixed(2)} WEAD</div>
                        </div>
                        <div>
                            <div style="color: var(--text-secondary); font-size: 0.9rem;">Days Left</div>
                            <div style="color: var(--text-primary); font-weight: 600;">${campaign.duration_days || 0} days</div>
                        </div>
                    </div>
                    <div style="display: flex; gap: 1rem;">
                        <button class="btn btn-secondary" style="padding: 0.5rem 1rem; font-size: 0.9rem;" onclick="viewCampaignAnalytics('${campaign.campaign_id}')">
                            <i class="fas fa-chart-bar"></i> Analytics
                        </button>
                        <button class="btn btn-secondary" style="padding: 0.5rem 1rem; font-size: 0.9rem;" onclick="pauseCampaign('${campaign.campaign_id}')">
                            <i class="fas fa-pause"></i> ${campaign.status === 'active' ? 'Pause' : 'Resume'}
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // Interactive Google Maps Functionality
        let map;
        let selectedAreas = [];
        let currentCountry = 'us';
        let currentCity = '';
        let markers = [];
        let circles = [];

        // ========================================
        // DUAL MAP SYSTEM: Google Maps (Primary) + Leaflet (Fallback)
        // ========================================
        
        let mapType = 'leaflet'; // Track which map system is being used
        let googleMap = null; // Google Maps instance
        let placesService = null; // Google Places Service
        let heatmap = null; // Google Heatmap instance
        
        // Master initialization function - chooses between Google and Leaflet
        function initMap() {
            if (GOOGLE_MAPS_CONFIG.USE_GOOGLE && typeof google !== 'undefined') {
                console.log('üó∫Ô∏è Initializing Google Maps...');
                initGoogleMap();
            } else {
                console.log('üó∫Ô∏è Initializing Leaflet Map (Fallback)...');
                initLeafletMap();
            }
        }
        
        // Initialize Google Maps with Places API
        function initGoogleMap() {
            try {
                mapType = 'google';
                const countryCoords = getCountryCoordinates(currentCountry);
                
                // Create Google Map
                googleMap = new google.maps.Map(document.getElementById('locationMap'), {
                    center: { lat: countryCoords.center.lat, lng: countryCoords.center.lng },
                    zoom: countryCoords.zoom,
                    mapTypeControl: true,
                    streetViewControl: false,
                    fullscreenControl: true,
                    zoomControl: true,
                    scrollwheel: true,
                    gestureHandling: 'greedy',
                    styles: [
                        {
                            featureType: "poi",
                            elementType: "labels",
                            stylers: [{ visibility: "on" }]
                        }
                    ]
                });
                
                // Initialize Places Service for real impressions data
                placesService = new google.maps.places.PlacesService(googleMap);
                
                // Add real advertiser locations with Places API
                setTimeout(function() {
                    addGoogleAdvertiserData();
                }, 500);
                
                // Add click handler for selecting areas
                googleMap.addListener('click', function(e) {
                    selectAreaFromMap({ lat: e.latLng.lat(), lng: e.latLng.lng() });
                });
                
                // Update initial stats
                updateLocationStats();
                
                // Start fetching real-time user locations
                startUserLocationTracking();
                
                console.log('‚úÖ Google Maps initialized successfully');
                showMapStatus('Google Maps Loaded (Real Data)', 'success');
                
            } catch (error) {
                console.error('‚ùå Error initializing Google Maps:', error);
                console.log('‚ö†Ô∏è Falling back to Leaflet...');
                initLeafletMap();
            }
        }
        
        // Initialize Leaflet Map (Fallback)
        function initLeafletMap() {
            try {
                mapType = 'leaflet';
                // Create map centered on the selected country
                const countryCoords = getCountryCoordinates(currentCountry);
                map = L.map('locationMap', {
                    center: [countryCoords.center.lat, countryCoords.center.lng],
                    zoom: countryCoords.zoom,
                    zoomControl: true,
                    scrollWheelZoom: true
                });

                // Add OpenStreetMap tiles with error handling and fallback
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '¬© OpenStreetMap contributors',
                    maxZoom: 18,
                    minZoom: 3,
                    errorTileUrl: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg=='
                }).on('tileerror', function(e) {
                    console.warn('OpenStreetMap tile failed to load, trying alternative...');
                    // Try alternative tile server
                    L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '¬© OpenStreetMap contributors',
                        maxZoom: 18,
                        minZoom: 3
                    }).addTo(map);
                }).addTo(map);

                // Add heat map overlay for advertiser density
                setTimeout(function() {
                    addAdvertiserHeatMap();
                }, 500);

                // Add click handler for selecting areas
                map.on('click', function(e) {
                    selectAreaFromMap(e.latlng);
                });

                // Update initial stats
                updateLocationStats();
                
                // Start fetching real-time user locations
                startUserLocationTracking();

                console.log('‚úÖ Leaflet map initialized successfully');
                showMapStatus('Leaflet Map Loaded (Fallback)', 'info');

            } catch (error) {
                console.error('Error initializing Leaflet map:', error);

                // Add error indicator
                const mapContainer = document.querySelector('.map-container');
                const errorIndicator = document.createElement('div');
                errorIndicator.id = 'mapError';
                errorIndicator.style.cssText = `
                    position: absolute;
                    top: 10px;
                    left: 10px;
                    background: rgba(255, 0, 0, 0.9);
                    color: white;
                    padding: 10px 15px;
                    border-radius: 5px;
                    font-size: 14px;
                    z-index: 1001;
                    cursor: pointer;
                `;
                errorIndicator.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Map Error - Click for details';
                errorIndicator.onclick = () => alert('Map initialization failed. Check browser console for technical details.\n\nPossible causes:\n- Network connectivity issues\n- JavaScript errors\n- Missing map tiles');
                mapContainer.appendChild(errorIndicator);

                // Fallback: show error message
                document.getElementById('locationMap').innerHTML = `
                    <div style="display: flex; align-items: center; justify-content: center; height: 100%; background: rgba(139, 0, 0, 0.1); border-radius: 15px; color: var(--quantum-primary);">
                        <div style="text-align: center;">
                            <i class="fas fa-exclamation-triangle" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                            <h3>Map Loading Error</h3>
                            <p>Please check console for details</p>
                            <button onclick="window.testMapFunctions()" style="margin-top: 1rem; padding: 10px 20px; background: var(--quantum-primary); color: white; border: none; border-radius: 5px; cursor: pointer;">Run Diagnostics</button>
                        </div>
                    </div>
                `;
            }
        }
        
        // ========================================
        // HELPER FUNCTIONS FOR DUAL MAP SYSTEM
        // ========================================
        
        // Show map status indicator
        function showMapStatus(message, type = 'success') {
            const mapContainer = document.querySelector('.map-container');
            const existingStatus = document.getElementById('mapStatus');
            if (existingStatus) existingStatus.remove();
            
            const statusIndicator = document.createElement('div');
            statusIndicator.id = 'mapStatus';
            
            const colors = {
                success: 'rgba(16, 185, 129, 0.9)',
                info: 'rgba(59, 130, 246, 0.9)',
                warning: 'rgba(245, 158, 11, 0.9)',
                error: 'rgba(239, 68, 68, 0.9)'
            };
            
            statusIndicator.style.cssText = `
                position: absolute;
                top: 10px;
                left: 10px;
                background: ${colors[type] || colors.info};
                color: white;
                padding: 8px 12px;
                border-radius: 8px;
                font-size: 12px;
                z-index: 1001;
                display: flex;
                align-items: center;
                gap: 8px;
                box-shadow: 0 2px 10px rgba(0,0,0,0.3);
                transition: opacity 0.5s;
            `;
            
            const icons = {
                success: 'check-circle',
                info: 'info-circle',
                warning: 'exclamation-triangle',
                error: 'times-circle'
            };
            
            statusIndicator.innerHTML = `<i class="fas fa-${icons[type] || icons.info}"></i> ${message}`;
            mapContainer.appendChild(statusIndicator);
            
            // Auto-hide after 4 seconds
            setTimeout(() => {
                statusIndicator.style.opacity = '0';
                setTimeout(() => statusIndicator.remove(), 500);
            }, 4000);
        }
        
        // Add Google Maps advertiser data with Places API
        function addGoogleAdvertiserData() {
            if (!placesService || !googleMap) return;
            
            console.log('üìç Fetching real location data from Google Places API...');
            
            // Get popular places in the current view
            const center = googleMap.getCenter();
            const request = {
                location: center,
                radius: 50000, // 50km radius
                type: ['shopping_mall', 'store', 'restaurant', 'cafe', 'bar', 'gym']
            };
            
            placesService.nearbySearch(request, function(results, status) {
                if (status === google.maps.places.PlacesServiceStatus.OK) {
                    console.log(`‚úÖ Found ${results.length} real locations from Google Places`);
                    
                    results.forEach(function(place) {
                        // Get place details for impressions data
                        placesService.getDetails({
                            placeId: place.place_id,
                            fields: ['name', 'geometry', 'user_ratings_total', 'rating', 'types', 'vicinity']
                        }, function(details, detailStatus) {
                            if (detailStatus === google.maps.places.PlacesServiceStatus.OK) {
                                // Use user_ratings_total as proxy for impressions
                                const impressions = (details.user_ratings_total || 0) * 100;
                                const advertisers = Math.floor(impressions / 500);
                                
                                // Create marker with real data
                                const marker = new google.maps.Marker({
                                    position: details.geometry.location,
                                    map: googleMap,
                                    title: details.name,
                                    icon: {
                                        path: google.maps.SymbolPath.CIRCLE,
                                        scale: Math.min(advertisers / 10, 15),
                                        fillColor: getHeatColorGoogle(advertisers),
                                        fillOpacity: 0.6,
                                        strokeWeight: 2,
                                        strokeColor: '#ffffff'
                                    }
                                });
                                
                                // Add info window with real data
                                const infoWindow = new google.maps.InfoWindow({
                                    content: `
                                        <div class="map-popup" style="color: #333; font-family: Arial;">
                                            <h4 style="margin: 0 0 10px 0; color: #8B0000;">${details.name}</h4>
                                            <p style="margin: 5px 0;"><strong>Est. Advertisers:</strong> ${advertisers}</p>
                                            <p style="margin: 5px 0;"><strong>Est. Daily Impressions:</strong> ${impressions.toLocaleString()}</p>
                                            <p style="margin: 5px 0;"><strong>Rating:</strong> ${details.rating || 'N/A'} ‚≠ê</p>
                                            <p style="margin: 5px 0;"><strong>Location:</strong> ${details.vicinity}</p>
                                            <button onclick="selectGoogleArea('${place.place_id}', '${details.name}', ${advertisers}, ${impressions}, ${details.geometry.location.lat()}, ${details.geometry.location.lng()})" 
                                                    style="margin-top: 10px; padding: 8px 16px; background: #8B0000; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: 600;">
                                                Select Area
                                            </button>
                                        </div>
                                    `
                                });
                                
                                marker.addListener('click', function() {
                                    infoWindow.open(googleMap, marker);
                                });
                                
                                markers.push(marker);
                            }
                        });
                    });
                    
                    showMapStatus(`Loaded ${results.length} real locations`, 'success');
                } else {
                    console.warn('‚ö†Ô∏è Google Places API request failed:', status);
                    showMapStatus('Using fallback data', 'warning');
                    // Fall back to fake data
                    addAdvertiserHeatMap();
                }
            });
        }
        
        // Get heat color for Google Maps
        function getHeatColorGoogle(advertisers) {
            if (advertisers >= 500) return '#8B0000'; // Dark red
            if (advertisers >= 200) return '#DC143C'; // Crimson
            if (advertisers >= 50) return '#FF6347';  // Tomato
            return '#CD5C5C'; // Indian Red
        }
        
        // Select area from Google Maps
        window.selectGoogleArea = function(placeId, name, advertisers, impressions, lat, lng) {
            const area = {
                id: placeId,
                name: name,
                advertisers: advertisers,
                impressions: impressions,
                center: { lat: lat, lng: lng },
                density: advertisers >= 500 ? 'high' : (advertisers >= 200 ? 'medium' : 'low')
            };
            
            // Check if already selected
            if (selectedAreas.find(a => a.id === placeId)) {
                selectedAreas = selectedAreas.filter(a => a.id !== placeId);
            } else {
                selectedAreas.push(area);
            }
            
            updateSelectedAreasDisplay();
            updateLocationStats();
            updateProjectedStats();
            
            // Close all info windows
            if (googleMap) {
                // Info windows close automatically when another opens
            }
        };

        function getCountryCoordinates(country) {
            const coords = {
                'us': { center: L.latLng(39.8283, -98.5795), zoom: 5 },
                'uk': { center: L.latLng(54.7023545, -3.2765753), zoom: 6 },
                'ca': { center: L.latLng(56.1304, -106.3468), zoom: 4 },
                'au': { center: L.latLng(-25.2744, 133.7751), zoom: 5 },
                'sg': { center: L.latLng(1.3521, 103.8198), zoom: 11 },
                'jp': { center: L.latLng(36.2048, 138.2529), zoom: 6 },
                'kr': { center: L.latLng(35.9078, 127.7669), zoom: 7 },
                'de': { center: L.latLng(51.1657, 10.4515), zoom: 6 },
                'fr': { center: L.latLng(46.2276, 2.2137), zoom: 6 },
                'vn': { center: L.latLng(14.0583, 108.2772), zoom: 6 },
                'th': { center: L.latLng(15.8700, 100.9925), zoom: 6 },
                'tw': { center: L.latLng(23.6978, 120.9605), zoom: 8 },
                'hk': { center: L.latLng(22.3193, 114.1694), zoom: 11 },
                'id': { center: L.latLng(-0.7893, 113.9213), zoom: 5 },
                'ph': { center: L.latLng(12.8797, 121.7740), zoom: 6 }
            };
            return coords[country] || coords['us'];
        }

        function addAdvertiserHeatMap() {
            // Clear existing markers and circles
            clearMapOverlays();

            // TODO: REPLACE FAKE NPC DATA WITH REAL USER DATA FROM GOOGLE MAPS API
            // When you have real users in your mobile app:
            // 1. Remove the getAdvertiserDensityAreas() function
            // 2. Fetch real user locations from your backend API
            // 3. Use Google Maps Places API for accurate location data
            // 4. Integrate Google Maps Foot Traffic API for real visitor counts
            // 5. Add real-time location updates from mobile app users
            const densityAreas = getAdvertiserDensityAreas();

            densityAreas.forEach(area => {
                try {
                    // Create circle for density visualization
                    const circle = L.circle([area.center.lat, area.center.lng], {
                        color: getDensityColor(area.density),
                        fillColor: getDensityColor(area.density),
                        fillOpacity: 0.3,
                        radius: area.radius,
                        weight: 2
                    }).addTo(map);

                    // Create marker for the area
                    const marker = L.marker([area.center.lat, area.center.lng], {
                        title: area.name
                    }).addTo(map);

                    // Add popup to marker
                    marker.bindPopup(`
                        <div class="map-popup">
                            <h4>${area.name}</h4>
                            <p><strong>Advertisers:</strong> ${area.advertisers}</p>
                            <p><strong>Daily Impressions:</strong> ${area.impressions.toLocaleString()}</p>
                            <p><strong>Density:</strong> ${area.density}</p>
                            <p><strong>Foot Traffic:</strong> High</p>
                            <button onclick="selectArea('${area.id}')" class="btn btn-sm btn-primary" style="margin-top: 10px;">Select Area</button>
                        </div>
                    `);

                    markers.push(marker);
                    circles.push(circle);

                } catch (error) {
                    console.error('Error creating map overlay for area:', area.name, error);
                }
            });
        }

        function clearMapOverlays() {
            // Clear all markers
            markers.forEach(marker => map.removeLayer(marker));
            markers = [];

            // Clear all circles
            circles.forEach(circle => map.removeLayer(circle));
            circles = [];
        }

        function getAdvertiserDensityAreas() {
            // FAKE NPC DATA FOR TESTING - REPLACE WITH REAL USER DATA LATER
            // TODO: Replace this with real user data from Google Maps API and foot traffic analysis
            // TODO: Connect to Google Maps Places API for real location data
            // TODO: Integrate with Google Maps Foot Traffic API for accurate visitor counts
            // TODO: Add real-time user location updates from mobile app

            const areas = {
                'us': [
                    // Major Cities
                    { id: 'nyc', name: 'New York City', center: L.latLng(40.7128, -74.0060), radius: 15000, advertisers: 850, impressions: 125000, density: 'high' },
                    { id: 'la', name: 'Los Angeles', center: L.latLng(34.0522, -118.2437), radius: 20000, advertisers: 720, impressions: 98000, density: 'high' },
                    { id: 'chicago', name: 'Chicago', center: L.latLng(41.8781, -87.6298), radius: 12000, advertisers: 580, impressions: 78000, density: 'high' },
                    { id: 'houston', name: 'Houston', center: L.latLng(29.7604, -95.3698), radius: 18000, advertisers: 420, impressions: 65000, density: 'medium' },
                    { id: 'phoenix', name: 'Phoenix', center: L.latLng(33.4484, -112.0740), radius: 14000, advertisers: 380, impressions: 52000, density: 'medium' },
                    { id: 'philadelphia', name: 'Philadelphia', center: L.latLng(39.9526, -75.1652), radius: 11000, advertisers: 490, impressions: 67000, density: 'high' },
                    { id: 'sanantonio', name: 'San Antonio', center: L.latLng(29.4241, -98.4936), radius: 13000, advertisers: 320, impressions: 45000, density: 'medium' },
                    { id: 'sandiego', name: 'San Diego', center: L.latLng(32.7157, -117.1611), radius: 16000, advertisers: 410, impressions: 58000, density: 'medium' },

                    // Medium Cities
                    { id: 'dallas', name: 'Dallas', center: L.latLng(32.7767, -96.7970), radius: 12000, advertisers: 290, impressions: 38000, density: 'medium' },
                    { id: 'sanjose', name: 'San Jose', center: L.latLng(37.3382, -122.0453), radius: 10000, advertisers: 350, impressions: 48000, density: 'medium' },
                    { id: 'austin', name: 'Austin', center: L.latLng(30.2672, -97.7431), radius: 9000, advertisers: 310, impressions: 42000, density: 'medium' },
                    { id: 'jacksonville', name: 'Jacksonville', center: L.latLng(30.3322, -81.6557), radius: 8500, advertisers: 180, impressions: 24000, density: 'low' },
                    { id: 'fortworth', name: 'Fort Worth', center: L.latLng(32.7555, -97.3308), radius: 7500, advertisers: 220, impressions: 29000, density: 'medium' },
                    { id: 'columbus', name: 'Columbus', center: L.latLng(39.9612, -82.9988), radius: 9500, advertisers: 260, impressions: 34000, density: 'medium' },

                    // Smaller Cities
                    { id: 'indianapolis', name: 'Indianapolis', center: L.latLng(39.7684, -86.1581), radius: 7000, advertisers: 190, impressions: 25000, density: 'low' },
                    { id: 'charlotte', name: 'Charlotte', center: L.latLng(35.2271, -80.8431), radius: 8000, advertisers: 240, impressions: 32000, density: 'medium' },
                    { id: 'sf', name: 'San Francisco', center: L.latLng(37.7749, -122.4194), radius: 11000, advertisers: 520, impressions: 71000, density: 'high' },
                    { id: 'seattle', name: 'Seattle', center: L.latLng(47.6062, -122.3321), radius: 8000, advertisers: 310, impressions: 42000, density: 'medium' },
                    { id: 'denver', name: 'Denver', center: L.latLng(39.7392, -104.9903), radius: 8500, advertisers: 280, impressions: 37000, density: 'medium' },
                    { id: 'oklahoma', name: 'Oklahoma City', center: L.latLng(35.4676, -97.5164), radius: 6500, advertisers: 160, impressions: 21000, density: 'low' }
                ],
                'uk': [
                    { id: 'london', name: 'London', center: L.latLng(51.5074, -0.1278), radius: 12000, advertisers: 650, impressions: 89000, density: 'high' },
                    { id: 'birmingham', name: 'Birmingham', center: L.latLng(52.4862, -1.8904), radius: 8000, advertisers: 320, impressions: 44000, density: 'medium' },
                    { id: 'manchester', name: 'Manchester', center: L.latLng(53.4808, -2.2426), radius: 8000, advertisers: 380, impressions: 52000, density: 'medium' },
                    { id: 'leeds', name: 'Leeds', center: L.latLng(53.8008, -1.5491), radius: 7000, advertisers: 290, impressions: 39000, density: 'medium' },
                    { id: 'glasgow', name: 'Glasgow', center: L.latLng(55.8642, -4.2518), radius: 7500, advertisers: 310, impressions: 42000, density: 'medium' },
                    { id: 'newcastle', name: 'Newcastle', center: L.latLng(54.9783, -1.6178), radius: 6500, advertisers: 240, impressions: 32000, density: 'medium' },
                    { id: 'brighton', name: 'Brighton', center: L.latLng(50.8225, -0.1372), radius: 6000, advertisers: 180, impressions: 24000, density: 'low' },
                    { id: 'bristol', name: 'Bristol', center: L.latLng(51.4545, -2.5879), radius: 6800, advertisers: 270, impressions: 36000, density: 'medium' }
                ],
                'ca': [
                    { id: 'toronto', name: 'Toronto', center: L.latLng(43.6532, -79.3832), radius: 14000, advertisers: 580, impressions: 79000, density: 'high' },
                    { id: 'vancouver', name: 'Vancouver', center: L.latLng(49.2827, -123.1207), radius: 11000, advertisers: 420, impressions: 57000, density: 'medium' },
                    { id: 'montreal', name: 'Montreal', center: L.latLng(45.5017, -73.5673), radius: 12000, advertisers: 390, impressions: 53000, density: 'medium' },
                    { id: 'calgary', name: 'Calgary', center: L.latLng(51.0447, -114.0719), radius: 9500, advertisers: 280, impressions: 38000, density: 'medium' },
                    { id: 'ottawa', name: 'Ottawa', center: L.latLng(45.4215, -75.6972), radius: 8500, advertisers: 240, impressions: 32000, density: 'medium' },
                    { id: 'edmonton', name: 'Edmonton', center: L.latLng(53.5444, -113.4909), radius: 9000, advertisers: 220, impressions: 29000, density: 'medium' }
                ],
                'au': [
                    { id: 'sydney', name: 'Sydney', center: L.latLng(-33.8688, 151.2093), radius: 18000, advertisers: 620, impressions: 85000, density: 'high' },
                    { id: 'melbourne', name: 'Melbourne', center: L.latLng(-37.8136, 144.9631), radius: 16000, advertisers: 580, impressions: 79000, density: 'high' },
                    { id: 'brisbane', name: 'Brisbane', center: L.latLng(-27.4698, 153.0251), radius: 13000, advertisers: 380, impressions: 52000, density: 'medium' },
                    { id: 'perth', name: 'Perth', center: L.latLng(-31.9505, 115.8605), radius: 14000, advertisers: 320, impressions: 43000, density: 'medium' },
                    { id: 'adelaide', name: 'Adelaide', center: L.latLng(-34.9285, 138.6007), radius: 11000, advertisers: 290, impressions: 39000, density: 'medium' }
                ],
                'sg': [
                    { id: 'singapore', name: 'Singapore Central', center: L.latLng(1.3521, 103.8198), radius: 8000, advertisers: 890, impressions: 121000, density: 'high' },
                    { id: 'orchard', name: 'Orchard Road', center: L.latLng(1.3039, 103.8317), radius: 3000, advertisers: 450, impressions: 61000, density: 'high' },
                    { id: 'sentosa', name: 'Sentosa Island', center: L.latLng(1.2494, 103.8303), radius: 4000, advertisers: 280, impressions: 38000, density: 'medium' }
                ],
                'jp': [
                    { id: 'tokyo', name: 'Tokyo', center: L.latLng(35.6762, 139.6503), radius: 25000, advertisers: 1200, impressions: 163000, density: 'high' },
                    { id: 'osaka', name: 'Osaka', center: L.latLng(34.6937, 135.5023), radius: 15000, advertisers: 680, impressions: 92000, density: 'high' },
                    { id: 'yokohama', name: 'Yokohama', center: L.latLng(35.4437, 139.6380), radius: 12000, advertisers: 520, impressions: 71000, density: 'high' },
                    { id: 'nagoya', name: 'Nagoya', center: L.latLng(35.1815, 136.9066), radius: 13000, advertisers: 480, impressions: 65000, density: 'medium' },
                    { id: 'sapporo', name: 'Sapporo', center: L.latLng(43.0618, 141.3545), radius: 10000, advertisers: 320, impressions: 43000, density: 'medium' },
                    { id: 'fukuoka', name: 'Fukuoka', center: L.latLng(33.5904, 130.4017), radius: 9000, advertisers: 380, impressions: 52000, density: 'medium' }
                ],
                'kr': [
                    { id: 'seoul', name: 'Seoul', center: L.latLng(37.5665, 126.9780), radius: 22000, advertisers: 950, impressions: 129000, density: 'high' },
                    { id: 'busan', name: 'Busan', center: L.latLng(35.1796, 129.0756), radius: 12000, advertisers: 420, impressions: 57000, density: 'medium' },
                    { id: 'incheon', name: 'Incheon', center: L.latLng(37.4563, 126.7052), radius: 8000, advertisers: 350, impressions: 48000, density: 'medium' },
                    { id: 'daegu', name: 'Daegu', center: L.latLng(35.8714, 128.6014), radius: 7000, advertisers: 290, impressions: 39000, density: 'medium' }
                ],
                'de': [
                    { id: 'berlin', name: 'Berlin', center: L.latLng(52.5200, 13.4050), radius: 14000, advertisers: 580, impressions: 79000, density: 'high' },
                    { id: 'munich', name: 'Munich', center: L.latLng(48.1351, 11.5820), radius: 10000, advertisers: 420, impressions: 57000, density: 'medium' },
                    { id: 'hamburg', name: 'Hamburg', center: L.latLng(53.5511, 9.9937), radius: 9000, advertisers: 380, impressions: 52000, density: 'medium' },
                    { id: 'cologne', name: 'Cologne', center: L.latLng(50.9375, 6.9603), radius: 8000, advertisers: 320, impressions: 43000, density: 'medium' },
                    { id: 'frankfurt', name: 'Frankfurt', center: L.latLng(50.1109, 8.6821), radius: 7500, advertisers: 360, impressions: 49000, density: 'medium' }
                ],
                'fr': [
                    { id: 'paris', name: 'Paris', center: L.latLng(48.8566, 2.3522), radius: 16000, advertisers: 720, impressions: 98000, density: 'high' },
                    { id: 'lyon', name: 'Lyon', center: L.latLng(45.7640, 4.8357), radius: 10000, advertisers: 380, impressions: 52000, density: 'medium' },
                    { id: 'marseille', name: 'Marseille', center: L.latLng(43.2965, 5.3698), radius: 9000, advertisers: 320, impressions: 43000, density: 'medium' },
                    { id: 'toulouse', name: 'Toulouse', center: L.latLng(43.6047, 1.4442), radius: 8000, advertisers: 290, impressions: 39000, density: 'medium' },
                    { id: 'nice', name: 'Nice', center: L.latLng(43.7102, 7.2620), radius: 6000, advertisers: 240, impressions: 32000, density: 'medium' }
                ]
            };

            return areas[currentCountry] || areas['us'];
        }

        function getDensityColor(density) {
            switch(density) {
                case 'high': return '#8B0000'; // Dark Red
                case 'medium': return '#A52A2A'; // Brown Red
                case 'low': return '#CD5C5C'; // Indian Red
                default: return '#8B0000';
            }
        }

        function selectAreaFromMap(latlng) {
            // Find the closest area to the clicked point
            const areas = getAdvertiserDensityAreas();
            let closestArea = null;
            let minDistance = Infinity;

            areas.forEach(area => {
                const distance = map.distance(latlng, [area.center.lat, area.center.lng]);
                if (distance < minDistance && distance < (area.radius / 1000)) { // Convert meters to km for comparison
                    minDistance = distance;
                    closestArea = area;
                }
            });

            if (closestArea) {
                selectArea(closestArea.id);
                console.log('Selected area:', closestArea.name);
            } else {
                console.log('No area found near click location');
            }
        }

        function selectArea(areaId) {
            const area = getAdvertiserDensityAreas().find(a => a.id === areaId);
            if (!area) return;

            if (selectedAreas.find(a => a.id === areaId)) {
                // Remove area
                selectedAreas = selectedAreas.filter(a => a.id !== areaId);
            } else {
                // Add area
                selectedAreas.push(area);
            }

            updateSelectedAreasDisplay();
            updateLocationStats();
            updateProjectedStats();
            
            // Close the popup automatically after selection
            if (typeof map !== 'undefined' && map) {
                map.closePopup();
            }
        }

        function updateSelectedAreasDisplay() {
            const container = document.getElementById('selectedAreasList');
            if (selectedAreas.length === 0) {
                container.innerHTML = '<p style="color: var(--text-secondary); font-style: italic;">Click on areas on the map to select them</p>';
                return;
            }

            container.innerHTML = selectedAreas.map(area => `
                <div class="selected-area-item">
                    <div class="area-info">
                        <strong>${area.name}</strong>
                        <span class="area-stats">${area.advertisers} advertisers ‚Ä¢ ${area.impressions.toLocaleString()} impressions/day</span>
                    </div>
                    <button onclick="removeArea('${area.id}')" class="btn btn-sm btn-danger">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `).join('');
        }

        function removeArea(areaId) {
            selectedAreas = selectedAreas.filter(a => a.id !== areaId);
            updateSelectedAreasDisplay();
            updateLocationStats();
            updateProjectedStats();
        }

        function updateLocationStats() {
            const totalAdvertisers = selectedAreas.reduce((sum, area) => sum + area.advertisers, 0);
            const totalImpressions = selectedAreas.reduce((sum, area) => sum + area.impressions, 0);
            const reachPotential = selectedAreas.length > 0 ? Math.min(100, (selectedAreas.length * 15) + (totalAdvertisers / 100)) : 0;

            document.getElementById('totalAdvertisers').textContent = totalAdvertisers.toLocaleString();
            document.getElementById('estimatedImpressions').textContent = totalImpressions.toLocaleString();
            document.getElementById('selectedAreas').textContent = selectedAreas.length;
            document.getElementById('reachPotential').textContent = reachPotential.toFixed(1) + '%';

            // Update campaign data
            campaignData.selectedAreas = selectedAreas;
        }

        function changeCountry() {
            currentCountry = document.getElementById('countrySelect').value;
            currentCity = '';

            // Update city options based on country
            updateCityOptions();

            // Re-center map based on map type
            const coords = getCountryCoordinates(currentCountry);
            
            if (mapType === 'google' && googleMap) {
                // Google Maps
                googleMap.setCenter({ lat: coords.center.lat, lng: coords.center.lng });
                googleMap.setZoom(coords.zoom);
                addGoogleAdvertiserData();
            } else if (map) {
                // Leaflet
                map.setView([coords.center.lat, coords.center.lng], coords.zoom);
                addAdvertiserHeatMap();
            }

            // Clear selections
            selectedAreas = [];
            updateSelectedAreasDisplay();
            updateLocationStats();

            console.log('Changed country to:', currentCountry);
        }

        function updateCityOptions() {
            const citySelect = document.getElementById('citySelect');
            const cities = getCitiesForCountry(currentCountry);

            citySelect.innerHTML = '<option value="">Select city...</option>';
            cities.forEach(city => {
                citySelect.innerHTML += `<option value="${city.id}">${city.name}</option>`;
            });
        }

        function getCitiesForCountry(country) {
            const cities = {
                'us': [
                    { id: 'nyc', name: 'New York City' },
                    { id: 'la', name: 'Los Angeles' },
                    { id: 'chicago', name: 'Chicago' },
                    { id: 'houston', name: 'Houston' },
                    { id: 'phoenix', name: 'Phoenix' },
                    { id: 'sf', name: 'San Francisco' },
                    { id: 'seattle', name: 'Seattle' },
                    { id: 'sandiego', name: 'San Diego' },
                    { id: 'dallas', name: 'Dallas' },
                    { id: 'austin', name: 'Austin' }
                ],
                'uk': [
                    { id: 'london', name: 'London' },
                    { id: 'manchester', name: 'Manchester' },
                    { id: 'birmingham', name: 'Birmingham' }
                ],
                'ca': [
                    { id: 'toronto', name: 'Toronto' },
                    { id: 'vancouver', name: 'Vancouver' },
                    { id: 'montreal', name: 'Montreal' }
                ],
                'vn': [
                    { id: 'hanoi', name: 'Hanoi' },
                    { id: 'ho-chi-minh', name: 'Ho Chi Minh City' },
                    { id: 'da-nang', name: 'Da Nang' },
                    { id: 'hai-phong', name: 'Hai Phong' }
                ],
                'th': [
                    { id: 'bangkok', name: 'Bangkok' },
                    { id: 'chiang-mai', name: 'Chiang Mai' },
                    { id: 'phuket', name: 'Phuket' },
                    { id: 'pattaya', name: 'Pattaya' }
                ],
                'tw': [
                    { id: 'taipei', name: 'Taipei' },
                    { id: 'kaohsiung', name: 'Kaohsiung' },
                    { id: 'taichung', name: 'Taichung' },
                    { id: 'tainan', name: 'Tainan' }
                ],
                'hk': [
                    { id: 'central', name: 'Central' },
                    { id: 'kowloon', name: 'Kowloon' },
                    { id: 'new-territories', name: 'New Territories' }
                ],
                'id': [
                    { id: 'jakarta', name: 'Jakarta' },
                    { id: 'surabaya', name: 'Surabaya' },
                    { id: 'bandung', name: 'Bandung' },
                    { id: 'medan', name: 'Medan' },
                    { id: 'bali', name: 'Bali' }
                ],
                'ph': [
                    { id: 'manila', name: 'Manila' },
                    { id: 'quezon-city', name: 'Quezon City' },
                    { id: 'cebu', name: 'Cebu' },
                    { id: 'davao', name: 'Davao' }
                ]
            };
            return cities[country] || cities['us'];
        }

        function changeCity() {
            currentCity = document.getElementById('citySelect').value;

            if (currentCity) {
                const areas = getAdvertiserDensityAreas();
                const cityArea = areas.find(a => a.id === currentCity);

                if (cityArea) {
                    if (mapType === 'google' && googleMap) {
                        // Google Maps
                        googleMap.setCenter({ lat: cityArea.center.lat, lng: cityArea.center.lng });
                        googleMap.setZoom(12);
                    } else if (map) {
                        // Leaflet
                        map.setView([cityArea.center.lat, cityArea.center.lng], 12);
                    }
                    console.log('Zoomed to city:', cityArea.name);
                } else {
                    console.log('City not found:', currentCity);
                }
            }
        }

        function resetMap() {
            const coords = getCountryCoordinates(currentCountry);
            map.setView([coords.center.lat, coords.center.lng], coords.zoom);
            console.log('Reset map to:', currentCountry);
        }

        // Initialize map when page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Populate cities on initial load
            updateCityOptions();
            
            // Initialize map
            setTimeout(initMap, 1000); // Delay to ensure DOM is ready
        });
        
        // ========================================
        // REAL-TIME USER LOCATION TRACKING
        // ========================================
        
        let userMarkers = {}; // Store user markers by UID
        let userLocationInterval = null;
        
        /**
         * Start fetching and displaying user locations
         */
        function startUserLocationTracking() {
            console.log('üìç Starting real-time user location tracking...');
            
            // Fetch immediately
            fetchAndDisplayUserLocations();
            
            // Then fetch every 10 seconds
            userLocationInterval = setInterval(function() {
                fetchAndDisplayUserLocations();
            }, 10000); // 10 seconds
        }
        
        /**
         * Stop user location tracking
         */
        function stopUserLocationTracking() {
            if (userLocationInterval) {
                clearInterval(userLocationInterval);
                userLocationInterval = null;
            }
            
            // Clear all user markers
            Object.keys(userMarkers).forEach(function(uid) {
                if (userMarkers[uid] && userMarkers[uid].setMap) {
                    userMarkers[uid].setMap(null);
                }
            });
            userMarkers = {};
        }
        
        /**
         * Fetch user locations from backend and display on map
         */
        async function fetchAndDisplayUserLocations() {
            try {
                const response = await fetch('/api/google/users/online');
                const data = await response.json();
                
                if (data.success && data.users) {
                    console.log(`üìç Found ${data.users.length} online users`);
                    
                    if (mapType === 'google' && googleMap) {
                        displayUsersOnGoogleMap(data.users);
                    } else if (mapType === 'leaflet' && map) {
                        displayUsersOnLeafletMap(data.users);
                    }
                    
                    // Update stats
                    updateOnlineUserStats(data.users.length);
                }
            } catch (error) {
                console.error('Error fetching user locations:', error);
            }
        }
        
        /**
         * Display users on Google Maps
         */
        function displayUsersOnGoogleMap(users) {
            const currentUserIds = new Set(users.map(u => u.uid));
            
            // Remove markers for users that are no longer online
            Object.keys(userMarkers).forEach(function(uid) {
                if (!currentUserIds.has(uid)) {
                    if (userMarkers[uid] && userMarkers[uid].setMap) {
                        userMarkers[uid].setMap(null);
                    }
                    delete userMarkers[uid];
                }
            });
            
            // Auto-zoom to first user if this is the first load
            const isFirstUser = Object.keys(userMarkers).length === 0 && users.length > 0;
            
            // Add or update markers for current users
            users.forEach(function(user, index) {
                const position = {
                    lat: user.location.lat,
                    lng: user.location.lng
                };
                
                if (userMarkers[user.uid]) {
                    // Update existing marker position
                    userMarkers[user.uid].setPosition(position);
                } else {
                    // Create new marker with larger, more visible icon
                    // Dark green Microtiser marker with "M" label
                    const marker = new google.maps.Marker({
                        position: position,
                        map: googleMap,
                        title: user.name || 'Microtiser',
                        icon: {
                            path: google.maps.SymbolPath.CIRCLE,
                            scale: 20, // Big and visible!
                            fillColor: '#065f46', // Dark green for Microtisers
                            fillOpacity: 1.0,
                            strokeColor: '#ffffff', // White border
                            strokeWeight: 4
                        },
                        label: {
                            text: 'M',
                            color: '#ffffff',
                            fontSize: '16px',
                            fontWeight: 'bold'
                        },
                        animation: google.maps.Animation.BOUNCE,
                        zIndex: 1000
                    });
                    
                    // Stop bouncing after 2 seconds
                    setTimeout(function() {
                        marker.setAnimation(null);
                    }, 2000);
                    
                    // Add info window
                    const infoWindow = new google.maps.InfoWindow({
                        content: `
                            <div style="padding: 10px; font-family: 'Rajdhani', sans-serif;">
                                <h3 style="margin: 0 0 8px 0; color: #065f46; font-size: 16px;">
                                    <i class="fas fa-mobile-alt" style="margin-right: 5px;"></i>
                                    ${user.name || 'Microtiser'}
                                </h3>
                                <p style="margin: 4px 0; color: #666; font-size: 12px;">
                                    <i class="fas fa-circle" style="color: #065f46; font-size: 8px; margin-right: 5px;"></i>
                                    Online
                                </p>
                                <p style="margin: 4px 0; color: #666; font-size: 12px;">
                                    <i class="fas fa-clock" style="margin-right: 5px;"></i>
                                    Last seen: ${getTimeAgo(user.last_seen)}
                                </p>
                                <p style="margin: 4px 0; color: #666; font-size: 12px;">
                                    <i class="fas fa-map-marker-alt" style="margin-right: 5px;"></i>
                                    Lat: ${user.location.lat.toFixed(4)}, Lng: ${user.location.lng.toFixed(4)}
                                </p>
                            </div>
                        `
                    });
                    
                    marker.addListener('click', function() {
                        // Close all other info windows
                        Object.keys(userMarkers).forEach(function(uid) {
                            if (userMarkers[uid].infoWindow) {
                                userMarkers[uid].infoWindow.close();
                            }
                        });
                        
                        infoWindow.open(googleMap, marker);
                    });
                    
                    marker.infoWindow = infoWindow;
                    userMarkers[user.uid] = marker;
                    
                    // Auto-zoom to first user
                    if (isFirstUser && index === 0) {
                        googleMap.setCenter(position);
                        googleMap.setZoom(13); // Close zoom to see the user
                        console.log('üéØ Auto-zoomed to user:', user.name, 'at', position);
                        
                        // Auto-open the info window
                        setTimeout(function() {
                            infoWindow.open(googleMap, marker);
                        }, 2500);
                    }
                }
            });
        }
        
        /**
         * Display users on Leaflet Map (fallback)
         */
        function displayUsersOnLeafletMap(users) {
            // Check if this is the first user
            const isFirstUser = Object.keys(userMarkers).length === 0 && users.length > 0;
            
            // Remove old markers
            Object.keys(userMarkers).forEach(function(uid) {
                if (userMarkers[uid] && map.hasLayer(userMarkers[uid])) {
                    map.removeLayer(userMarkers[uid]);
                }
            });
            userMarkers = {};
            
            // Add new markers
            users.forEach(function(user, index) {
                // Create custom marker with "M" label for Microtisers
                const customIcon = L.divIcon({
                    className: 'custom-marker',
                    html: `<div style="
                        width: 36px;
                        height: 36px;
                        background-color: #065f46;
                        border: 3px solid #ffffff;
                        border-radius: 50%;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        color: #ffffff;
                        font-weight: bold;
                        font-size: 14px;
                        font-family: Arial, sans-serif;
                        box-shadow: 0 2px 8px rgba(0,0,0,0.3);
                    ">M</div>`,
                    iconSize: [36, 36],
                    iconAnchor: [18, 18]
                });
                
                const marker = L.marker([user.location.lat, user.location.lng], {
                    icon: customIcon
                }).addTo(map);
                
                marker.bindPopup(`
                    <div style="font-family: 'Rajdhani', sans-serif;">
                        <h3 style="margin: 0 0 8px 0; color: #065f46; font-size: 16px;">
                            ${user.name || 'Microtiser'}
                        </h3>
                        <p style="margin: 4px 0; color: #666; font-size: 12px;">
                            <i class="fas fa-circle" style="color: #065f46; font-size: 8px;"></i> Online
                        </p>
                        <p style="margin: 4px 0; color: #666; font-size: 12px;">
                            Last seen: ${getTimeAgo(user.last_seen)}
                        </p>
                    </div>
                `);
                
                userMarkers[user.uid] = marker;
                
                // Auto-zoom to first user
                if (isFirstUser && index === 0) {
                    map.setView([user.location.lat, user.location.lng], 13);
                    console.log('üéØ Auto-zoomed to user:', user.name);
                    
                    // Auto-open popup
                    setTimeout(function() {
                        marker.openPopup();
                    }, 500);
                }
            });
        }
        
        /**
         * Helper function to get time ago
         */
        function getTimeAgo(timestamp) {
            try {
                const now = new Date();
                const then = new Date(timestamp);
                const seconds = Math.floor((now - then) / 1000);
                
                if (seconds < 60) return 'Just now';
                if (seconds < 3600) return Math.floor(seconds / 60) + ' minutes ago';
                if (seconds < 86400) return Math.floor(seconds / 3600) + ' hours ago';
                return Math.floor(seconds / 86400) + ' days ago';
            } catch (error) {
                return 'Unknown';
            }
        }
        
        /**
         * Update online user statistics
         */
        function updateOnlineUserStats(count) {
            // Update any UI elements showing online user count
            const onlineUsersElement = document.getElementById('onlineUsersCount');
            if (onlineUsersElement) {
                onlineUsersElement.textContent = count;
            }
        }
        
        /**
         * Add demo users for testing (simulates mobile users)
         */
        async function addDemoUsers() {
            console.log('üß™ Adding demo users for testing...');
            
            // Get current country coordinates
            const countryCoords = getCountryCoordinates(currentCountry);
            
            // Demo users with realistic locations around the selected country
            const demoUsers = [
                {
                    name: 'Alice Chen',
                    lat: countryCoords.center.lat + (Math.random() - 0.5) * 0.5,
                    lng: countryCoords.center.lng + (Math.random() - 0.5) * 0.5,
                },
                {
                    name: 'Bob Smith',
                    lat: countryCoords.center.lat + (Math.random() - 0.5) * 0.5,
                    lng: countryCoords.center.lng + (Math.random() - 0.5) * 0.5,
                },
                {
                    name: 'Carol Martinez',
                    lat: countryCoords.center.lat + (Math.random() - 0.5) * 0.5,
                    lng: countryCoords.center.lng + (Math.random() - 0.5) * 0.5,
                },
                {
                    name: 'David Lee',
                    lat: countryCoords.center.lat + (Math.random() - 0.5) * 0.5,
                    lng: countryCoords.center.lng + (Math.random() - 0.5) * 0.5,
                },
                {
                    name: 'Emma Wilson',
                    lat: countryCoords.center.lat + (Math.random() - 0.5) * 0.5,
                    lng: countryCoords.center.lng + (Math.random() - 0.5) * 0.5,
                }
            ];
            
            // Send each demo user location to backend
            for (const user of demoUsers) {
                try {
                    const response = await fetch('/api/google/location', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            googleUid: 'demo_' + user.name.replace(/\s+/g, '_').toLowerCase(),
                            lat: user.lat,
                            lng: user.lng,
                            accuracy: 10,
                            timestamp: new Date().toISOString()
                        }),
                    });
                    
                    const data = await response.json();
                    if (data.success) {
                        console.log(`‚úÖ Added demo user: ${user.name}`);
                    }
                } catch (error) {
                    console.error(`‚ùå Failed to add demo user ${user.name}:`, error);
                }
            }
            
            // Also add them to GOOGLE_USERS in backend for names
            for (const user of demoUsers) {
                try {
                    await fetch('/api/google/auth', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            uid: 'demo_' + user.name.replace(/\s+/g, '_').toLowerCase(),
                            email: user.name.replace(/\s+/g, '.').toLowerCase() + '@wead-demo.com',
                            displayName: user.name,
                            photoURL: null,
                            walletAddress: null
                        }),
                    });
                } catch (error) {
                    console.error('Error registering demo user:', error);
                }
            }
            
            // Wait a moment then refresh the map
            setTimeout(function() {
                fetchAndDisplayUserLocations();
                alert('‚úÖ Added 5 demo users! They should appear on the map with green markers.');
            }, 1000);
        }

        // Test function to verify map functionality (call from browser console)
        window.testMapFunctions = function() {
            console.log('=== WeAD Map Test Results ===');

            if (typeof map === 'undefined') {
                console.error('‚ùå Map not initialized');
                return false;
            }

            console.log('‚úÖ Map object exists');

            if (map._loaded) {
                console.log('‚úÖ Map is loaded');
            } else {
                console.warn('‚ö†Ô∏è Map may not be fully loaded yet');
            }

            console.log('Current zoom:', map.getZoom());
            console.log('Current center:', map.getCenter());

            if (markers && markers.length > 0) {
                console.log('‚úÖ Markers created:', markers.length);
            } else {
                console.warn('‚ö†Ô∏è No markers found');
            }

            if (circles && circles.length > 0) {
                console.log('‚úÖ Circles created:', circles.length);
            } else {
                console.warn('‚ö†Ô∏è No circles found');
            }

            if (selectedAreas && selectedAreas.length > 0) {
                console.log('‚úÖ Selected areas:', selectedAreas.length);
            } else {
                console.log('‚ÑπÔ∏è No areas selected yet');
            }

            // Test map controls
            try {
                map.zoomIn();
                setTimeout(() => map.zoomOut(), 500);
                console.log('‚úÖ Map zoom controls working');
            } catch (e) {
                console.error('‚ùå Map zoom controls failed');
            }

            console.log('=== Test Complete ===');
            return true;
        };

        // Display Type Management Functions
        let selectedDisplayTypes = {};
        let selectedSizes = {};

        function toggleSizes(displayType) {
            const sizeDiv = document.getElementById(displayType + 'Sizes');
            const isVisible = sizeDiv.style.display !== 'none';

            // Hide all size options first
            document.querySelectorAll('.size-options').forEach(div => {
                div.style.display = 'none';
            });

            // Show the clicked one if it was hidden
            if (!isVisible) {
                sizeDiv.style.display = 'block';
            }
        }

        function updateSelectedSize(displayType, size) {
            if (size) {
                selectedSizes[displayType] = size;
                console.log('Selected size for', displayType + ':', size);

                // Update display option styling
                const option = document.querySelector(`input[id="${displayType}Displays"]`).closest('.display-option');
                if (size !== '') {
                    option.classList.add('selected');
                } else {
                    option.classList.remove('selected');
                }
            }
        }

        function updateDisplayTypes() {
            const checkboxes = document.querySelectorAll('input[type="checkbox"][id$="Displays"]');
            selectedDisplayTypes = {};

            checkboxes.forEach(checkbox => {
                if (checkbox.checked) {
                    const displayType = checkbox.value;
                    selectedDisplayTypes[displayType] = {
                        selected: true,
                        size: selectedSizes[displayType] || null
                    };

                    // Add selected class to parent option
                    checkbox.closest('.display-option').classList.add('selected');
                } else {
                    // Remove selected class
                    checkbox.closest('.display-option').classList.remove('selected');
                }
            });

            console.log('Selected display types:', selectedDisplayTypes);

            // Update campaign data
            if (typeof campaignData !== 'undefined') {
                campaignData.selectedDisplayTypes = selectedDisplayTypes;
            }

            // Update projected stats based on selected display types
            updateProjectedStats();
        }

        function getDisplayTypeStats() {
            let totalDisplays = 0;
            let totalImpressions = 0;

            Object.keys(selectedDisplayTypes).forEach(type => {
                if (selectedDisplayTypes[type].selected) {
                    // Base stats per display type (you can customize these)
                    const typeStats = {
                        car: { displays: 150, impressions: 22500 },
                        motorbike: { displays: 80, impressions: 12000 },
                        truck: { displays: 45, impressions: 18000 },
                        tuktuk: { displays: 60, impressions: 9000 },
                        clothes: { displays: 200, impressions: 30000 },
                        backpack: { displays: 120, impressions: 18000 },
                        drone: { displays: 25, impressions: 7500 },
                        mobile: { displays: 300, impressions: 45000 },
                        outdoor: { displays: 90, impressions: 27000 },
                        building: { displays: 35, impressions: 52500 }
                    };

                    if (typeStats[type]) {
                        totalDisplays += typeStats[type].displays;
                        totalImpressions += typeStats[type].impressions;
                    }
                }
            });

            return { displays: totalDisplays, impressions: totalImpressions };
        }

        // Enhanced Video Upload Handler with Backend Integration
        async function handleVideoUpload(input) {
            const file = input.files[0];
            if (file) {
                // Validate file
                if (!file.type.startsWith('video/')) {
                    showToast('Please select a valid video file', 'error');
                    return;
                }

                if (file.size > 100 * 1024 * 1024) { // 100MB limit
                    showToast('File size must be less than 100MB', 'error');
                    return;
                }

                // Show loading state
                const uploadArea = input.closest('.upload-area');
                uploadArea.innerHTML = '<div class="upload-icon"><i class="fas fa-spinner fa-spin"></i></div><div class="upload-text">Uploading video...</div>';

                try {
                    // Create campaign first if not exists
                    if (!campaignData.campaignId) {
                        await createCampaignDraft();
                    }

                    // Upload to backend
                    const token = localStorage.getItem('access_token');
                    const formData = new FormData();
                    formData.append('video', file);

                    const uploadResponse = await fetch(`/api/campaigns/${campaignData.campaignId}/upload`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        },
                        body: formData
                    });

                    if (!uploadResponse.ok) {
                        throw new Error('Upload failed');
                    }

                    const uploadData = await uploadResponse.json();

                    // Update campaign data
                    campaignData.video = file;
                    campaignData.videoUrl = uploadData.video_url;
                    campaignData.thumbnailUrl = uploadData.thumbnail_url;
                    campaignData.duration = uploadData.duration;

                    // Show preview
                const reader = new FileReader();
                reader.onload = function(e) {
                    const preview = document.getElementById('videoPreview');
                    const video = document.getElementById('previewVideo');
                    const finalPreview = document.getElementById('finalPreview');
                    
                    video.src = e.target.result;
                    finalPreview.src = e.target.result;
                    preview.style.display = 'block';
                    document.getElementById('campaignPreview').style.display = 'block';
                    
                        // Reset upload area
                        uploadArea.innerHTML = '<div class="upload-icon"><i class="fas fa-check-circle" style="color: var(--quantum-success);"></i></div><div class="upload-text">Video uploaded successfully!</div><div class="upload-subtext">MP4, AVI, MOV up to 100MB</div>';
                };
                reader.readAsDataURL(file);

                    updateCampaignProgress();
                    showToast('Video uploaded and processed successfully!', 'success');

                } catch (error) {
                    console.error('Upload error:', error);
                    showToast('Video upload failed. Please try again.', 'error');

                    // Reset upload area
                    uploadArea.innerHTML = '<div class="upload-icon"><i class="fas fa-cloud-upload-alt"></i></div><div class="upload-text">Click to upload your video</div><div class="upload-subtext">MP4, AVI, MOV up to 100MB</div><input type="file" id="videoFile" class="hidden" accept="video/*" onchange="handleVideoUpload(this)">';
                }
            }
        }

        // Create Campaign Draft
        async function createCampaignDraft() {
            try {
                const token = localStorage.getItem('access_token');
                const campaignDataToSend = {
                    name: document.getElementById('campaignName').value || 'Untitled Campaign',
                    description: document.getElementById('campaignDescription').value || '',
                    duration_days: parseInt(document.getElementById('campaignDuration').value) || 7,
                    token_per_view: parseFloat(document.getElementById('tokenPerView').value) || 0.1,
                    max_views: parseInt(document.getElementById('maxViews').value) || 1000,
                    total_budget: 0, // Will be calculated
                    target_audience: {},
                    geographic_targets: {},
                    display_types: []
                };

                const response = await fetch('/api/campaigns', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(campaignDataToSend)
                });

                if (response.ok) {
                    const data = await response.json();
                    campaignData.campaignId = data.campaign_id;
                    return data;
                } else {
                    throw new Error('Failed to create campaign draft');
                }
            } catch (error) {
                console.error('Error creating campaign draft:', error);
                throw error;
            }
        }
        
        // Payment Calculation
        function calculateOutdoorPayment() {
            const tokenPerHour = parseFloat(document.getElementById('tokenPerHour').value) || 0;
            const advertiserCount = parseInt(document.getElementById('advertiserCount').value) || 0;

            const totalPayoutHour = tokenPerHour * advertiserCount;
            const platformFee = totalPayoutHour * 0.05;
            const totalCostHour = totalPayoutHour + platformFee;

            document.getElementById('totalPayoutHour').textContent = totalPayoutHour.toFixed(2) + ' WEAD';
            document.getElementById('platformFee').textContent = platformFee.toFixed(2) + ' WEAD';
            document.getElementById('totalCostHour').textContent = totalCostHour.toFixed(2) + ' WEAD';

            campaignData.payment = {
                tokenPerHour,
                advertiserCount,
                totalPayoutHour,
                platformFee,
                totalCostHour
            };
            
            updateCampaignProgress();
            updateProjectedStats();
        }
        
        // Update Display Types
        function updateDisplayTypes() {
            const types = [];
            if (document.getElementById('carDisplays').checked) types.push('car');
            if (document.getElementById('buildingDisplays').checked) types.push('building');
            if (document.getElementById('wearableDisplays').checked) types.push('wearable');
            if (document.getElementById('foodCartDisplays').checked) types.push('foodcart');
            
            campaignData.displayTypes = types;
            updateCampaignProgress();
        }
        
        // Update Projected Statistics
        function updateProjectedStats() {
            const tokenPerHour = parseFloat(document.getElementById('tokenPerHour').value) || 0;
            const advertiserCount = parseInt(document.getElementById('advertiserCount').value) || 0;

            // Use selected areas from map for more accurate projections
            let totalAdvertisers = advertiserCount;
            let totalImpressions = 0;

            if (selectedAreas.length > 0) {
                // Calculate based on actual selected areas
                totalAdvertisers = selectedAreas.reduce((sum, area) => sum + area.advertisers, 0);
                totalImpressions = selectedAreas.reduce((sum, area) => sum + area.impressions, 0);
            } else {
                // Fallback to manual input
                totalImpressions = totalAdvertisers * 1000; // Base 1000 impressions per advertiser
            }

            // Add display type statistics if any are selected
            const displayStats = getDisplayTypeStats();
            if (displayStats.displays > 0) {
                totalAdvertisers += displayStats.displays;
                totalImpressions += displayStats.impressions;
            }

            // Calculate projections based on actual data
            const projectedReach = Math.floor(totalImpressions * 0.8);

            // Update campaign data with map selections and display types
            campaignData.selectedAreas = selectedAreas;
            campaignData.selectedDisplayTypes = selectedDisplayTypes;
            campaignData.totalAdvertisers = totalAdvertisers;
            campaignData.totalImpressions = totalImpressions;

            // Update the performance chart with new projections
            updatePerformanceChart(projectedReach);

            console.log('Updated projections:', {
                totalAdvertisers,
                totalImpressions,
                projectedReach,
                selectedDisplayTypes
            });
        }
        
        // Initialize Performance Chart
        function initializeChart() {
            console.log('Initializing chart...');
            const canvas = document.getElementById('performanceChart');
            if (!canvas) {
                console.error('Canvas element not found!');
                return;
            }
            console.log('Canvas found:', canvas);
            
            const ctx = canvas.getContext('2d');
            if (!ctx) {
                console.error('Could not get 2D context!');
                return;
            }
            console.log('2D context obtained');
            
            if (typeof Chart === 'undefined') {
                console.error('Chart.js not loaded!');
                return;
            }
            console.log('Chart.js is available');
            
            // Try simple chart first
            try {
            performanceChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['Day 1', 'Day 2', 'Day 3', 'Day 4', 'Day 5', 'Day 6', 'Day 7'],
                    datasets: [{
                            label: 'Projected Reach',
                            data: [1200, 2400, 4000, 6500, 9000, 11500, 14000],
                        borderColor: '#8B0000',
                        backgroundColor: 'rgba(139, 0, 0, 0.1)',
                        tension: 0.4,
                        fill: true
                    }, {
                            label: 'Engagement Rate (%)',
                            data: [5, 8, 12, 15, 18, 20, 22],
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            tension: 0.4,
                            fill: true
                        }, {
                            label: 'Avg View Time (seconds)',
                            data: [15, 20, 25, 30, 35, 38, 42],
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            tension: 0.4,
                            fill: true
                        }, {
                            label: 'Cost Per View ($)',
                            data: [0.05, 0.045, 0.04, 0.038, 0.035, 0.032, 0.03],
                        borderColor: '#dc143c',
                        backgroundColor: 'rgba(220, 20, 60, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'top',
                                labels: {
                                    color: '#ffffff',
                                    padding: 15,
                                    font: {
                                        size: 12
                                    }
                                }
                            },
                            tooltip: {
                                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                titleColor: '#ffffff',
                                bodyColor: '#ffffff',
                                borderColor: '#8B0000',
                                borderWidth: 1,
                                padding: 12,
                                displayColors: true
                            }
                        },
                        scales: {
                            x: {
                                ticks: {
                                    color: '#cccccc'
                                },
                                grid: {
                                    color: 'rgba(255, 255, 255, 0.1)'
                                }
                            },
                            y: {
                                ticks: {
                                    color: '#cccccc'
                                },
                                grid: {
                                    color: 'rgba(255, 255, 255, 0.1)'
                                }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Error creating chart:', error);
                // Fallback: create a simple chart
                performanceChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: ['Day 1', 'Day 2', 'Day 3', 'Day 4', 'Day 5', 'Day 6', 'Day 7'],
                        datasets: [{
                            label: 'Projected Reach',
                            data: [1200, 2400, 4000, 6500, 9000, 11500, 14000],
                            borderColor: '#8B0000',
                            backgroundColor: 'rgba(139, 0, 0, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: '#ffffff'
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: {
                                color: '#cccccc'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        },
                        y: {
                            ticks: {
                                color: '#cccccc'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        }
                    }
                }
            });
            }
            
            console.log('Chart created successfully:', performanceChart);
        }
        
        // Initialize Impression Time Chart
        function initializeImpressionTimeChart() {
            console.log('Initializing impression time chart...');
            const canvas = document.getElementById('impressionTimeChart');
            if (!canvas) {
                console.error('Impression time canvas element not found!');
                return;
            }
            
            const ctx = canvas.getContext('2d');
            if (!ctx) {
                console.error('Could not get 2D context for impression time chart!');
                return;
            }
            
            if (typeof Chart === 'undefined') {
                console.error('Chart.js not loaded!');
                return;
            }
            
            try {
                impressionTimeChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: ['12 AM', '3 AM', '6 AM', '9 AM', '12 PM', '3 PM', '6 PM', '9 PM', '12 AM'],
                        datasets: [{
                            label: 'Car Displays',
                            data: [500, 300, 800, 4500, 6000, 7500, 8000, 6500, 2000],
                            borderColor: '#8B0000',
                            backgroundColor: 'rgba(139, 0, 0, 0.1)',
                            tension: 0.4,
                            fill: true,
                            borderWidth: 2
                        }, {
                            label: 'Building Displays',
                            data: [200, 100, 500, 8000, 12000, 15000, 14000, 10000, 3000],
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            tension: 0.4,
                            fill: true,
                            borderWidth: 2
                        }, {
                            label: 'Wearable Displays',
                            data: [100, 50, 400, 2500, 3500, 4000, 3800, 2800, 800],
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            tension: 0.4,
                            fill: true,
                            borderWidth: 2
                        }, {
                            label: 'Food Cart Displays',
                            data: [50, 30, 200, 3000, 5000, 6000, 5500, 4000, 1500],
                            borderColor: '#f59e0b',
                            backgroundColor: 'rgba(245, 158, 11, 0.1)',
                            tension: 0.4,
                            fill: true,
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        aspectRatio: 2.5,
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top',
                                labels: {
                                    color: '#ffffff',
                                    font: {
                                        size: 12
                                    },
                                    padding: 15,
                                    usePointStyle: true
                                }
                            },
                            tooltip: {
                                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                titleColor: '#ffffff',
                                bodyColor: '#ffffff',
                                borderColor: '#8B0000',
                                borderWidth: 1,
                                padding: 12,
                                displayColors: true,
                                callbacks: {
                                    label: function(context) {
                                        return context.dataset.label + ': ' + context.parsed.y.toLocaleString() + ' impressions/hour';
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                ticks: {
                                    color: '#cccccc',
                                    font: {
                                        size: 11
                                    }
                                },
                                grid: {
                                    color: 'rgba(255, 255, 255, 0.1)',
                                    drawBorder: false
                                }
                            },
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    color: '#cccccc',
                                    font: {
                                        size: 11
                                    },
                                    callback: function(value) {
                                        return value.toLocaleString();
                                    }
                                },
                                grid: {
                                    color: 'rgba(255, 255, 255, 0.1)',
                                    drawBorder: false
                                },
                                title: {
                                    display: true,
                                    text: 'Impressions per Hour',
                                    color: '#ffffff',
                                    font: {
                                        size: 12,
                                        weight: 'bold'
                                    }
                                }
                            }
                        }
                    }
                });
                console.log('Impression time chart created successfully');
            } catch (error) {
                console.error('Error creating impression time chart:', error);
            }
        }
        
        // Update Performance Chart
        function updatePerformanceChart(maxViews) {
            if (performanceChart) {
                const projectedReach = [];
                const engagementRate = [];
                const avgViewTime = [];
                const costPerView = [];
                
                // Generate progressive data for 7 days
                for (let i = 1; i <= 7; i++) {
                    // Projected Reach grows progressively
                    projectedReach.push(Math.floor((maxViews / 7) * i * (0.85 + Math.random() * 0.3)));
                    
                    // Engagement Rate increases gradually (5-25%)
                    engagementRate.push(Math.floor(5 + (i * 2.5) + (Math.random() * 3)));
                    
                    // Avg View Time increases (15-45 seconds)
                    avgViewTime.push(Math.floor(15 + (i * 4) + (Math.random() * 5)));
                    
                    // Cost Per View decreases as scale increases
                    costPerView.push(parseFloat((0.05 - (i * 0.003) + (Math.random() * 0.005)).toFixed(3)));
                }
                
                performanceChart.data.datasets[0].data = projectedReach;
                performanceChart.data.datasets[1].data = engagementRate;
                performanceChart.data.datasets[2].data = avgViewTime;
                performanceChart.data.datasets[3].data = costPerView;
                performanceChart.update();
            }
        }
        
        // Switch Campaign Tabs
        function switchCampaignTab(tabName) {
            console.log('Switching to tab:', tabName);
            
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active class from all tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected tab
            const selectedTab = document.getElementById(`${tabName}-tab`);
            if (selectedTab) {
                selectedTab.classList.add('active');
            }
            
            // Find and activate the corresponding tab button
            const tabButtons = document.querySelectorAll('.tab-btn');
            tabButtons.forEach(btn => {
                const btnText = btn.textContent.toLowerCase();
                if ((tabName === 'setup' && btnText.includes('campaign setup')) ||
                    (tabName === 'display' && btnText.includes('display targeting')) ||
                    (tabName === 'location' && btnText.includes('location targeting')) ||
                    (tabName === 'review' && btnText.includes('review')) ||
                    (tabName === 'checkout' && btnText.includes('checkout')) ||
                    (tabName === 'performance' && btnText.includes('performance'))) {
                    btn.classList.add('active');
                }
            });
            
            // Initialize charts if switching to performance tab
            if (tabName === 'performance') {
                setTimeout(() => {
                    if (!performanceChart) {
                        initializeChart();
                    }
                    if (!impressionTimeChart) {
                        initializeImpressionTimeChart();
                    }
                }, 100);
            }
            
            // Invalidate map size if switching to location tab
            if (tabName === 'location') {
                setTimeout(() => {
                    if (typeof map !== 'undefined' && map) {
                        map.invalidateSize();
                        console.log('Map size invalidated for proper rendering');
                    }
                }, 100);
            }
            
            // Load review data if switching to review tab
            if (tabName === 'review') {
                populateReviewTab();
            }
            
            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });
            
            console.log('Tab switched successfully');
        }

        // ========================================
        // TAB NAVIGATION & SAVE FUNCTIONS
        // ========================================

        // Save Setup Tab Data and Continue
        async function saveSetupAndContinue() {
            try {
                // Validate required fields (silent validation)
                const campaignName = document.getElementById('campaignName').value;
                const campaignDuration = document.getElementById('campaignDuration').value;
                
                if (!campaignName) {
                    document.getElementById('campaignName').focus();
                    return;
                }
                
                if (!campaignDuration || campaignDuration < 1) {
                    document.getElementById('campaignDuration').focus();
                    return;
                }
                
                // Collect setup data
                campaignData.name = campaignName;
                campaignData.description = document.getElementById('campaignDescription').value || '';
                campaignData.targetAudience = document.getElementById('targetAudience').value || 'general';
                campaignData.durationDays = parseInt(campaignDuration);
                
                // Save to localStorage
                localStorage.setItem('weadCampaignDraft', JSON.stringify(campaignData));
                
                // Save to backend if campaign ID exists
                if (campaignData.campaignId) {
                    await saveCampaignToBackend();
                }
                
                showToast('Campaign setup saved successfully!', 'success');
                
                // Navigate to next tab
                switchCampaignTab('display');
                
            } catch (error) {
                console.error('Error saving setup:', error);
                showToast('Failed to save setup data', 'error');
            }
        }

        // Save Display Tab Data and Continue
        async function saveDisplayAndContinue() {
            try {
                // Collect display data (silent validation)
                const tokenPerHour = parseFloat(document.getElementById('tokenPerHour').value) || 0;
                const advertiserCount = parseInt(document.getElementById('advertiserCount').value) || 0;
                const campaignHours = parseInt(document.getElementById('campaignHours').value) || 0;
                
                if (tokenPerHour <= 0) {
                    document.getElementById('tokenPerHour').focus();
                    return;
                }
                
                if (advertiserCount <= 0) {
                    document.getElementById('advertiserCount').focus();
                    return;
                }
                
                // Save display targeting data
                campaignData.tokenPerHour = tokenPerHour;
                campaignData.advertiserCount = advertiserCount;
                campaignData.campaignHours = campaignHours;
                campaignData.displayTypes = getSelectedDisplayTypes();
                
                // Calculate costs
                const totalPayoutHour = tokenPerHour * advertiserCount;
                const platformFee = totalPayoutHour * 0.05;
                const totalCostHour = totalPayoutHour + platformFee;
                
                campaignData.totalCost = campaignHours > 0 ? totalCostHour * campaignHours : totalCostHour;
                campaignData.totalBudget = campaignData.totalCost;
                
                // Save to localStorage
                localStorage.setItem('weadCampaignDraft', JSON.stringify(campaignData));
                
                // Save to backend
                if (campaignData.campaignId) {
                    await saveCampaignToBackend();
                }
                
                showToast('Display targeting saved successfully!', 'success');
                
                // Navigate to next tab
                switchCampaignTab('location');
                
            } catch (error) {
                console.error('Error saving display data:', error);
                showToast('Failed to save display data', 'error');
            }
        }

        // Save Location Tab Data and Continue
        async function saveLocationAndContinue() {
            try {
                // Collect location data
                campaignData.selectedAreas = selectedAreas || [];
                campaignData.selectedCountry = document.getElementById('countrySelect').value;
                
                if (campaignData.selectedAreas.length === 0) {
                    const confirmContinue = confirm('You haven\'t selected any specific locations. Continue with general targeting?');
                    if (!confirmContinue) {
                        return;
                    }
                }
                
                // Calculate total reach based on selected areas
                campaignData.estimatedReach = campaignData.selectedAreas.reduce((sum, area) => sum + (area.advertisers || 0), 0);
                campaignData.estimatedImpressions = campaignData.selectedAreas.reduce((sum, area) => sum + (area.impressions || 0), 0);
                
                // Save to localStorage
                localStorage.setItem('weadCampaignDraft', JSON.stringify(campaignData));
                
                // Save to backend
                if (campaignData.campaignId) {
                    await saveCampaignToBackend();
                }
                
                showToast('Location targeting saved successfully!', 'success');
                
                // Navigate to review tab (next in sequence)
                switchCampaignTab('review');
                
            } catch (error) {
                console.error('Error saving location data:', error);
                showToast('Failed to save location data', 'error');
            }
        }

        // Proceed to Checkout
        function proceedToCheckout() {
            // Comprehensive validation - prevent checkout until all forms are completed
            
            // Check Campaign Setup
            if (!campaignData.name || !campaignData.durationDays) {
                switchCampaignTab('setup');
                document.getElementById('campaignName').focus();
                return;
            }
            
            // Check Display Targeting
            if (!campaignData.tokenPerHour || campaignData.tokenPerHour <= 0 || 
                !campaignData.advertiserCount || campaignData.advertiserCount <= 0) {
                switchCampaignTab('display');
                if (!campaignData.tokenPerHour || campaignData.tokenPerHour <= 0) {
                    document.getElementById('tokenPerHour').focus();
                } else {
                    document.getElementById('advertiserCount').focus();
                }
                return;
            }
            
            // Check if display types are selected
            if (!campaignData.displayTypes || campaignData.displayTypes.length === 0) {
                switchCampaignTab('display');
                return;
            }
            
            // All validation passed - proceed to checkout
            localStorage.setItem('weadCampaignDraft', JSON.stringify(campaignData));
            
            // Calculate final costs
            calculateFinalCosts();
            
            // Navigate to checkout
            switchCampaignTab('checkout');
            
            showToast('Ready for payment!', 'info');
        }

        // Launch Campaign Final
        async function launchCampaignFinal() {
            try {
                if (!campaignData.campaignId) {
                    showToast('Please complete all steps first', 'error');
                    return;
                }
                
                const confirmLaunch = confirm(`Launch campaign "${campaignData.name}"?\n\nTotal Cost: ${campaignData.totalCost} WEAD\n\nThis will start your campaign immediately.`);
                
                if (!confirmLaunch) {
                    return;
                }
                
                // Launch campaign via API
                const token = localStorage.getItem('access_token');
                const response = await fetch(`/api/campaigns/${campaignData.campaignId}/launch`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(campaignData)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    
                    // Clear draft data
                    localStorage.removeItem('weadCampaignDraft');
                    
                    // Show success message
                    showToast('Campaign launched successfully!', 'success');
                    
                    // Redirect to analytics page after 2 seconds
                    setTimeout(() => {
                        window.location.href = '/campaigns';
                    }, 2000);
                    
                } else {
                    throw new Error('Failed to launch campaign');
                }
                
            } catch (error) {
                console.error('Error launching campaign:', error);
                showToast('Failed to launch campaign. Please try again.', 'error');
            }
        }

        // Helper: Get Selected Display Types
        function getSelectedDisplayTypes() {
            const types = [];
            const displayCheckboxes = document.querySelectorAll('[id$="Displays"]');
            
            displayCheckboxes.forEach(checkbox => {
                if (checkbox.checked) {
                    const type = checkbox.id.replace('Displays', '').toLowerCase();
                    const sizeSelect = document.getElementById(`${checkbox.value}Sizes`);
                    const selectedSize = sizeSelect ? sizeSelect.querySelector('select')?.value : null;
                    
                    types.push({
                        type: type,
                        value: checkbox.value,
                        size: selectedSize
                    });
                }
            });
            
            return types;
        }

        // Helper: Save Campaign to Backend
        async function saveCampaignToBackend() {
            try {
                const token = localStorage.getItem('access_token');
                if (!token) {
                    console.log('No auth token, skipping backend save');
                    return;
                }
                
                const response = await fetch(`/api/campaigns/${campaignData.campaignId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(campaignData)
                });
                
                if (!response.ok) {
                    console.error('Backend save failed');
                }
                
            } catch (error) {
                console.error('Error saving to backend:', error);
            }
        }

        // Helper: Calculate Final Costs
        function calculateFinalCosts() {
            const hours = campaignData.campaignHours || 8;
            const costPerHour = campaignData.tokenPerHour * campaignData.advertiserCount;
            const platformFee = costPerHour * 0.05;
            
            campaignData.subtotal = costPerHour * hours;
            campaignData.platformFee = platformFee * hours;
            campaignData.totalCost = campaignData.subtotal + campaignData.platformFee;
            
            // Update checkout display
            document.getElementById('checkoutSubtotal').textContent = `${campaignData.subtotal.toFixed(2)} WEAD`;
            document.getElementById('checkoutPlatformFee').textContent = `${campaignData.platformFee.toFixed(2)} WEAD`;
            document.getElementById('checkoutTotal').textContent = `${campaignData.totalCost.toFixed(2)} WEAD`;
        }

        // Populate Review Tab
        function populateReviewTab() {
            // Campaign Details
            document.getElementById('reviewCampaignName').textContent = campaignData.name || 'Untitled Campaign';
            document.getElementById('reviewDescription').textContent = campaignData.description || 'No description';
            document.getElementById('reviewDuration').textContent = `${campaignData.durationDays || 0} days`;
            document.getElementById('reviewAudience').textContent = campaignData.targetAudience || 'General';
            
            // Display Details
            document.getElementById('reviewTokenPerHour').textContent = `${campaignData.tokenPerHour || 0} WEAD`;
            document.getElementById('reviewAdvertisers').textContent = campaignData.advertiserCount || 0;
            document.getElementById('reviewHours').textContent = campaignData.campaignHours || 0;
            
            // Display Types
            const displayTypesList = document.getElementById('reviewDisplayTypes');
            if (campaignData.displayTypes && campaignData.displayTypes.length > 0) {
                displayTypesList.innerHTML = campaignData.displayTypes.map(dt => 
                    `<div class="area-tag">${dt.type} ${dt.size ? `(${dt.size})` : ''}</div>`
                ).join('');
            } else {
                displayTypesList.innerHTML = '<p>No specific display types selected</p>';
            }
            
            // Location Details
            const locationsList = document.getElementById('reviewLocations');
            if (campaignData.selectedAreas && campaignData.selectedAreas.length > 0) {
                locationsList.innerHTML = campaignData.selectedAreas.map(area => 
                    `<div class="area-tag">${area.name || area.city} - ${area.advertisers} advertisers</div>`
                ).join('');
            } else {
                locationsList.innerHTML = '<p>General location targeting</p>';
            }
            
            // Cost Summary
            document.getElementById('reviewCostPerHour').textContent = `${(campaignData.tokenPerHour * campaignData.advertiserCount).toFixed(2)} WEAD`;
            document.getElementById('reviewTotalCost').textContent = `${campaignData.totalCost?.toFixed(2) || '0.00'} WEAD`;
            
            // Projected Results
            document.getElementById('reviewEstimatedReach').textContent = (campaignData.estimatedReach || 0).toLocaleString();
            document.getElementById('reviewEstimatedImpressions').textContent = (campaignData.estimatedImpressions || 0).toLocaleString();
        }

        // Load Draft on Page Load
        document.addEventListener('DOMContentLoaded', function() {
            // Try to load draft from localStorage
            const draftData = localStorage.getItem('weadCampaignDraft');
            if (draftData) {
                try {
                    const draft = JSON.parse(draftData);
                    Object.assign(campaignData, draft);
                    
                    // Populate form fields with draft data
                    if (campaignData.name) document.getElementById('campaignName').value = campaignData.name;
                    if (campaignData.description) document.getElementById('campaignDescription').value = campaignData.description;
                    if (campaignData.targetAudience) document.getElementById('targetAudience').value = campaignData.targetAudience;
                    if (campaignData.durationDays) document.getElementById('campaignDuration').value = campaignData.durationDays;
                    if (campaignData.tokenPerHour) document.getElementById('tokenPerHour').value = campaignData.tokenPerHour;
                    if (campaignData.advertiserCount) document.getElementById('advertiserCount').value = campaignData.advertiserCount;
                    if (campaignData.campaignHours) document.getElementById('campaignHours').value = campaignData.campaignHours;
                    
                    console.log('Draft data loaded successfully');
                } catch (error) {
                    console.error('Error loading draft:', error);
                }
            }
        });
        
        // Update Campaign Progress
        function updateCampaignProgress() {
            let progress = 0;
            let completedSteps = 0;
            const totalSteps = 6;
            
            // Check completion criteria
            if (walletConnected || currentUser) {
                completedSteps++;
            }
            
            const campaignNameEl = document.getElementById('campaignName');
            if (campaignNameEl && campaignNameEl.value) {
                completedSteps++;
            }
            
            if (campaignData.video) {
                completedSteps++;
            }
            
            const tokenPerViewEl = document.getElementById('tokenPerView');
            if (tokenPerViewEl && tokenPerViewEl.value) {
                completedSteps++;
            }
            
            const targetAudienceEl = document.getElementById('targetAudience');
            if (targetAudienceEl && targetAudienceEl.value) {
                completedSteps++;
            }
            
            if (campaignData.displayTypes && campaignData.displayTypes.length > 0) {
                completedSteps++;
            }
            
            progress = (completedSteps / totalSteps) * 100;
            
            document.getElementById('campaignProgress').style.width = progress + '%';
            document.getElementById('progressText').textContent = Math.round(progress) + '%';
            
            // Update completion percentage in launch tab
            const completionPercentage = document.getElementById('completionPercentage');
            const progressFill = document.getElementById('progressFill');
            if (completionPercentage) {
                completionPercentage.textContent = Math.round(progress) + '%';
            }
            if (progressFill) {
                progressFill.style.width = progress + '%';
            }
            
            // Enable launch button if progress is 100%
            const launchBtn = document.getElementById('launchBtn');
            if (progress === 100) {
                launchBtn.disabled = false;
                launchBtn.style.opacity = '1';
            } else {
                launchBtn.disabled = true;
                launchBtn.style.opacity = '0.5';
            }
        }
        
        // Save Campaign as Draft
        function saveDraft() {
            console.log('Saving campaign as draft...');
            showToast('Campaign saved as draft!', 'success');
            
            // Store campaign data in localStorage
            localStorage.setItem('draftCampaign', JSON.stringify(campaignData));
        }
        
        
        // Preview Campaign
        function previewCampaign() {
            const name = document.getElementById('campaignName').value;
            const duration = document.getElementById('campaignDuration').value;
            const tokenPerView = document.getElementById('tokenPerView').value;
            const audience = document.getElementById('targetAudience').value;
            
            document.getElementById('previewName').textContent = name || 'Untitled Campaign';
            document.getElementById('previewDuration').textContent = duration ? duration + ' days' : 'Not set';
            document.getElementById('previewPayment').textContent = tokenPerView ? tokenPerView + ' WEAD' : 'Not set';
            document.getElementById('previewAudience').textContent = audience || 'Not selected';
            
            // Scroll to preview section
            document.querySelector('.campaign-preview').scrollIntoView({ behavior: 'smooth' });
            showToast('Campaign preview updated!', 'success');
        }
        
        // Save Draft
        function saveDraft() {
            const draftData = {
                name: document.getElementById('campaignName').value,
                description: document.getElementById('campaignDescription').value,
                audience: document.getElementById('targetAudience').value,
                duration: document.getElementById('campaignDuration').value,
                tokenPerView: document.getElementById('tokenPerView').value,
                maxViews: document.getElementById('maxViews').value,
                country: document.getElementById('targetCountry').value,
                city: document.getElementById('targetCity').value,
                displayTypes: campaignData.displayTypes,
                timestamp: new Date().toISOString()
            };
            
            localStorage.setItem('weadCampaignDraft', JSON.stringify(draftData));
            showToast('Campaign saved as draft!', 'success');
        }
        
        // Enhanced Launch Campaign with Backend Integration
        async function launchCampaign() {
            console.log('üöÄ Launch Campaign button clicked!');
            console.log('Campaign Data:', campaignData);
            
            if (!walletConnected && !currentUser) {
                showToast('Please connect MetaMask wallet first!', 'error');
                alert('‚ö†Ô∏è Wallet Not Connected\n\nPlease click "Connect MetaMask" in the header first.');
                return;
            }

            if (!campaignData.campaignId) {
                showToast('Please create a campaign draft first', 'error');
                alert('‚ö†Ô∏è No Campaign Draft\n\nPlease complete all campaign steps (Basic Info, Display Types, Location, Review) before proceeding to checkout.');
                return;
            }
            
            // Get budget from campaign data (should be calculated in review step)
            const campaignBudget = parseFloat(campaignData.totalCost || campaignData.totalBudget || 0);
            
            console.log('üí∞ Checking budget:', { 
                totalCost: campaignData.totalCost, 
                totalBudget: campaignData.totalBudget, 
                campaignBudget: campaignBudget 
            });
            
            if (!campaignBudget || campaignBudget <= 0) {
                showToast('Campaign budget is not set. Please complete the campaign setup first.', 'error');
                alert(`‚ö†Ô∏è Budget Not Calculated\n\nTotal Cost: ${campaignData.totalCost || 'Not set'}\nTotal Budget: ${campaignData.totalBudget || 'Not set'}\n\nPlease go back to the Review tab and make sure the total cost is calculated.`);
                console.error('Budget error:', { campaignBudget, campaignData });
                return;
            }
            
            console.log('üí∞ Campaign Budget:', campaignBudget, 'WEAD');
            
            const launchBtn = document.getElementById('checkoutBtn');
            const originalHtml = launchBtn.innerHTML;
            
            try {
                // Step 1: Check MetaMask connection
                if (!window.ethereum) {
                    throw new Error('MetaMask is not installed!');
                }
                
                const accounts = await window.ethereum.request({ method: 'eth_accounts' });
                if (accounts.length === 0) {
                    throw new Error('Please connect your MetaMask wallet first!');
                }
                
                const userAddress = accounts[0];
                
                // Step 2: Switch to BSC Network if needed
                launchBtn.innerHTML = '<div class="loading"></div> Checking network...';
            launchBtn.disabled = true;
            
            try {
                    await window.ethereum.request({
                        method: 'wallet_switchEthereumChain',
                        params: [{ chainId: window.WEAD_CONFIG.BSC_CONFIG.chainId }],
                    });
                } catch (switchError) {
                    if (switchError.code === 4902) {
                        await window.ethereum.request({
                            method: 'wallet_addEthereumChain',
                            params: [window.WEAD_CONFIG.BSC_CONFIG],
                        });
                    } else {
                        throw switchError;
                    }
                }
                
                // Step 3: Prepare payment amount (convert WEAD to Wei)
                launchBtn.innerHTML = '<div class="loading"></div> Preparing payment...';
                
                const weadAmountInWei = window.ethereum.utils?.toWei?.(campaignBudget.toString(), 'ether') || 
                                       (BigInt(Math.floor(campaignBudget * 1e18))).toString();
                
                // WEAD Token Contract Address on BSC Testnet
                const WEAD_TOKEN_ADDRESS = '0xCF99bF2cbD83A580437d39A5092C1665Faa9898B'; // WEAD Token on BSC Testnet
                const PLATFORM_WALLET = '0x01d3829a1b0CA3E1390724a0C5C419435720431e'; // WeAD Platform Wallet
                
                // Step 4: Request payment approval
                launchBtn.innerHTML = '<div class="loading"></div> Requesting payment approval...';
                showToast(`Please approve ${campaignBudget} WEAD tokens in MetaMask`, 'info');
                
                // ERC20 Transfer function signature
                const transferData = window.ethereum.request({
                    method: 'eth_sendTransaction',
                    params: [{
                        from: userAddress,
                        to: WEAD_TOKEN_ADDRESS,
                        data: `0xa9059cbb${PLATFORM_WALLET.slice(2).padStart(64, '0')}${weadAmountInWei.slice(2).padStart(64, '0')}`,
                        gas: '0x5208', // 21000 in hex
                    }],
                });
                
                launchBtn.innerHTML = '<div class="loading"></div> Processing payment...';
                
                const txHash = await transferData;
                
                showToast('Payment transaction sent! Waiting for confirmation...', 'info');
                
                // Step 5: Wait for transaction confirmation
                launchBtn.innerHTML = '<div class="loading"></div> Confirming transaction...';
                
                let receipt = null;
                let attempts = 0;
                while (!receipt && attempts < 30) {
                    try {
                        receipt = await window.ethereum.request({
                            method: 'eth_getTransactionReceipt',
                            params: [txHash],
                        });
                        if (!receipt) {
                            await new Promise(resolve => setTimeout(resolve, 2000));
                            attempts++;
                        }
                    } catch (e) {
                        await new Promise(resolve => setTimeout(resolve, 2000));
                        attempts++;
                    }
                }
                
                if (!receipt || receipt.status !== '0x1') {
                    throw new Error('Transaction failed or was not confirmed');
                }
                
                showToast('Payment confirmed! Launching campaign...', 'success');
                
                // Step 6: Launch campaign via API with transaction hash
                launchBtn.innerHTML = '<div class="loading"></div> Launching campaign...';
                
                const token = localStorage.getItem('access_token');
                const launchResponse = await fetch(`/api/campaigns/${campaignData.campaignId}/launch`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        transactionHash: txHash,
                        amount: campaignBudget,
                        walletAddress: userAddress
                    })
                });

                if (!launchResponse.ok) {
                    throw new Error('Campaign launch API failed');
                }

                const launchData = await launchResponse.json();

                showToast('üéâ Campaign launched successfully!', 'success');
                
                launchBtn.innerHTML = '<i class="fas fa-check"></i> Campaign Launched!';
                launchBtn.style.background = 'linear-gradient(135deg, #22c55e, #16a34a)';

                // Refresh WEAD balance across all pages
                if (window.refreshAllBalances) {
                    await window.refreshAllBalances();
                }

                // Update stats
                await loadUserCampaigns();
                
                // Show success message with transaction details
                setTimeout(() => {
                    if (confirm(`Campaign launched successfully!\n\nTransaction Hash: ${txHash.slice(0, 10)}...${txHash.slice(-8)}\nAmount: ${campaignBudget} WEAD\n\nYour WEAD balance has been updated.\n\nWould you like to create another campaign?`)) {
                        location.reload();
                    } else {
                        // Redirect to analytics page
                        window.location.href = '/campaigns';
                    }
                }, 2000);

            } catch (error) {
                console.error('Launch error:', error);
                
                let errorMessage = 'Campaign launch failed. ';
                if (error.message.includes('User rejected')) {
                    errorMessage += 'Transaction was rejected.';
                } else if (error.message.includes('insufficient funds')) {
                    errorMessage += 'Insufficient WEAD tokens in wallet.';
                } else if (error.message.includes('MetaMask')) {
                    errorMessage += error.message;
                } else {
                    errorMessage += 'Please try again.';
                }
                
                showToast(errorMessage, 'error');

                // Reset button
                launchBtn.innerHTML = originalHtml;
                launchBtn.disabled = false;
            }
        }

        // View Campaign Analytics
        async function viewCampaignAnalytics(campaignId) {
            try {
                const token = localStorage.getItem('access_token');

                const response = await fetch(`/api/analytics/${campaignId}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();

                    // Update analytics display (you would implement a modal or dedicated analytics page)
                    showToast(`Analytics loaded for campaign ${campaignId}`, 'success');

                    // For now, just log the data
                    console.log('Campaign Analytics:', data);
                } else {
                    showToast('Failed to load analytics', 'error');
                }
            } catch (error) {
                console.error('Analytics error:', error);
                showToast('Failed to load analytics', 'error');
            }
        }

        // Pause/Resume Campaign
        async function pauseCampaign(campaignId) {
            try {
                const token = localStorage.getItem('access_token');

                // This would be a PATCH request to update campaign status
                const response = await fetch(`/api/campaigns/${campaignId}`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        action: 'toggle_pause'
                    })
                });

                if (response.ok) {
                    showToast('Campaign status updated successfully', 'success');
                    await loadUserCampaigns(); // Refresh campaigns
                } else {
                    showToast('Failed to update campaign status', 'error');
                }
            } catch (error) {
                console.error('Pause campaign error:', error);
                showToast('Failed to update campaign status', 'error');
            }
        }

        // Load Micro-advertisers for Location Targeting
        async function loadMicroAdvertisers() {
            try {
                const token = localStorage.getItem('access_token');
                const country = document.getElementById('targetCountry').value;
                const deviceType = document.getElementById('timeSchedule').value; // Using this as proxy

                let url = '/api/micro-advertisers?status=online';
                if (country && country !== 'global') {
                    url += `&country=${encodeURIComponent(country)}`;
                }
                if (deviceType) {
                    url += `&device_type=${encodeURIComponent(deviceType)}`;
                }

                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.ok) {
                    const advertisers = await response.json();

                    // Update available advertisers count
                    document.getElementById('availableAdvertisers').textContent = advertisers.length;

                    // Store for campaign creation
                    campaignData.availableAdvertisers = advertisers;

                    showToast(`Found ${advertisers.length} available micro-advertisers`, 'success');
                }
            } catch (error) {
                console.error('Error loading micro-advertisers:', error);
            }
        }
        
        // Page Info Function
        function showPageInfo() {
            const modal = document.getElementById('tab-info-modal');
            const content = document.getElementById('tab-info-content');
            
            content.innerHTML = `
                <div style="text-align: center; margin-bottom: 1.5rem;">
                    <div style="display: inline-flex; align-items: center; justify-content: center; width: 60px; height: 60px; background: linear-gradient(135deg, #8B0000, #5c0000); border-radius: 50%; margin-bottom: 1rem;">
                        <i class="fas fa-bullhorn" style="font-size: 1.8rem; color: white;"></i>
                    </div>
                    <h2 style="color: #8B0000; margin: 0; font-size: 1.8rem;">Campaign Creation Guide</h2>
                </div>
                <div style="color: var(--text-secondary); font-family: 'Merriweather', Georgia, serif; line-height: 1.8; font-size: 1rem;">
                    <p style="margin-bottom: 1.5rem;">Create powerful micro-advertising campaigns in 6 simple steps. Follow the tabs from left to right to set up your campaign.</p>
                    
                    <h4 style="color: #8B0000; margin-top: 1.5rem; margin-bottom: 0.75rem;">üìã Campaign Creation Steps:</h4>
                    <ol style="padding-left: 1.5rem; margin: 0;">
                        <li style="margin-bottom: 1rem;">
                            <strong style="color: white;">Campaign Setup</strong> - Upload your video ad and set basic campaign details
                        </li>
                        <li style="margin-bottom: 1rem;">
                            <strong style="color: white;">Display Targeting</strong> - Choose display types and set payout rates
                        </li>
                        <li style="margin-bottom: 1rem;">
                            <strong style="color: white;">Location Targeting</strong> - Select geographic areas for your campaign
                        </li>
                        <li style="margin-bottom: 1rem;">
                            <strong style="color: white;">Review</strong> - Review all campaign details and save as draft
                        </li>
                        <li style="margin-bottom: 1rem;">
                            <strong style="color: white;">Checkout</strong> - Complete payment with WEAD tokens via MetaMask
                        </li>
                        <li style="margin-bottom: 1rem;">
                            <strong style="color: white;">Performance</strong> - View projected metrics and industry benchmarks
                        </li>
                    </ol>
                    
                    <h4 style="color: #8B0000; margin-top: 1.5rem; margin-bottom: 0.75rem;">üí° Quick Tips:</h4>
                    <ul style="list-style: none; padding: 0; margin: 0;">
                        <li style="margin-bottom: 0.75rem; display: flex; gap: 0.75rem;">
                            <i class="fas fa-check" style="color: #8B0000; margin-top: 0.25rem;"></i>
                            <span>Higher payout = more micro-advertisers displaying your ads</span>
                        </li>
                        <li style="margin-bottom: 0.75rem; display: flex; gap: 0.75rem;">
                            <i class="fas fa-check" style="color: #8B0000; margin-top: 0.25rem;"></i>
                            <span>Target high-density areas for maximum reach and impressions</span>
                        </li>
                        <li style="margin-bottom: 0.75rem; display: flex; gap: 0.75rem;">
                            <i class="fas fa-check" style="color: #8B0000; margin-top: 0.25rem;"></i>
                            <span>Video quality directly affects engagement rate</span>
                        </li>
                        <li style="margin-bottom: 0; display: flex; gap: 0.75rem;">
                            <i class="fas fa-check" style="color: #8B0000; margin-top: 0.25rem;"></i>
                            <span>All transactions are blockchain-verified for transparency</span>
                        </li>
                    </ul>
                </div>
            `;
            modal.style.display = 'flex';
        }
        
        // Tab Info Modal Functions
        const tabInfoContent = {
            setup: {
                title: 'Campaign Setup',
                icon: 'fas fa-rocket',
                content: `
                    <p style="margin-bottom: 1rem;">Upload your video ad and configure the basic details of your campaign.</p>
                    <h4 style="color: #8B0000; margin-top: 1.5rem; margin-bottom: 0.75rem;">What You'll Do:</h4>
                    <ul style="list-style: none; padding: 0; margin: 0;">
                        <li style="margin-bottom: 0.75rem; display: flex; gap: 0.75rem;">
                            <i class="fas fa-video" style="color: #8B0000; margin-top: 0.25rem;"></i>
                            <span><strong>Upload Video:</strong> Choose your advertising video (MP4, AVI, MOV up to 100MB)</span>
                        </li>
                        <li style="margin-bottom: 0.75rem; display: flex; gap: 0.75rem;">
                            <i class="fas fa-edit" style="color: #8B0000; margin-top: 0.25rem;"></i>
                            <span><strong>Campaign Details:</strong> Set campaign name, description, and target audience</span>
                        </li>
                        <li style="margin-bottom: 0.75rem; display: flex; gap: 0.75rem;">
                            <i class="fas fa-dollar-sign" style="color: #8B0000; margin-top: 0.25rem;"></i>
                            <span><strong>Budget & Duration:</strong> Define your total budget in WEAD tokens and campaign duration</span>
                        </li>
                        <li style="margin-bottom: 0.75rem; display: flex; gap: 0.75rem;">
                            <i class="fas fa-wallet" style="color: #8B0000; margin-top: 0.25rem;"></i>
                            <span><strong>Connect Wallet:</strong> Ensure your MetaMask wallet is connected with sufficient WEAD tokens on BSC Network</span>
                        </li>
                    </ul>
                `
            },
            display: {
                title: 'Display Targeting',
                icon: 'fas fa-tv',
                content: `
                    <p style="margin-bottom: 1rem;">Choose which types of displays will show your ads and set payout rates.</p>
                    <h4 style="color: #8B0000; margin-top: 1.5rem; margin-bottom: 0.75rem;">Display Types:</h4>
                    <ul style="list-style: none; padding: 0; margin: 0;">
                        <li style="margin-bottom: 0.75rem; display: flex; gap: 0.75rem;">
                            <span style="font-size: 1.5rem;">üöó</span>
                            <span><strong>Car Displays:</strong> Mobile advertising on vehicle rooftops (5K-10K impressions/hour)</span>
                        </li>
                        <li style="margin-bottom: 0.75rem; display: flex; gap: 0.75rem;">
                            <span style="font-size: 1.5rem;">üè¢</span>
                            <span><strong>Building Displays:</strong> Static displays in stores, hotels, offices (10K-20K impressions/hour)</span>
                        </li>
                        <li style="margin-bottom: 0.75rem; display: flex; gap: 0.75rem;">
                            <span style="font-size: 1.5rem;">üéí</span>
                            <span><strong>Wearable Displays:</strong> Backpacks, clothing, accessories (2K-5K impressions/hour)</span>
                        </li>
                        <li style="margin-bottom: 0.75rem; display: flex; gap: 0.75rem;">
                            <span style="font-size: 1.5rem;">üçï</span>
                            <span><strong>Food Cart Displays:</strong> Mobile vendors and street carts (3K-8K impressions/hour)</span>
                        </li>
                    </ul>
                    <h4 style="color: #8B0000; margin-top: 1.5rem; margin-bottom: 0.75rem;">üí° Tip:</h4>
                    <p style="margin: 0;">Higher payout per hour attracts more micro-advertisers to display your ads!</p>
                `
            },
            location: {
                title: 'Location Targeting',
                icon: 'fas fa-map-marked-alt',
                content: `
                    <p style="margin-bottom: 1rem;">Select specific geographic areas where you want your ads to be displayed.</p>
                    <h4 style="color: #8B0000; margin-top: 1.5rem; margin-bottom: 0.75rem;">How It Works:</h4>
                    <ul style="list-style: none; padding: 0; margin: 0;">
                        <li style="margin-bottom: 0.75rem; display: flex; gap: 0.75rem;">
                            <i class="fas fa-globe" style="color: #8B0000; margin-top: 0.25rem;"></i>
                            <span><strong>Select Countries:</strong> Choose target countries from the dropdown menu</span>
                        </li>
                        <li style="margin-bottom: 0.75rem; display: flex; gap: 0.75rem;">
                            <i class="fas fa-city" style="color: #8B0000; margin-top: 0.25rem;"></i>
                            <span><strong>Choose Cities:</strong> Pick specific cities or regions within your selected countries</span>
                        </li>
                        <li style="margin-bottom: 0.75rem; display: flex; gap: 0.75rem;">
                            <i class="fas fa-map-marker-alt" style="color: #8B0000; margin-top: 0.25rem;"></i>
                            <span><strong>Interactive Map:</strong> Tap on areas on the map to select high-traffic zones</span>
                        </li>
                        <li style="margin-bottom: 0.75rem; display: flex; gap: 0.75rem;">
                            <i class="fas fa-chart-bar" style="color: #8B0000; margin-top: 0.25rem;"></i>
                            <span><strong>View Density:</strong> Check the heat map to see micro-advertiser density in each area</span>
                        </li>
                    </ul>
                    <h4 style="color: #8B0000; margin-top: 1.5rem; margin-bottom: 0.75rem;">üí° Tip:</h4>
                    <p style="margin: 0;">Target high-density areas (shown in dark red) for maximum reach and impressions!</p>
                `
            },
            review: {
                title: 'Review Your Campaign',
                icon: 'fas fa-clipboard-check',
                content: `
                    <p style="margin-bottom: 1rem;">Review all campaign details before proceeding to checkout.</p>
                    <h4 style="color: #8B0000; margin-top: 1.5rem; margin-bottom: 0.75rem;">What You'll See:</h4>
                    <ul style="list-style: none; padding: 0; margin: 0;">
                        <li style="margin-bottom: 0.75rem; display: flex; gap: 0.75rem;">
                            <i class="fas fa-check-circle" style="color: #8B0000; margin-top: 0.25rem;"></i>
                            <span><strong>Completion Progress:</strong> See how much of your campaign setup is complete</span>
                        </li>
                        <li style="margin-bottom: 0.75rem; display: flex; gap: 0.75rem;">
                            <i class="fas fa-list-ul" style="color: #8B0000; margin-top: 0.25rem;"></i>
                            <span><strong>Campaign Summary:</strong> Review all details including video, budget, targeting, and duration</span>
                        </li>
                        <li style="margin-bottom: 0.75rem; display: flex; gap: 0.75rem;">
                            <i class="fas fa-save" style="color: #8B0000; margin-top: 0.25rem;"></i>
                            <span><strong>Save as Draft:</strong> Save your progress and come back later to finish</span>
                        </li>
                        <li style="margin-bottom: 0.75rem; display: flex; gap: 0.75rem;">
                            <i class="fas fa-arrow-right" style="color: #8B0000; margin-top: 0.25rem;"></i>
                            <span><strong>Proceed to Checkout:</strong> Move to payment when everything looks good</span>
                        </li>
                    </ul>
                `
            },
            checkout: {
                title: 'Checkout & Payment',
                icon: 'fas fa-shopping-cart',
                content: `
                    <p style="margin-bottom: 1rem;">Complete payment using WEAD tokens to launch your campaign.</p>
                    <h4 style="color: #8B0000; margin-top: 1.5rem; margin-bottom: 0.75rem;">Payment Process:</h4>
                    <ul style="list-style: none; padding: 0; margin: 0;">
                        <li style="margin-bottom: 0.75rem; display: flex; gap: 0.75rem;">
                            <i class="fas fa-file-invoice-dollar" style="color: #8B0000; margin-top: 0.25rem;"></i>
                            <span><strong>Order Summary:</strong> Review campaign details and total cost breakdown</span>
                        </li>
                        <li style="margin-bottom: 0.75rem; display: flex; gap: 0.75rem;">
                            <i class="fas fa-wallet" style="color: #8B0000; margin-top: 0.25rem;"></i>
                            <span><strong>MetaMask Payment:</strong> Confirm transaction in your MetaMask wallet</span>
                        </li>
                        <li style="margin-bottom: 0.75rem; display: flex; gap: 0.75rem;">
                            <i class="fas fa-network-wired" style="color: #8B0000; margin-top: 0.25rem;"></i>
                            <span><strong>BSC Network:</strong> Transaction is processed on Binance Smart Chain</span>
                        </li>
                        <li style="margin-bottom: 0.75rem; display: flex; gap: 0.75rem;">
                            <i class="fas fa-rocket" style="color: #8B0000; margin-top: 0.25rem;"></i>
                            <span><strong>Launch Campaign:</strong> Your campaign goes live after payment confirmation</span>
                        </li>
                    </ul>
                    <h4 style="color: #8B0000; margin-top: 1.5rem; margin-bottom: 0.75rem;">‚ö†Ô∏è Important:</h4>
                    <p style="margin: 0;">Ensure you have sufficient WEAD tokens in your wallet. Campaigns cannot be modified once launched. All transactions are recorded on the blockchain for transparency.</p>
                `
            },
            performance: {
                title: 'Performance Projections',
                icon: 'fas fa-chart-line',
                content: `
                    <p style="margin-bottom: 1rem;">View projected performance metrics and industry benchmarks to plan your campaign.</p>
                    <h4 style="color: #8B0000; margin-top: 1.5rem; margin-bottom: 0.75rem;">What You'll See:</h4>
                    <ul style="list-style: none; padding: 0; margin: 0;">
                        <li style="margin-bottom: 0.75rem; display: flex; gap: 0.75rem;">
                            <i class="fas fa-chart-line" style="color: #8B0000; margin-top: 0.25rem;"></i>
                            <span><strong>7-Day Projections:</strong> Expected reach, engagement rate, view time, and cost per view</span>
                        </li>
                        <li style="margin-bottom: 0.75rem; display: flex; gap: 0.75rem;">
                            <i class="fas fa-industry" style="color: #8B0000; margin-top: 0.25rem;"></i>
                            <span><strong>Industry Benchmarks:</strong> Average impression rates by display type in mid-size cities</span>
                        </li>
                        <li style="margin-bottom: 0.75rem; display: flex; gap: 0.75rem;">
                            <i class="fas fa-clock" style="color: #8B0000; margin-top: 0.25rem;"></i>
                            <span><strong>Time-of-Day Analysis:</strong> Optimal timing for maximum impressions</span>
                        </li>
                        <li style="margin-bottom: 0.75rem; display: flex; gap: 0.75rem;">
                            <i class="fas fa-dollar-sign" style="color: #8B0000; margin-top: 0.25rem;"></i>
                            <span><strong>Cost Statistics:</strong> Average cost per impression across different locations</span>
                        </li>
                    </ul>
                    <h4 style="color: #8B0000; margin-top: 1.5rem; margin-bottom: 0.75rem;">üí° Tip:</h4>
                    <p style="margin: 0;">Use these insights to optimize your budget allocation and targeting strategy!</p>
                `
            }
        };

        let infoTimeout = null;
        let isHoveringInfo = false;
        let isHoveringIcon = false;

        function showTabInfo(tabName) {
            // Only show if hovering over icon
            isHoveringIcon = true;
            
            // Clear any pending close timeout
            if (infoTimeout) {
                clearTimeout(infoTimeout);
                infoTimeout = null;
            }
            
            const modal = document.getElementById('tab-info-modal');
            const content = document.getElementById('tab-info-content');
            const info = tabInfoContent[tabName];
            
            if (info) {
                content.innerHTML = `
                    <div style="text-align: center; margin-bottom: 1.5rem;">
                        <div style="display: inline-flex; align-items: center; justify-content: center; width: 60px; height: 60px; background: linear-gradient(135deg, #8B0000, #5c0000); border-radius: 50%; margin-bottom: 1rem;">
                            <i class="${info.icon}" style="font-size: 1.8rem; color: white;"></i>
                        </div>
                        <h2 style="color: #8B0000; margin: 0; font-size: 1.8rem; font-family: 'Merriweather', Georgia, serif;">${info.title}</h2>
                    </div>
                    <div style="color: var(--text-secondary); font-family: 'Merriweather', Georgia, serif; line-height: 1.8; font-size: 1rem;">
                        ${info.content}
                    </div>
                `;
                modal.style.display = 'flex';
                isHoveringInfo = true;
            }
        }

        function closeTabInfo() {
            isHoveringIcon = false;
            
            // Add a small delay before closing to prevent flickering
            infoTimeout = setTimeout(() => {
                if (!isHoveringInfo && !isHoveringIcon) {
                    const modal = document.getElementById('tab-info-modal');
                    modal.style.display = 'none';
                }
            }, 150);
        }

        function forceCloseModal() {
            isHoveringInfo = false;
            isHoveringIcon = false;
            if (infoTimeout) {
                clearTimeout(infoTimeout);
                infoTimeout = null;
            }
            const modal = document.getElementById('tab-info-modal');
            modal.style.display = 'none';
        }

        // Keep modal open when hovering over it
        document.addEventListener('DOMContentLoaded', function() {
            const modalWrapper = document.getElementById('tab-info-content-wrapper');
            if (modalWrapper) {
                modalWrapper.addEventListener('mouseenter', function() {
                    isHoveringInfo = true;
                    if (infoTimeout) {
                        clearTimeout(infoTimeout);
                        infoTimeout = null;
                    }
                });
                
                modalWrapper.addEventListener('mouseleave', function() {
                    isHoveringInfo = false;
                    closeTabInfo();
                });
            }
        });

        // Close modal when clicking outside
        document.addEventListener('click', function(event) {
            const modal = document.getElementById('tab-info-modal');
            if (event.target === modal) {
                forceCloseModal();
            }
        });
        
        // Toast Notification
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type}`;
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 4000);
        }
        
        // Form Input Listeners
        document.getElementById('campaignName').addEventListener('input', updateCampaignProgress);
        document.getElementById('targetAudience').addEventListener('change', updateCampaignProgress);
        document.getElementById('tokenPerView').addEventListener('input', () => {
            calculatePayment();
            updateCampaignProgress();
        });
        
        // Auto-save draft every 30 seconds
        setInterval(() => {
            if (document.getElementById('campaignName').value) {
                saveDraft();
            }
        }, 30000);
        
        // Load draft on page load
        window.addEventListener('load', () => {
            const draft = localStorage.getItem('weadCampaignDraft');
            if (draft) {
                const data = JSON.parse(draft);
                if (confirm('Found a saved draft. Would you like to load it?')) {
                    // Load draft data into form
                    document.getElementById('campaignName').value = data.name || '';
                    document.getElementById('campaignDescription').value = data.description || '';
                    document.getElementById('targetAudience').value = data.audience || '';
                    document.getElementById('campaignDuration').value = data.duration || '';
                    document.getElementById('tokenPerView').value = data.tokenPerView || '';
                    document.getElementById('maxViews').value = data.maxViews || '';
                    document.getElementById('targetCountry').value = data.country || '';
                    document.getElementById('targetCity').value = data.city || '';
                    
                    calculatePayment();
                    updateCampaignProgress();
                    showToast('Draft loaded successfully!', 'success');
                }
            }
        });
    </script>

    <!-- Service Worker Registration for PWA -->
    <script>
        // Register Service Worker for PWA functionality
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('/sw.js')
                    .then(function(registration) {
                        console.log('[SW] Registered successfully:', registration.scope);

                        // Check for updates
                        registration.addEventListener('updatefound', function() {
                            const newWorker = registration.installing;
                            if (newWorker) {
                                newWorker.addEventListener('statechange', function() {
                                    if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                        // New content available, notify user
                                        showToast('New version available! Refresh to update.', 'info');
                                    }
                                });
                            }
                        });

                        // Request notification permission for push notifications
                        if ('Notification' in window) {
                            Notification.requestPermission().then(function(permission) {
                                if (permission === 'granted') {
                                    console.log('[SW] Notification permission granted');
                                }
                            });
                        }

                        // Register for background sync
                        if ('serviceWorker' in navigator && 'sync' in window.ServiceWorkerRegistration.prototype) {
                            registration.sync.register('background-sync')
                                .then(() => console.log('[SW] Background sync registered'))
                                .catch(err => console.log('[SW] Background sync failed:', err));
                        }

                        // Register for periodic sync
                        if ('serviceWorker' in navigator && 'periodicSync' in window.ServiceWorkerRegistration.prototype) {
                            registration.periodicSync.register('content-sync', {
                                minInterval: 24 * 60 * 60 * 1000 // 24 hours
                            }).then(() => console.log('[SW] Periodic sync registered'))
                              .catch(err => console.log('[SW] Periodic sync failed:', err));
                        }

                    })
                    .catch(function(error) {
                        console.log('[SW] Registration failed:', error);
                    });
            });
        }

        // PWA Install Prompt
        let deferredPrompt;
        const installButton = document.createElement('button');

        window.addEventListener('beforeinstallprompt', (e) => {
            console.log('[PWA] Before install prompt fired');
            e.preventDefault();
            deferredPrompt = e;

            // Show install button
            if (installButton) {
            installButton.textContent = 'Install WeAD App';
            installButton.className = 'btn btn-primary install-btn';
            installButton.style.cssText = `
                position: fixed;
                bottom: 20px;
                right: 20px;
                z-index: 1000;
                background: var(--quantum-primary);
                color: white;
                border: none;
                padding: 12px 24px;
                border-radius: 25px;
                font-size: 14px;
                font-weight: 600;
                cursor: pointer;
                box-shadow: var(--shadow-quantum);
                display: none;
            `;

            installButton.addEventListener('click', () => {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        console.log('[PWA] User accepted the install prompt');
                        showToast('WeAD app installed successfully!', 'success');
                    } else {
                        console.log('[PWA] User dismissed the install prompt');
                    }
                    deferredPrompt = null;
                    installButton.style.display = 'none';
                });
            });

            document.body.appendChild(installButton);

            // Show button after a delay
            setTimeout(() => {
                installButton.style.display = 'block';
                showToast('Tap "Install WeAD App" to install as mobile app!', 'info');
            }, 3000);
            }
        });

        // Hide install button if app is already installed
        window.addEventListener('appinstalled', (evt) => {
            console.log('[PWA] App was installed');
            if (installButton.parentNode) {
                installButton.parentNode.removeChild(installButton);
            }
            showToast('WeAD app installed successfully!', 'success');
        });

        // Handle PWA app launch
        if (window.matchMedia('(display-mode: standalone)').matches) {
            console.log('[PWA] Running in standalone mode');
            document.body.classList.add('pwa-mode');
        }

        // Handle online/offline status
        window.addEventListener('online', function() {
            console.log('[PWA] Back online');
            showToast('Back online!', 'success');
            document.body.classList.remove('offline');
        });

        window.addEventListener('offline', function() {
            console.log('[PWA] Gone offline');
            showToast('You are offline. Some features may be limited.', 'warning');
            document.body.classList.add('offline');
        });

        // Add PWA-specific CSS
        const pwaStyles = document.createElement('style');
        pwaStyles.textContent = `
            .pwa-mode {
                /* Adjust layout for PWA mode */
                padding-top: env(safe-area-inset-top);
                padding-bottom: env(safe-area-inset-bottom);
                padding-left: env(safe-area-inset-left);
                padding-right: env(safe-area-inset-right);
            }

            .offline {
                /* Visual indicator for offline mode */
                filter: grayscale(20%);
            }

            .offline::before {
                content: '';
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                height: 3px;
                background: linear-gradient(90deg, #A52A2A, #8B0000, #A52A2A);
                z-index: 1000;
                animation: offlinePulse 2s infinite;
            }

            @keyframes offlinePulse {
                0%, 100% { opacity: 1; }
                50% { opacity: 0.5; }
            }

            .install-btn {
                animation: installBounce 2s infinite;
            }

            @keyframes installBounce {
                0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
                40% { transform: translateY(-10px); }
                60% { transform: translateY(-5px); }
            }

            /* Mobile-specific PWA adjustments */
            @media (max-width: 768px) {
                .install-btn {
                    bottom: 80px; /* Above mobile browser controls */
                    right: 10px;
                    padding: 10px 20px;
                    font-size: 12px;
                }
            }
        `;
        document.head.appendChild(pwaStyles);

        // PWA Update mechanism
        let updateAvailable = false;
        navigator.serviceWorker?.addEventListener('message', (event) => {
            if (event.data && event.data.type === 'UPDATE_AVAILABLE') {
                updateAvailable = true;
                showToast('Update available! Refresh to get the latest version.', 'info');

                // Add refresh button to toast
                setTimeout(() => {
                    if (confirm('A new version is available. Refresh now?')) {
                        window.location.reload();
                    }
                }, 1000);
            }
        });

        // Check for updates periodically
        setInterval(() => {
            navigator.serviceWorker?.controller?.postMessage({
                type: 'CHECK_FOR_UPDATES'
            });
        }, 60 * 60 * 1000); // Check every hour

        console.log('[PWA] WeAD PWA features initialized');
        
        // Swipe Indicators for Tabs
        document.addEventListener('DOMContentLoaded', function() {
            const tabsContainer = document.querySelector('.tabs-container');
            const swipeLeft = document.querySelector('.swipe-left');
            const swipeRight = document.querySelector('.swipe-right');
            
            if (tabsContainer && swipeLeft && swipeRight) {
                function updateSwipeIndicators() {
                    const scrollLeft = tabsContainer.scrollLeft;
                    const scrollWidth = tabsContainer.scrollWidth;
                    const clientWidth = tabsContainer.clientWidth;
                    const maxScroll = scrollWidth - clientWidth;
                    
                    // Show left indicator if scrolled right
                    if (scrollLeft > 10) {
                        swipeLeft.style.opacity = '1';
                    } else {
                        swipeLeft.style.opacity = '0';
                    }
                    
                    // Show right indicator if not at end
                    if (scrollLeft < maxScroll - 10) {
                        swipeRight.style.opacity = '1';
                    } else {
                        swipeRight.style.opacity = '0';
                    }
                }
                
                // Update on scroll
                tabsContainer.addEventListener('scroll', updateSwipeIndicators);
                
                // Initial update
                updateSwipeIndicators();
                
                // Update on resize
                window.addEventListener('resize', updateSwipeIndicators);
                
                console.log('[Tabs] Swipe indicators initialized');
            }
        });
    </script>
{% endblock %}

{% block extra_scripts %}
    <script>
        // Additional scripts for the landing page
        console.log('[Landing] WeAD landing page initialized');
    </script>
{% endblock %}
