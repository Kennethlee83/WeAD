{% extends "base.html" %}

{% block title %}Checkout - RWA Marketplace{% endblock %}

{% block nav_links %}
<a href="/" class="nav-link">
    <i class="fas fa-home"></i>
    <span>Home</span>
</a>
<a href="/rwa-marketplace" class="nav-link">
    <i class="fas fa-store"></i>
    <span>RWA Marketplace</span>
</a>
<a href="/checkout" class="nav-link active">
    <i class="fas fa-shopping-cart"></i>
    <span>Checkout</span>
</a>
{% endblock %}

{% block extra_head %}
<style>
    /* Checkout - Dark Grey/Black Theme */
    :root {
        --quantum-primary: #404040 !important;
        --primary: #404040 !important;
        --secondary: #202020 !important;
        --glow-primary: #808080 !important;
        --glow-secondary: #606060 !important;
    }
    
    h1 {
        background: linear-gradient(135deg, #404040, #808080, #a0a0a0) !important;
        -webkit-background-clip: text !important;
        -webkit-text-fill-color: transparent !important;
        background-clip: text !important;
        text-shadow: none !important;
    }
    
    h2, h3 {
        color: white !important;
    }
    
    .nav-link:hover,
    .nav-link.active {
        color: #808080 !important;
        border: 2px solid rgba(128, 128, 128, 0.5) !important;
        box-shadow: 0 4px 15px rgba(128, 128, 128, 0.3) !important;
    }
    
    .nav-link.active {
        border: 2px solid rgba(128, 128, 128, 0.8) !important;
        box-shadow: 0 0 20px rgba(128, 128, 128, 0.5), 0 0 40px rgba(128, 128, 128, 0.3) !important;
    }
    
    /* Checkout Layout */
    .checkout-container {
        display: grid;
        grid-template-columns: 1fr 400px;
        gap: 2rem;
        margin-top: 2rem;
    }
    
    @media (max-width: 1024px) {
        .checkout-container {
            grid-template-columns: 1fr;
        }
    }
    
    /* Payment Method Selection */
    .payment-method-selector {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1.5rem;
        margin-bottom: 2rem;
    }
    
    .payment-method-card {
        background: linear-gradient(135deg, rgba(32, 32, 32, 0.6), rgba(0, 0, 0, 0.8));
        border: 3px solid rgba(128, 128, 128, 0.3);
        border-radius: 20px;
        padding: 2rem;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
        backdrop-filter: blur(10px);
    }
    
    .payment-method-card:hover {
        border-color: rgba(128, 128, 128, 0.6);
        transform: translateY(-5px);
        box-shadow: 0 10px 30px rgba(128, 128, 128, 0.3);
    }
    
    .payment-method-card.active {
        border-color: rgba(128, 128, 128, 0.9);
        background: linear-gradient(135deg, rgba(64, 64, 64, 0.7), rgba(32, 32, 32, 0.9));
        box-shadow: 0 0 30px rgba(128, 128, 128, 0.5);
    }
    
    .payment-method-icon {
        font-size: 3rem;
        margin-bottom: 1rem;
        background: linear-gradient(135deg, #606060, #808080);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }
    
    .payment-method-card.active .payment-method-icon {
        background: linear-gradient(135deg, #808080, #a0a0a0);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }
    
    .payment-method-title {
        font-size: 1.3rem;
        font-weight: 700;
        color: white;
        margin-bottom: 0.5rem;
    }
    
    .payment-method-description {
        font-size: 0.9rem;
        color: var(--text-secondary);
    }
    
    /* Form Sections */
    .form-section {
        background: linear-gradient(135deg, rgba(32, 32, 32, 0.6), rgba(0, 0, 0, 0.8));
        border: 2px solid rgba(128, 128, 128, 0.3);
        border-radius: 20px;
        padding: 2rem;
        margin-bottom: 1.5rem;
        backdrop-filter: blur(10px);
    }
    
    .form-section h3 {
        margin-bottom: 1.5rem;
        font-size: 1.3rem;
    }
    
    .form-group {
        margin-bottom: 1.5rem;
    }
    
    .form-group label {
        display: block;
        color: #a0a0a0;
        font-weight: 600;
        margin-bottom: 0.5rem;
        font-size: 0.95rem;
    }
    
    .form-group input,
    .form-group select {
        width: 100%;
        padding: 1rem;
        background: rgba(0, 0, 0, 0.5);
        border: 2px solid rgba(128, 128, 128, 0.3);
        border-radius: 12px;
        color: white;
        font-size: 1rem;
        transition: all 0.3s ease;
    }
    
    .form-group input:focus,
    .form-group select:focus {
        outline: none;
        border-color: rgba(128, 128, 128, 0.7);
        box-shadow: 0 0 15px rgba(128, 128, 128, 0.3);
    }
    
    .form-group input::placeholder {
        color: #606060;
    }
    
    .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
    }
    
    .form-row-3 {
        display: grid;
        grid-template-columns: 2fr 1fr 1fr;
        gap: 1rem;
    }
    
    /* Order Summary */
    .order-summary {
        background: linear-gradient(135deg, rgba(32, 32, 32, 0.6), rgba(0, 0, 0, 0.8));
        border: 2px solid rgba(128, 128, 128, 0.3);
        border-radius: 20px;
        padding: 2rem;
        backdrop-filter: blur(10px);
        position: sticky;
        top: 2rem;
        height: fit-content;
    }
    
    .order-summary h3 {
        margin-bottom: 1.5rem;
        font-size: 1.5rem;
    }
    
    .order-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem 0;
        border-bottom: 1px solid rgba(128, 128, 128, 0.2);
    }
    
    .order-item:last-child {
        border-bottom: none;
    }
    
    .item-info {
        flex-grow: 1;
    }
    
    .item-name {
        color: white;
        font-weight: 600;
        margin-bottom: 0.3rem;
    }
    
    .item-quantity {
        color: var(--text-secondary);
        font-size: 0.9rem;
    }
    
    .item-price {
        color: white;
        font-weight: 700;
        font-size: 1.1rem;
    }
    
    .order-totals {
        margin-top: 1.5rem;
        padding-top: 1.5rem;
        border-top: 2px solid rgba(128, 128, 128, 0.3);
    }
    
    .total-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: 1rem;
        font-size: 1rem;
    }
    
    .total-row.grand-total {
        font-size: 1.5rem;
        font-weight: 700;
        color: white;
        margin-top: 1rem;
        padding-top: 1rem;
        border-top: 2px solid rgba(128, 128, 128, 0.3);
    }
    
    .total-label {
        color: var(--text-secondary);
    }
    
    .total-value {
        color: white;
        font-weight: 600;
    }
    
    /* Submit Button */
    .submit-button {
        width: 100%;
        padding: 1.3rem;
        background: linear-gradient(135deg, #505050, #808080);
        color: white;
        border: 2px solid rgba(128, 128, 128, 0.4);
        border-radius: 15px;
        font-weight: 700;
        font-size: 1.2rem;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.8rem;
        margin-top: 2rem;
    }
    
    .submit-button:hover {
        background: linear-gradient(135deg, #707070, #a0a0a0);
        transform: translateY(-3px);
        box-shadow: 0 8px 25px rgba(128, 128, 128, 0.5);
        border-color: rgba(128, 128, 128, 0.7);
    }
    
    .submit-button:active {
        transform: translateY(-1px);
    }
    
    .submit-button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none;
    }
    
    /* Crypto Payment Section */
    .crypto-info {
        background: rgba(0, 0, 0, 0.5);
        border: 2px solid rgba(128, 128, 128, 0.3);
        border-radius: 15px;
        padding: 1.5rem;
        margin-top: 1rem;
    }
    
    .crypto-address {
        background: rgba(0, 0, 0, 0.7);
        border: 1px solid rgba(128, 128, 128, 0.4);
        border-radius: 10px;
        padding: 1rem;
        font-family: 'JetBrains Mono', monospace;
        font-size: 0.9rem;
        color: #a0a0a0;
        word-break: break-all;
        margin: 1rem 0;
    }
    
    .copy-button {
        padding: 0.7rem 1.5rem;
        background: linear-gradient(135deg, #404040, #606060);
        color: white;
        border: 1px solid rgba(128, 128, 128, 0.4);
        border-radius: 10px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .copy-button:hover {
        background: linear-gradient(135deg, #606060, #808080);
        box-shadow: 0 4px 15px rgba(128, 128, 128, 0.3);
    }
    
    .qr-code {
        text-align: center;
        margin: 1.5rem 0;
    }
    
    .qr-code img {
        max-width: 200px;
        border: 3px solid rgba(128, 128, 128, 0.3);
        border-radius: 15px;
        padding: 1rem;
        background: white;
    }
    
    /* Security Badge */
    .security-badge {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 1rem;
        background: rgba(34, 197, 94, 0.1);
        border: 1px solid rgba(34, 197, 94, 0.3);
        border-radius: 10px;
        color: #22c55e;
        font-size: 0.9rem;
        margin-top: 1rem;
    }
    
    .security-badge i {
        font-size: 1.2rem;
    }
    
    /* Payment Icons */
    .accepted-cards {
        display: flex;
        gap: 1rem;
        margin-top: 1rem;
        flex-wrap: wrap;
    }
    
    .card-icon {
        font-size: 2rem;
        color: #606060;
    }
    
    /* Hidden sections */
    .payment-form {
        display: none;
    }
    
    .payment-form.active {
        display: block;
    }
</style>
{% endblock %}

{% block content %}
<div class="page-container">
    <!-- Page Header -->
    <div class="page-header">
        <h1>Checkout</h1>
        <p>Complete your purchase securely</p>
    </div>

    <div class="checkout-container">
        <!-- Left Column: Payment Forms -->
        <div class="checkout-forms">
            
            <!-- Payment Method Selection -->
            <div class="form-section">
                <h3>Select Payment Method</h3>
                <div class="payment-method-selector">
                    <div class="payment-method-card active" onclick="selectPaymentMethod('card')" id="card-selector">
                        <div class="payment-method-icon">
                            <i class="fas fa-credit-card"></i>
                        </div>
                        <div class="payment-method-title">Credit Card</div>
                        <div class="payment-method-description">Pay with Visa, Mastercard, or Amex</div>
                    </div>
                    
                    <div class="payment-method-card" onclick="selectPaymentMethod('crypto')" id="crypto-selector">
                        <div class="payment-method-icon">
                            <i class="fab fa-bitcoin"></i>
                        </div>
                        <div class="payment-method-title">Cryptocurrency</div>
                        <div class="payment-method-description">Pay with BTC, ETH, or WEAD</div>
                    </div>
                </div>
            </div>

            <!-- Credit Card Form -->
            <div class="payment-form active" id="card-form">
                <div class="form-section">
                    <h3><i class="fas fa-credit-card"></i> Card Information</h3>
                    
                    <div class="form-group">
                        <label>Card Number</label>
                        <input type="text" id="cardNumber" placeholder="1234 5678 9012 3456" maxlength="19">
                    </div>
                    
                    <div class="form-group">
                        <label>Cardholder Name</label>
                        <input type="text" id="cardName" placeholder="John Doe">
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>Expiry Date</label>
                            <input type="text" id="cardExpiry" placeholder="MM/YY" maxlength="5">
                        </div>
                        <div class="form-group">
                            <label>CVV</label>
                            <input type="text" id="cardCVV" placeholder="123" maxlength="4">
                        </div>
                    </div>
                    
                    <div class="accepted-cards">
                        <i class="fab fa-cc-visa card-icon"></i>
                        <i class="fab fa-cc-mastercard card-icon"></i>
                        <i class="fab fa-cc-amex card-icon"></i>
                        <i class="fab fa-cc-discover card-icon"></i>
                    </div>
                </div>
                
                <div class="form-section">
                    <h3><i class="fas fa-map-marker-alt"></i> Billing Address</h3>
                    
                    <div class="form-group">
                        <label>Street Address</label>
                        <input type="text" id="address" placeholder="123 Main Street">
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>City</label>
                            <input type="text" id="city" placeholder="New York">
                        </div>
                        <div class="form-group">
                            <label>State/Province</label>
                            <input type="text" id="state" placeholder="NY">
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label>ZIP/Postal Code</label>
                            <input type="text" id="zip" placeholder="10001">
                        </div>
                        <div class="form-group">
                            <label>Country</label>
                            <select id="country">
                                <option>United States</option>
                                <option>Canada</option>
                                <option>United Kingdom</option>
                                <option>Australia</option>
                                <option>Germany</option>
                                <option>France</option>
                                <option>Japan</option>
                                <option>Other</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div class="security-badge">
                    <i class="fas fa-shield-alt"></i>
                    <span>Your payment information is encrypted and secure</span>
                </div>
                
                <div style="background: rgba(251, 191, 36, 0.1); border: 2px solid #fbbf24; border-radius: 15px; padding: 2rem; text-align: center; margin-top: 2rem;">
                    <div style="font-size: 3rem; margin-bottom: 1rem;">🚧</div>
                    <h3 style="color: #fbbf24; margin-bottom: 1rem;">Credit Card Payments Coming Soon!</h3>
                    <p style="color: var(--text-secondary); line-height: 1.6;">
                        We're integrating Stripe and PayPal for credit card payments.<br>
                        For now, please use <strong style="color: #fbbf24;">BNB, BTC, ETH, or USDT</strong> to complete your purchase.
                    </p>
                    <button onclick="selectPaymentMethod('crypto')" style="margin-top: 1rem; padding: 1rem 2rem; background: linear-gradient(135deg, #fbbf24, #f59e0b); color: white; border: none; border-radius: 10px; font-weight: 700; cursor: pointer; font-size: 1.1rem;">
                        <i class="fab fa-bitcoin"></i> Pay with Cryptocurrency
                    </button>
                </div>
            </div>

            <!-- Crypto Payment Form -->
            <div class="payment-form" id="crypto-form">
                <div class="form-section">
                    <h3><i class="fab fa-bitcoin"></i> Cryptocurrency Payment</h3>
                    
                    <!-- MetaMask Connection -->
                    <div id="metamask-connect-section" style="margin-bottom: 2rem;">
                        <button class="submit-button" onclick="connectMetaMaskCheckout()" id="connectMetaMaskBtn">
                            <i class="fab fa-ethereum"></i> Connect MetaMask Wallet
                        </button>
                        <div id="connected-wallet" style="display: none; margin-top: 1rem; padding: 1rem; background: rgba(34, 197, 94, 0.1); border: 2px solid rgba(34, 197, 94, 0.3); border-radius: 12px;">
                            <div style="display: flex; align-items: center; gap: 0.5rem; color: #22c55e;">
                                <i class="fas fa-check-circle"></i>
                                <span>Connected: <strong id="connectedAddress"></strong></span>
                            </div>
                            <div style="margin-top: 0.5rem; color: var(--text-secondary); font-size: 0.9rem;">
                                Network: <strong id="connectedNetwork" style="color: white;">BSC Testnet</strong>
                            </div>
                        </div>
                    </div>
                    
                    <!-- WEAD Token Coming Soon Message -->
                    <div style="background: linear-gradient(135deg, rgba(59, 130, 246, 0.2), rgba(37, 99, 235, 0.1)); border: 2px solid #3b82f6; border-radius: 10px; padding: 1rem; margin-bottom: 1.5rem;">
                        <div style="color: #3b82f6; font-weight: 700; font-size: 1.1rem; margin-bottom: 0.5rem;">
                            <i class="fas fa-clock"></i> Coming Soon: WEAD Tokens - 10% Discount on All Services
                        </div>
                        <div style="color: #cbd5e1; font-size: 0.9rem;">
                            WEAD Token payments will be available soon! Save 10% on all services when you pay with WEAD tokens. For now, please use BNB, BTC, ETH, or USDT for payments.
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Select Cryptocurrency</label>
                        <select id="cryptoType" onchange="updateCryptoAddress()">
                            <option value="bnb">Binance Coin (BNB) - BSC</option>
                            <option value="usdt">Tether (USDT) - BSC</option>
                            <option value="btc">Bitcoin (BTC)</option>
                            <option value="eth">Ethereum (ETH)</option>
                        </select>
                    </div>
                    
                    <!-- Direct Payment (WEAD/BNB via MetaMask) -->
                    <div id="directPaymentSection" style="display: none;">
                        <div style="background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(5, 150, 105, 0.05)); border: 2px solid #10b981; border-radius: 15px; padding: 2rem; text-align: center; margin: 1.5rem 0;">
                            <div style="font-size: 1.2rem; color: white; margin-bottom: 1rem;">
                                💳 Total Payment Amount
                            </div>
                            <div style="font-size: 3rem; color: #10b981; font-weight: 900; margin-bottom: 0.5rem;">
                                <span id="cryptoAmount">0</span>
                            </div>
                            <div style="color: var(--text-secondary); font-size: 0.95rem; margin-bottom: 2rem;">
                                ≈ $<span id="cryptoAmountUSD">0.00</span> USD
                            </div>
                            <button class="submit-button" onclick="processCryptoPayment()" id="directPayBtn" style="background: linear-gradient(135deg, #10b981, #059669); border-color: #10b981; margin-top: 0;">
                                <i class="fas fa-wallet"></i> Pay Now with MetaMask
                            </button>
                        </div>
                    </div>
                    
                    <!-- Manual Payment (BTC/ETH - requires manual sending) -->
                    <div id="manualPaymentSection" style="display: block;">
                        <div class="crypto-info">
                            <p style="color: var(--text-secondary); margin-bottom: 1rem;">
                                Send <strong id="manualCryptoAmount" style="color: white;">0.015 BTC</strong> to the address below:
                            </p>
                            
                            <div class="crypto-address" id="cryptoAddress">
                                bc1qxy2kgdygjrsqtzq2n0yrf2493p83kkfjhx0wlh
                            </div>
                            
                            <button class="copy-button" onclick="copyCryptoAddress()">
                                <i class="fas fa-copy"></i> Copy Address
                            </button>
                            
                            <div class="qr-code">
                                <img src="https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=bc1qxy2kgdygjrsqtzq2n0yrf2493p83kkfjhx0wlh" alt="QR Code" id="qrCode">
                            </div>
                            
                            <p style="color: var(--text-secondary); font-size: 0.9rem; margin-top: 1rem;">
                                <i class="fas fa-info-circle"></i> Scan the QR code with your crypto wallet or copy the address above
                            </p>
                        </div>
                        
                        <div class="form-group" style="margin-top: 2rem;">
                            <label>Your Wallet Address (for refunds)</label>
                            <input type="text" id="userWalletAddress" placeholder="Enter your wallet address">
                        </div>
                        
                        <div class="form-group">
                            <label>Transaction Hash (after payment)</label>
                            <input type="text" id="txHash" placeholder="Paste transaction hash here">
                        </div>
                        
                        <button class="submit-button" onclick="processCryptoPayment()" id="manualPayBtn">
                            <i class="fas fa-check-circle"></i> I Have Sent Payment
                        </button>
                    </div>
                </div>
                
                <div class="security-badge">
                    <i class="fas fa-shield-alt"></i>
                    <span>Payments are verified on the blockchain. No intermediaries.</span>
                </div>
            </div>
            
        </div>

        <!-- Right Column: Order Summary -->
        <div class="order-summary">
            <h3>Order Summary</h3>
            
            <div id="orderItems">
                <!-- Order items will be populated by JavaScript -->
            </div>
            
            <div class="order-totals">
                <div class="total-row">
                    <span class="total-label">Subtotal:</span>
                    <span class="total-value" id="subtotal">$0.00</span>
                </div>
                <div class="total-row">
                    <span class="total-label">Shipping:</span>
                    <span class="total-value" id="shipping">$0.00</span>
                </div>
                <div class="total-row">
                    <span class="total-label">Tax:</span>
                    <span class="total-value" id="tax">$0.00</span>
                </div>
                <div class="total-row" id="discountRow" style="display: none; color: #10b981; font-weight: 600;">
                    <span class="total-label"><i class="fas fa-tag"></i> WEAD Discount (10%):</span>
                    <span class="total-value" id="discount">-$0.00</span>
                </div>
                <div class="total-row grand-total">
                    <span class="total-label">Total:</span>
                    <span class="total-value" id="grandTotal">$0.00</span>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Get cart from localStorage or use sample data
    let cart = JSON.parse(localStorage.getItem('weadCart')) || [];
    
    // Ensure all cart items have quantity (fix old cart data)
    cart = cart.map(item => ({
        ...item,
        quantity: item.quantity || 1 // Default to 1 if undefined
    }));
    
    // If cart is empty, redirect back to marketplace
    if (cart.length === 0) {
        alert('Your cart is empty. Redirecting to marketplace...');
        window.location.href = '/rwa-marketplace';
    }
    
    // MetaMask connection state
    let connectedWallet = null;
    let web3Provider = null;
    
    // BSC Network Configuration
    const BSC_CONFIG = {
        chainId: '0x61', // 97 in hex - BSC TESTNET
        chainName: 'BSC Testnet',
        nativeCurrency: {
            name: 'BNB',
            symbol: 'BNB',
            decimals: 18,
        },
        rpcUrls: [
            'https://data-seed-prebsc-1-s1.binance.org:8545/',
            'https://data-seed-prebsc-2-s1.binance.org:8545/',
        ],
        blockExplorerUrls: ['https://testnet.bscscan.com'],
    };
    
    // Payment method selection
    function selectPaymentMethod(method) {
        // Update selector UI
        document.querySelectorAll('.payment-method-card').forEach(card => {
            card.classList.remove('active');
        });
        document.getElementById(method + '-selector').classList.add('active');
        
        // Show/hide forms
        document.querySelectorAll('.payment-form').forEach(form => {
            form.classList.remove('active');
        });
        document.getElementById(method + '-form').classList.add('active');
    }
    
    // Populate order summary
    function populateOrderSummary() {
        const orderItemsDiv = document.getElementById('orderItems');
        let subtotal = 0;
        
        orderItemsDiv.innerHTML = cart.map(item => {
            subtotal += item.price * item.quantity;
            return `
                <div class="order-item">
                    <div class="item-info">
                        <div class="item-name">${item.name}</div>
                        <div class="item-quantity">Qty: ${item.quantity}</div>
                    </div>
                    <div class="item-price">$${item.price.toFixed(2)}</div>
                </div>
            `;
        }).join('');
        
        const shipping = subtotal > 500 ? 0 : 25;
        const tax = subtotal * 0.08;
        let total = subtotal + shipping + tax;
        
        // Check if WEAD Token is selected for 10% discount
        const cryptoType = document.getElementById('cryptoType')?.value;
        const isWeadPayment = cryptoType === 'wead';
        const discount = isWeadPayment ? total * 0.10 : 0;
        const finalTotal = total - discount;
        
        document.getElementById('subtotal').textContent = '$' + subtotal.toFixed(2);
        document.getElementById('shipping').textContent = shipping === 0 ? 'FREE' : '$' + shipping.toFixed(2);
        document.getElementById('tax').textContent = '$' + tax.toFixed(2);
        
        // Show/hide discount row
        if (isWeadPayment) {
            document.getElementById('discountRow').style.display = 'flex';
            document.getElementById('discount').textContent = '-$' + discount.toFixed(2);
            document.getElementById('grandTotal').textContent = '$' + finalTotal.toFixed(2);
        } else {
            document.getElementById('discountRow').style.display = 'none';
            document.getElementById('grandTotal').textContent = '$' + total.toFixed(2);
        }
        
        // Update crypto amount with final total
        updateCryptoAmount(isWeadPayment ? finalTotal : total);
    }
    
    // Update crypto amount based on total
    function updateCryptoAmount(total) {
        const cryptoType = document.getElementById('cryptoType').value;
        let amount, symbol;
        
        // Handle undefined or invalid total
        if (!total || isNaN(total) || total <= 0) {
            total = 0;
        }
        
        switch(cryptoType) {
            case 'btc':
                amount = (total / 45000).toFixed(6);
                symbol = 'BTC';
                break;
            case 'eth':
                amount = (total / 2500).toFixed(4);
                symbol = 'ETH';
                break;
            case 'wead':
                // 1 WEAD = $0.01, so $1 = 100 WEAD
                amount = (total * 100).toFixed(0);
                symbol = 'WEAD';
                break;
            case 'usdt':
                amount = total.toFixed(2);
                symbol = 'USDT';
                break;
            case 'bnb':
                amount = (total / 300).toFixed(4);
                symbol = 'BNB';
                break;
            default:
                amount = '0';
                symbol = 'WEAD';
        }
        
        // Format with commas for readability
        let formattedAmount = amount;
        if (cryptoType === 'wead' && amount > 0) {
            formattedAmount = parseInt(amount).toLocaleString();
        }
        
        // Update both direct and manual payment displays
        const cryptoAmountElement = document.getElementById('cryptoAmount');
        const manualCryptoAmountElement = document.getElementById('manualCryptoAmount');
        const cryptoAmountUSDElement = document.getElementById('cryptoAmountUSD');
        
        if (cryptoAmountElement) {
            cryptoAmountElement.textContent = formattedAmount + ' ' + symbol;
        }
        if (manualCryptoAmountElement) {
            manualCryptoAmountElement.textContent = formattedAmount + ' ' + symbol;
        }
        if (cryptoAmountUSDElement) {
            cryptoAmountUSDElement.textContent = total.toFixed(2);
        }
    }
    
    // Update crypto address based on selection
    function updateCryptoAddress() {
        const cryptoType = document.getElementById('cryptoType').value;
        const addresses = {
            btc: 'bc1qxy2kgdygjrsqtzq2n0yrf2493p83kkfjhx0wlh',
            eth: '0x01d3829a1b0CA3E1390724a0C5C419435720431e',
            wead: '0xCF99bF2cbD83A580437d39A5092C1665Faa9898B',
            usdt: '0x01d3829a1b0CA3E1390724a0C5C419435720431e',
            bnb: '0x01d3829a1b0CA3E1390724a0C5C419435720431e'
        };
        
        const address = addresses[cryptoType];
        document.getElementById('cryptoAddress').textContent = address;
        document.getElementById('qrCode').src = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${address}`;
        
        // Show/hide WEAD discount message
        if (cryptoType === 'wead') {
            document.getElementById('weadDiscountMessage').style.display = 'block';
        } else {
            document.getElementById('weadDiscountMessage').style.display = 'none';
        }
        
        // For WEAD and BNB: Direct MetaMask payment (no manual copy/paste)
        // For BTC/ETH/USDT: Manual payment (show address/QR)
        const directSection = document.getElementById('directPaymentSection');
        const manualSection = document.getElementById('manualPaymentSection');
        
        if (cryptoType === 'wead' || cryptoType === 'bnb') {
            // Show direct payment button
            if (directSection) directSection.style.display = 'block';
            if (manualSection) manualSection.style.display = 'none';
        } else {
            // Show manual payment (address/QR)
            if (directSection) directSection.style.display = 'none';
            if (manualSection) manualSection.style.display = 'block';
        }
        
        // Recalculate totals with discount
        populateOrderSummary();
    }
    
    // Copy crypto address
    function copyCryptoAddress() {
        const address = document.getElementById('cryptoAddress').textContent;
        navigator.clipboard.writeText(address).then(() => {
            alert('Address copied to clipboard!');
        });
    }
    
    // Format card number
    document.getElementById('cardNumber')?.addEventListener('input', function(e) {
        let value = e.target.value.replace(/\s/g, '');
        let formattedValue = value.match(/.{1,4}/g)?.join(' ') || value;
        e.target.value = formattedValue;
    });
    
    // Format expiry date
    document.getElementById('cardExpiry')?.addEventListener('input', function(e) {
        let value = e.target.value.replace(/\D/g, '');
        if (value.length >= 2) {
            value = value.slice(0, 2) + '/' + value.slice(2, 4);
        }
        e.target.value = value;
    });
    
    // Process card payment
    function processCardPayment() {
        const cardNumber = document.getElementById('cardNumber').value;
        const cardName = document.getElementById('cardName').value;
        const cardExpiry = document.getElementById('cardExpiry').value;
        const cardCVV = document.getElementById('cardCVV').value;
        
        if (!cardNumber || !cardName || !cardExpiry || !cardCVV) {
            alert('Please fill in all card details');
            return;
        }
        
        // Show processing
        alert('Processing payment...\n\nThis is a demo. In production, this would connect to a payment gateway like Stripe or PayPal.');
        
        // Simulate success
        setTimeout(() => {
            alert('Payment successful! Order confirmed.\n\nOrder ID: #' + Math.random().toString(36).substr(2, 9).toUpperCase());
            localStorage.removeItem('weadCart');
            window.location.href = '/rwa-marketplace';
        }, 2000);
    }
    
    // Connect MetaMask for checkout
    async function connectMetaMaskCheckout() {
        if (typeof window.ethereum === 'undefined') {
            alert('MetaMask is not installed. Please install MetaMask to continue.');
            window.open('https://metamask.io/download/', '_blank');
            return;
        }
        
        try {
            // Switch to BSC network
            await switchToBSCNetwork();
            
            // Request account access
            const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
            const account = accounts[0];
            
            // Sign message for authentication
            const networkName = window.WEAD_CONFIG ? window.WEAD_CONFIG.BSC_CONFIG.chainName : 'BSC Mainnet';
            const message = `WeAD Checkout Authentication\n\nWallet: ${account}\nNetwork: ${networkName}\nTimestamp: ${Date.now()}`;
            const signature = await window.ethereum.request({
                method: 'personal_sign',
                params: [message, account],
            });
            
            // Authenticate with backend
            const authResponse = await fetch('/api/auth/metamask', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    address: account, 
                    signature: signature, 
                    message: message,
                    network: 'BSC'
                })
            });
            
            if (authResponse.ok) {
                const authData = await authResponse.json();
                localStorage.setItem('access_token', authData.access_token);
                localStorage.setItem('user_wallet', account);
                localStorage.setItem('user_network', 'BSC');
                
                connectedWallet = account;
                updateWalletUI(account);
                
                // Auto-fill user wallet address
                document.getElementById('userWalletAddress').value = account;
                
                alert('MetaMask connected successfully!');
            } else {
                throw new Error('Authentication failed');
            }
        } catch (error) {
            console.error('MetaMask connection error:', error);
            alert('Failed to connect MetaMask: ' + error.message);
        }
    }
    
    // Switch to BSC Network
    async function switchToBSCNetwork() {
        try {
            await window.ethereum.request({
                method: 'wallet_switchEthereumChain',
                params: [{ chainId: BSC_CONFIG.chainId }],
            });
        } catch (switchError) {
            // Chain not added, try to add it
            if (switchError.code === 4902) {
                try {
                    await window.ethereum.request({
                        method: 'wallet_addEthereumChain',
                        params: [BSC_CONFIG],
                    });
                } catch (addError) {
                    throw new Error('Failed to add BSC network to MetaMask');
                }
            } else {
                throw switchError;
            }
        }
    }
    
    // Update wallet UI
    function updateWalletUI(address) {
        const shortAddress = address.substring(0, 6) + '...' + address.substring(38);
        document.getElementById('connectedAddress').textContent = shortAddress;
        document.getElementById('connected-wallet').style.display = 'block';
        document.getElementById('connectMetaMaskBtn').style.display = 'none';
    }
    
    // Process crypto payment with MetaMask
    async function processCryptoPayment() {
        if (!connectedWallet) {
            alert('Please connect your MetaMask wallet first');
            return;
        }
        
        const cryptoType = document.getElementById('cryptoType').value;
        const total = parseFloat(document.getElementById('grandTotal').textContent.replace('$', ''));
        
        try {
            // For BSC-based tokens (BNB, WEAD, USDT)
            if (['bnb', 'wead', 'usdt'].includes(cryptoType)) {
                let amount, toAddress;
                
                if (cryptoType === 'bnb') {
                    amount = (total / 600).toFixed(6); // BNB price ~$600
                    toAddress = '0x742d35Cc6634C0532925a3b844Bc9e7595f0bEb'; // Your BNB address
                    
                    // Send BNB transaction
                    const txHash = await window.ethereum.request({
                        method: 'eth_sendTransaction',
                        params: [{
                            from: connectedWallet,
                            to: toAddress,
                            value: '0x' + (parseFloat(amount) * 1e18).toString(16),
                        }],
                    });
                    
                    alert(`Transaction sent!\n\nTx Hash: ${txHash}\n\nProcessing payment...`);
                    
                    // Wait for confirmation
                    setTimeout(() => {
                        alert('Payment confirmed! Order successful.\n\nOrder ID: #' + Math.random().toString(36).substr(2, 9).toUpperCase());
                        localStorage.removeItem('weadCart');
                        window.location.href = '/rwa-marketplace';
                    }, 3000);
                    
                } else if (cryptoType === 'wead') {
                    // WEAD Token Payment
                    const WEAD_TOKEN_ADDRESS = '0xCF99bF2cbD83A580437d39A5092C1665Faa9898B';
                    const PLATFORM_WALLET = '0x01d3829a1b0CA3E1390724a0C5C419435720431e';
                    
                    // Convert USD to WEAD (assume 1 WEAD = $0.01 for now)
                    const weadAmount = Math.floor(total * 100); // $1 = 100 WEAD
                    const amountInWei = BigInt(weadAmount) * BigInt(10 ** 18);
                    
                    alert(`💳 Processing WEAD Payment\n\nTotal: $${total.toFixed(2)}\nAmount: ${weadAmount.toLocaleString()} WEAD\n\nPlease confirm the payment in MetaMask...`);
                    
                    // ERC20 transfer function signature (this executes the payment)
                    const transferData = '0xa9059cbb' + 
                        PLATFORM_WALLET.slice(2).padStart(64, '0') + 
                        amountInWei.toString(16).padStart(64, '0');
                    
                    const txHash = await window.ethereum.request({
                        method: 'eth_sendTransaction',
                        params: [{
                            from: connectedWallet,
                            to: WEAD_TOKEN_ADDRESS,
                            data: transferData,
                            gas: '0x15F90', // 90000 gas
                        }],
                    });
                    
                    alert(`✅ Payment Transaction Submitted!\n\nAmount: ${weadAmount.toLocaleString()} WEAD ($${total.toFixed(2)})\nTransaction Hash: ${txHash}\n\nConfirming payment on blockchain...`);
                    
                    // Wait for confirmation and refresh balance
                    setTimeout(async () => {
                        // Refresh balance from blockchain
                        if (window.refreshAllBalances) {
                            await window.refreshAllBalances();
                        }
                        
                        alert('✅ Payment Confirmed!\n\nOrder ID: #' + Math.random().toString(36).substr(2, 9).toUpperCase() + '\n\nYour items will be shipped soon!\n\nYour WEAD balance has been updated.');
                        localStorage.removeItem('weadCart');
                        window.location.href = '/rwa-marketplace';
                    }, 3000);
                    
                } else {
                    // For USDT and other tokens
                    alert('This token payment requires contract interaction.\n\nPlease select WEAD or BNB for now.');
                }
            } else {
                // For BTC/ETH, show manual payment info
                const txHash = document.getElementById('txHash').value;
                if (!txHash) {
                    alert('Please enter the transaction hash after sending payment');
                    return;
                }
                
                alert('Verifying transaction on blockchain...\n\nThis is a demo. In production, this would verify the transaction.');
                
                setTimeout(() => {
                    alert('Payment verified! Order confirmed.\n\nOrder ID: #' + Math.random().toString(36).substr(2, 9).toUpperCase());
                    localStorage.removeItem('weadCart');
                    window.location.href = '/rwa-marketplace';
                }, 2000);
            }
        } catch (error) {
            console.error('Payment error:', error);
            alert('Payment failed: ' + error.message);
        }
    }
    
    // Initialize on page load
    window.addEventListener('DOMContentLoaded', () => {
        populateOrderSummary();
        updateCryptoAddress(); // Initialize crypto payment display
        
        // Check if wallet already connected
        const savedWallet = localStorage.getItem('user_wallet');
        if (savedWallet && window.ethereum) {
            connectedWallet = savedWallet;
            updateWalletUI(savedWallet);
        }
    });
</script>

{% endblock %}
