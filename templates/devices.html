{% extends "base.html" %}

{% block title %}Devices - WeAD Platform{% endblock %}

{% block nav_links %}
<a href="/" class="nav-link">
    <i class="fas fa-home"></i>
    <span>Home</span>
</a>
<a href="/analytics" class="nav-link">
    <i class="fas fa-graduation-cap"></i>
    <span>Intro</span>
</a>
<a href="/advertisers" class="nav-link">
    <i class="fas fa-bullhorn"></i>
    <span>Campaigns</span>
</a>
<a href="/campaigns" class="nav-link">
    <i class="fas fa-chart-line"></i>
    <span>Analytics</span>
</a>
<a href="/devices" class="nav-link active">
    <i class="fas fa-tv"></i>
    <span>Static Displays</span>
</a>
{% endblock %}

{% block extra_head %}
<link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@300;400;700&display=swap" rel="stylesheet">
<style>
    /* Advertiser Section - Dark Red Theme Override */
    :root {
        --quantum-primary: #8B0000 !important;
        --primary: #8B0000 !important;
        --secondary: #5c0000 !important;
        --glow-primary: #8B0000 !important;
        --glow-secondary: #5c0000 !important;
    }
    
    /* Override h1 - White titles */
    h1 {
        background: none !important;
        color: white !important;
        -webkit-text-fill-color: white !important;
        text-shadow: 0 0 20px rgba(139, 0, 0, 0.5) !important;
    }
    
    /* Override h2 - White subtitles */
    h2 {
        color: white !important;
    }
    
    /* Override h3 - White section headers */
    h3 {
        color: white !important;
    }
    
    /* Override button primary styles */
    .btn-primary {
        background: linear-gradient(135deg, #8B0000, #5c0000) !important;
        border-color: #8B0000 !important;
    }
    
    .btn-primary:hover {
        background: linear-gradient(135deg, #5c0000, #3d0000) !important;
        box-shadow: 0 5px 15px rgba(139, 0, 0, 0.4) !important;
    }
    
    /* Override nav-link styles for advertiser section */
    .nav-link:hover,
    .nav-link.active {
        color: #DC143C !important;
        border: 2px solid rgba(220, 20, 60, 0.5) !important;
        box-shadow: 0 4px 15px rgba(220, 20, 60, 0.3) !important;
    }
    
    .nav-link.active {
        border: 2px solid rgba(220, 20, 60, 0.8) !important;
        box-shadow: 0 0 20px rgba(220, 20, 60, 0.5), 0 0 40px rgba(220, 20, 60, 0.3) !important;
    }
    
    /* Override stat-icon background to lighter red */
    .stat-icon {
        background: linear-gradient(135deg, #DC143C, #B22222) !important;
    }
    
    /* Info banner styling matching other pages */
    .info-banner {
        background: rgba(139, 0, 0, 0.1);
        border: 2px solid rgba(139, 0, 0, 0.3);
        border-radius: 12px;
        padding: 1rem 1.5rem;
        margin-top: 1.5rem;
        display: flex;
        align-items: center;
        gap: 1rem;
    }
    
    .info-banner i {
        color: var(--quantum-primary);
        font-size: 1.5rem;
        flex-shrink: 0;
    }
    
    .info-banner p {
        margin: 0;
        color: #cbd5e1;
        line-height: 1.8;
        font-family: 'Merriweather', Georgia, serif;
        font-weight: 300;
        font-size: 1rem;
        letter-spacing: 0.3px;
    }
    
    /* Device cards styling */
    .devices-list {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
        gap: 1.5rem;
    }
    
    .device-card {
        background: var(--glass-bg);
        border: 2px solid var(--glass-border);
        border-radius: 12px;
        padding: 1.5rem;
        transition: all 0.3s ease;
    }
    
    .device-card:hover {
        border-color: var(--quantum-primary);
        box-shadow: 0 10px 40px rgba(139, 0, 0, 0.3);
        transform: translateY(-5px);
    }
    
    .device-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid var(--glass-border);
    }
    
    .device-header h3 {
        color: white;
        margin: 0;
        font-size: 1.25rem;
    }
    
    .device-status {
        padding: 0.25rem 0.75rem;
        border-radius: 12px;
        font-size: 0.85rem;
        font-weight: 600;
        text-transform: capitalize;
    }
    
    .status-active {
        background: rgba(16, 185, 129, 0.2);
        color: #34d399;
        border: 1px solid #10b981;
    }
    
    .status-offline {
        background: rgba(107, 114, 128, 0.2);
        color: #9ca3af;
        border: 1px solid #6b7280;
    }
    
    .status-maintenance {
        background: rgba(251, 191, 36, 0.2);
        color: #fcd34d;
        border: 1px solid #f59e0b;
    }
    
    .device-content {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }
    
    .device-info {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
    }
    
    .info-item {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        color: var(--text-secondary);
    }
    
    .info-item i {
        color: var(--quantum-primary);
        width: 20px;
    }
    
    .device-actions {
        display: flex;
        gap: 0.5rem;
        margin-top: 1rem;
        padding-top: 1rem;
        border-top: 1px solid var(--glass-border);
    }
    
    .device-actions button {
        flex: 1;
        padding: 0.5rem 1rem;
        border-radius: 8px;
        font-size: 0.9rem;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .btn-view {
        background: linear-gradient(135deg, var(--quantum-primary), var(--quantum-secondary));
        color: white;
        border: none;
    }
    
    .btn-view:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(139, 0, 0, 0.4);
    }
    
    .btn-remove {
        background: rgba(239, 68, 68, 0.2);
        color: #fca5a5;
        border: 1px solid rgba(239, 68, 68, 0.5);
    }
    
    .btn-remove:hover {
        background: rgba(239, 68, 68, 0.3);
        border-color: #ef4444;
    }
    
    /* Empty state */
    .empty-state {
        text-align: center;
        padding: 4rem 2rem;
        color: var(--text-secondary);
    }
    
    .empty-state i {
        font-size: 4rem;
        opacity: 0.5;
        margin-bottom: 1rem;
        color: var(--quantum-primary);
    }
    
    .empty-state h3 {
        color: white;
        margin: 1rem 0;
    }
    
    /* Action bar */
    .action-bar {
        display: flex;
        gap: 1rem;
        margin-bottom: 2rem;
    }
    
    /* Mobile Optimization */
    @media (max-width: 768px) {
        .page-header {
            padding: 1.5rem 1rem !important;
        }
        
        .page-header h1 {
            font-size: 1.8rem !important;
        }
        
        /* Make device grid horizontal scroll */
        .devices-grid {
            display: flex !important;
            overflow-x: auto !important;
            scroll-snap-type: x mandatory !important;
            -webkit-overflow-scrolling: touch !important;
            gap: 1rem !important;
            padding: 0 0.5rem !important;
            margin-left: -1rem !important;
            margin-right: -1rem !important;
            scrollbar-width: none !important;
        }
        
        .devices-grid::-webkit-scrollbar {
            display: none !important;
        }
        
        .device-card {
            flex: 0 0 85% !important;
            scroll-snap-align: center !important;
            max-width: 350px !important;
            min-width: 280px !important;
            padding: 1rem !important;
        }
        
        /* Stack action bar buttons */
        .action-bar {
            flex-direction: column !important;
            gap: 0.75rem !important;
        }
        
        .action-bar button {
            width: 100% !important;
        }
        
        /* Simplify device info */
        .device-info {
            gap: 0.5rem !important;
        }
        
        .info-item {
            font-size: 0.9rem !important;
        }
        
        /* Optimize buttons */
        .btn {
            width: 100% !important;
            padding: 0.875rem 1.5rem !important;
            font-size: 0.95rem !important;
        }
        
        /* Reduce section padding */
        .glass {
            padding: 1.5rem 1rem !important;
        }
        
        /* Stack device actions */
        .device-actions {
            flex-direction: column !important;
            gap: 0.5rem !important;
        }
        
        .device-actions button {
            width: 100% !important;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="page-container">
    <div class="page-header">
        <h1><i class="fas fa-tv"></i> Static Ad Display Management</h1>
        <p>Manage your display devices and monitor their performance</p>
        
        <!-- Demo Disclaimer -->
        <div style="background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(37, 99, 235, 0.05)); border: 2px solid rgba(59, 130, 246, 0.3); border-radius: 12px; padding: 1rem 1.5rem; margin-top: 1.5rem; text-align: center;">
            <i class="fas fa-info-circle" style="color: #3b82f6; margin-right: 0.5rem;"></i>
            <span style="color: #93c5fd; font-size: 0.95rem; font-weight: 500;">
                Demo Preview: Device listings and analytics are simulated data. Real device management and performance tracking will be available upon official launch.
            </span>
        </div>
        
        <div class="info-banner">
            <i class="fas fa-info-circle"></i>
            <p>This section is designed for stores, homes, hotels, and business buildings with static ad display screens. Register your displays, connect them via Web3, and start showing targeted advertisements to earn WEAD tokens.</p>
        </div>
    </div>

    <!-- Device Stats -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-tv"></i>
            </div>
            <div class="stat-content">
                <h3 id="total-devices">0</h3>
                <p>Total Devices</p>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-check-circle"></i>
            </div>
            <div class="stat-content">
                <h3 id="active-devices">0</h3>
                <p>Active Devices</p>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-clock"></i>
            </div>
            <div class="stat-content">
                <h3 id="total-uptime">0h</h3>
                <p>Total Uptime</p>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-dollar-sign"></i>
            </div>
            <div class="stat-content">
                <h3 id="device-earnings">$0</h3>
                <p>Device Earnings</p>
            </div>
        </div>
    </div>

    <!-- Device Actions -->
    <div class="action-bar">
        <button class="btn btn-primary" onclick="showRegisterDeviceModal()">
            <i class="fas fa-plus"></i> Connect with WeAD Application
        </button>
    </div>

    <!-- Devices List -->
    <div class="content-card">
        <div class="card-header">
            <h2>Your Devices</h2>
            <div class="card-actions">
                <select id="device-filter" onchange="filterDevices()">
                    <option value="all">All Devices</option>
                    <option value="active">Active</option>
                    <option value="offline">Offline</option>
                    <option value="maintenance">Maintenance</option>
                </select>
            </div>
        </div>
        <div class="card-content">
            <div id="devices-list" class="devices-list">
                <!-- Devices will be loaded here -->
            </div>
        </div>
    </div>
</div>

<!-- Register Device Modal -->
<div id="register-device-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Register New Device</h2>
            <span class="close" onclick="closeRegisterDeviceModal()">&times;</span>
        </div>
        <div class="modal-body">
            <form id="register-device-form">
                <div class="form-group">
                    <label for="device-name">Device Name</label>
                    <input type="text" id="device-name" name="name" required>
                </div>
                <div class="form-group">
                    <label for="device-type">Device Type</label>
                    <select id="device-type" name="type" required>
                        <option value="">Select device type</option>
                        <option value="digital_signage">Digital Signage Display</option>
                        <option value="storefront">Storefront Window Display</option>
                        <option value="smart_tv">Smart TV (Commercial)</option>
                        <option value="led_billboard">LED Billboard</option>
                        <option value="kiosk">Interactive Kiosk</option>
                        <option value="hotel_tv">Hotel Room TV</option>
                        <option value="restaurant_menu">Digital Menu Board</option>
                        <option value="office_display">Office Lobby Display</option>
                        <option value="monitor">Commercial Monitor</option>
                        <option value="projector">Projector Screen</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="device-business">Business Type</label>
                    <select id="device-business" name="business_type" required>
                        <option value="">Select business type</option>
                        <option value="retail_store">Retail Store</option>
                        <option value="restaurant">Restaurant/Café</option>
                        <option value="hotel">Hotel/Resort</option>
                        <option value="office">Office Building</option>
                        <option value="mall">Shopping Mall</option>
                        <option value="gym">Gym/Fitness Center</option>
                        <option value="hospital">Hospital/Clinic</option>
                        <option value="airport">Airport/Transit</option>
                        <option value="home">Residential</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="device-size">Screen Size (inches)</label>
                    <input type="number" id="device-size" name="screen_size" min="10" max="200" placeholder="e.g., 55">
                </div>
                <div class="form-group">
                    <label for="device-location">Location</label>
                    <input type="text" id="device-location" name="location" placeholder="e.g., Living Room, Office" required>
                </div>
                <div class="form-group">
                    <label for="device-resolution">Display Resolution</label>
                    <select id="device-resolution" name="resolution">
                        <option value="hd">HD (1280x720)</option>
                        <option value="fhd" selected>Full HD (1920x1080)</option>
                        <option value="2k">2K (2560x1440)</option>
                        <option value="4k">4K (3840x2160)</option>
                        <option value="8k">8K (7680x4320)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="device-orientation">Display Orientation</label>
                    <select id="device-orientation" name="orientation">
                        <option value="landscape" selected>Landscape (Horizontal)</option>
                        <option value="portrait">Portrait (Vertical)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="device-capabilities">Features</label>
                    <div class="checkbox-group">
                        <label><input type="checkbox" name="capabilities" value="video_playback" checked> Video Playback</label>
                        <label><input type="checkbox" name="capabilities" value="internet_connected" checked> Internet Connected</label>
                        <label><input type="checkbox" name="capabilities" value="touch_screen"> Touch Screen</label>
                        <label><input type="checkbox" name="capabilities" value="audio_output"> Audio Output</label>
                        <label><input type="checkbox" name="capabilities" value="24_7_operation"> 24/7 Operation</label>
                    </div>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeRegisterDeviceModal()">Cancel</button>
            <button type="button" class="btn btn-primary" onclick="registerDevice()">Register Device</button>
        </div>
    </div>
</div>

<script>
// Device Management JavaScript
let devices = [];

// Load devices on page load
document.addEventListener('DOMContentLoaded', function() {
    loadDevices();
    loadDeviceStats();
});

async function loadDevices() {
    try {
        const response = await fetch('/api/devices', {
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('token')}`
            }
        });
        
        if (response.ok) {
            const data = await response.json();
            devices = data.devices || [];
            displayDevices(devices);
        } else {
            console.error('Failed to load devices');
            displayMockDevices();
        }
    } catch (error) {
        console.error('Error loading devices:', error);
        displayMockDevices();
    }
}

function displayMockDevices() {
    devices = [
        {
            id: 1,
            name: "Store Front Display #1",
            type: "digital_signage",
            business_type: "retail_store",
            location: "Main Entrance - Downtown Store",
            status: "active",
            uptime: 720,
            earnings: 1250.50,
            last_seen: "2024-01-07T10:30:00Z",
            screen_size: 65,
            resolution: "4k",
            capabilities: ["video_playback", "internet_connected", "24_7_operation"]
        },
        {
            id: 2,
            name: "Hotel Lobby Display",
            type: "led_billboard",
            business_type: "hotel",
            location: "Grand Hotel - Lobby",
            status: "active",
            uptime: 504,
            earnings: 890.25,
            last_seen: "2024-01-07T10:25:00Z",
            screen_size: 85,
            resolution: "4k",
            capabilities: ["video_playback", "internet_connected", "audio_output", "24_7_operation"]
        },
        {
            id: 3,
            name: "Restaurant Entrance Display Stand",
            type: "restaurant_menu",
            business_type: "restaurant",
            location: "Café Downtown - Entrance",
            status: "active",
            uptime: 336,
            earnings: 445.75,
            last_seen: "2024-01-07T10:20:00Z",
            screen_size: 43,
            resolution: "fhd",
            capabilities: ["video_playback", "internet_connected"]
        },
        {
            id: 4,
            name: "Office Building Display",
            type: "office_display",
            business_type: "office",
            location: "Tech Corp - Main Lobby",
            status: "offline",
            uptime: 168,
            earnings: 325.00,
            last_seen: "2024-01-06T15:45:00Z",
            screen_size: 55,
            resolution: "4k",
            capabilities: ["video_playback", "internet_connected"]
        }
    ];
    displayDevices(devices);
}

function displayDevices(devicesToShow) {
    const container = document.getElementById('devices-list');
    
    if (devicesToShow.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <i class="fas fa-tv"></i>
                <h3>No devices found</h3>
                <p>Register your first device to start earning</p>
                <button class="btn btn-primary" onclick="showRegisterDeviceModal()">
                    <i class="fas fa-plus"></i> Register Device
                </button>
            </div>
        `;
        return;
    }

    container.innerHTML = devicesToShow.map(device => `
        <div class="device-card">
            <div class="device-header">
                <h3>${device.name}</h3>
                <span class="device-status status-${device.status}">${device.status}</span>
            </div>
            <div class="device-content">
                <div class="device-info">
                    <div class="info-item">
                        <i class="fas fa-tv"></i>
                        <span>${device.type.replace('_', ' ').toUpperCase()}</span>
                    </div>
                    <div class="info-item">
                        <i class="fas fa-map-marker-alt"></i>
                        <span>${device.location}</span>
                    </div>
                    <div class="info-item">
                        <i class="fas fa-clock"></i>
                        <span>${device.uptime}h uptime</span>
                    </div>
                    <div class="info-item">
                        <i class="fas fa-dollar-sign"></i>
                        <span>$${device.earnings} earned</span>
                    </div>
                </div>
                <div class="device-capabilities">
                    ${device.capabilities.map(cap => `
                        <span class="capability">${cap.replace('_', ' ')}</span>
                    `).join('')}
                </div>
            </div>
            <div class="device-actions">
                <button class="btn-view" onclick="viewDevice(${device.id})">
                    <i class="fas fa-chart-line"></i> View Details
                </button>
                <button class="btn-remove" onclick="disconnectDevice(${device.id})">
                    <i class="fas fa-unlink"></i> Disconnect
                </button>
            </div>
        </div>
    `).join('');
}

function filterDevices() {
    const filter = document.getElementById('device-filter').value;
    let filteredDevices = devices;
    
    if (filter !== 'all') {
        filteredDevices = devices.filter(device => device.status === filter);
    }
    
    displayDevices(filteredDevices);
}

async function loadDeviceStats() {
    try {
        const response = await fetch('/api/devices/stats', {
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('token')}`
            }
        });
        
        if (response.ok) {
            const data = await response.json();
            updateDeviceStats(data);
        } else {
            updateMockDeviceStats();
        }
    } catch (error) {
        console.error('Error loading device stats:', error);
        updateMockDeviceStats();
    }
}

function updateMockDeviceStats() {
    document.getElementById('total-devices').textContent = '3';
    document.getElementById('active-devices').textContent = '1';
    document.getElementById('total-uptime').textContent = '336h';
    document.getElementById('device-earnings').textContent = '$249.50';
}

function updateDeviceStats(data) {
    document.getElementById('total-devices').textContent = data.total_devices || 0;
    document.getElementById('active-devices').textContent = data.active_devices || 0;
    document.getElementById('total-uptime').textContent = `${data.total_uptime || 0}h`;
    document.getElementById('device-earnings').textContent = `$${data.device_earnings || 0}`;
}

function showRegisterDeviceModal() {
    document.getElementById('register-device-modal').style.display = 'block';
}

function closeRegisterDeviceModal() {
    document.getElementById('register-device-modal').style.display = 'none';
    document.getElementById('register-device-form').reset();
}

function generateDeviceCode() {
    const prefix = 'WEAD';
    const random = Math.random().toString(36).substring(2, 10).toUpperCase();
    const timestamp = Date.now().toString(36).toUpperCase();
    return `${prefix}-${random}-${timestamp}`;
}

async function registerDevice() {
    const form = document.getElementById('register-device-form');
    const formData = new FormData(form);
    
    const capabilities = [];
    formData.getAll('capabilities').forEach(cap => capabilities.push(cap));
    
    // Generate unique device code
    const deviceCode = generateDeviceCode();
    
    const deviceData = {
        name: formData.get('name'),
        type: formData.get('type'),
        business_type: formData.get('business_type'),
        location: formData.get('location'),
        screen_size: formData.get('screen_size') || null,
        resolution: formData.get('resolution'),
        orientation: formData.get('orientation'),
        capabilities: capabilities,
        device_code: deviceCode,
        status: 'offline', // Will be 'active' when display connects
        registered_at: new Date().toISOString()
    };
    
    try {
        const response = await fetch('/api/devices/register', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${localStorage.getItem('access_token')}`
            },
            body: JSON.stringify(deviceData)
        });
        
        if (response.ok) {
            const result = await response.json();
            closeRegisterDeviceModal();
            
            // Show device code to user
            showDeviceCodeModal(deviceCode, deviceData.name);
            
            loadDevices();
            loadDeviceStats();
        } else {
            alert('Failed to register device');
        }
    } catch (error) {
        console.error('Error registering device:', error);
        // For demo purposes, create device locally
        deviceData.id = Date.now();
        devices.push(deviceData);
        closeRegisterDeviceModal();
        showDeviceCodeModal(deviceCode, deviceData.name);
        displayDevices(devices);
    }
}

function showDeviceCodeModal(code, deviceName) {
    const viewerUrl = `${window.location.origin}/display/${code}`;
    const modal = document.createElement('div');
    modal.className = 'modal';
    modal.style.display = 'block';
    modal.innerHTML = `
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2><i class="fas fa-check-circle" style="color: #22c55e;"></i> Device Registered Successfully!</h2>
                <span class="close" onclick="this.closest('.modal').remove()">&times;</span>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 1.5rem; color: var(--text-secondary);">Your device <strong style="color: white;">"${deviceName}"</strong> has been registered. Use the information below to connect your display:</p>
                
                <div style="background: linear-gradient(135deg, rgba(139, 0, 0, 0.1), rgba(92, 0, 0, 0.1)); padding: 1.5rem; border-radius: 12px; border: 2px solid var(--quantum-primary); margin-bottom: 1.5rem;">
                    <h3 style="color: var(--quantum-primary); margin-bottom: 1rem; font-size: 1.1rem;">Device Code:</h3>
                    <div style="display: flex; align-items: center; gap: 1rem; background: rgba(0,0,0,0.5); padding: 1rem; border-radius: 8px;">
                        <code id="device-code-display" style="flex: 1; font-size: 1.5rem; font-weight: bold; color: white; letter-spacing: 2px;">${code}</code>
                        <button onclick="copyDeviceCode('${code}')" class="btn btn-sm btn-secondary" style="white-space: nowrap;">
                            <i class="fas fa-copy"></i> Copy
                        </button>
                    </div>
                </div>
                
                <div style="background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(37, 99, 235, 0.1)); padding: 1.5rem; border-radius: 12px; border: 2px solid #3b82f6; margin-bottom: 1.5rem;">
                    <h3 style="color: #3b82f6; margin-bottom: 1rem; font-size: 1.1rem;">Display Viewer URL:</h3>
                    <div style="display: flex; align-items: center; gap: 1rem; background: rgba(0,0,0,0.5); padding: 1rem; border-radius: 8px;">
                        <code id="viewer-url-display" style="flex: 1; font-size: 0.9rem; color: #60a5fa; word-break: break-all;">${viewerUrl}</code>
                        <button onclick="copyViewerUrl('${viewerUrl}')" class="btn btn-sm btn-secondary" style="white-space: nowrap;">
                            <i class="fas fa-copy"></i> Copy
                        </button>
                    </div>
                </div>
                
                <div style="background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(5, 150, 105, 0.1)); padding: 1.5rem; border-radius: 12px; border: 2px solid #10b981;">
                    <h3 style="color: #10b981; margin-bottom: 0.5rem; font-size: 1.1rem;"><i class="fas fa-info-circle"></i> Next Steps:</h3>
                    <ol style="color: var(--text-secondary); line-height: 1.8; margin: 0; padding-left: 1.5rem;">
                        <li>Open a web browser on your display device</li>
                        <li>Navigate to the Viewer URL above</li>
                        <li>Enter your device code when prompted</li>
                        <li>Your display will connect and start showing ads!</li>
                        <li>Use the mobile app to control and monitor your display</li>
                    </ol>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" onclick="this.closest('.modal').remove()">Got it!</button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
}

function copyDeviceCode(code) {
    navigator.clipboard.writeText(code).then(() => {
        showToast('Device code copied to clipboard!', 'success');
    });
}

function copyViewerUrl(url) {
    navigator.clipboard.writeText(url).then(() => {
        showToast('Viewer URL copied to clipboard!', 'success');
    });
}

function showToast(message, type = 'info') {
    const toast = document.createElement('div');
    toast.style.cssText = `
        position: fixed;
        bottom: 20px;
        right: 20px;
        padding: 1rem 1.5rem;
        background: ${type === 'success' ? 'linear-gradient(135deg, #22c55e, #16a34a)' : 'linear-gradient(135deg, #3b82f6, #2563eb)'};
        color: white;
        border-radius: 8px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        z-index: 10000;
        animation: slideIn 0.3s ease;
    `;
    toast.textContent = message;
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}

function refreshDevices() {
    loadDevices();
    loadDeviceStats();
}

function viewDevice(id) {
    const device = devices.find(d => d.id === id);
    if (device) {
        showToast(`Viewing details for ${device.name}`, 'info');
        // TODO: Navigate to device details page or show modal with:
        // - Detailed analytics (plays over time, impressions by hour)
        // - Earnings breakdown
        // - Location map
        // - Performance metrics
    }
}

function disconnectDevice(id) {
    const device = devices.find(d => d.id === id);
    if (confirm(`Are you sure you want to disconnect "${device.name}"?\n\nNote: You can control and reconnect this display from the WeAD Mobile App.`)) {
        devices = devices.filter(d => d.id !== id);
        displayDevices(devices);
        loadDeviceStats();
        showToast('Display disconnected successfully. Reconnect anytime via mobile app.', 'success');
    }
}

// Close modal when clicking outside
window.onclick = function(event) {
    const modal = document.getElementById('register-device-modal');
    if (event.target === modal) {
        closeRegisterDeviceModal();
    }
}
</script>
{% endblock %}


