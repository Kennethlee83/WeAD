{% extends "base.html" %}

{% block title %}Earnings - WeAD Platform{% endblock %}

{% block nav_links %}
<a href="/" class="nav-link">
    <i class="fas fa-home"></i>
    <span>Home</span>
</a>
<a href="/microtisers" class="nav-link">
    <i class="fas fa-tachometer-alt"></i>
    <span>Dashboard</span>
</a>
<a href="/microtisers/earnings" class="nav-link">
    <i class="fas fa-wallet"></i>
    <span>Earnings & Wallet</span>
</a>
<a href="/microtisers/devices" class="nav-link">
    <i class="fas fa-tv"></i>
    <span>WeAD Displays</span>
</a>
{% endblock %}

{% block extra_head %}
<style>
    /* Microtisers Earnings Page - Dark Green Theme */
    :root {
        --micro-dark-green: #064e3b;
        --micro-green: #10b981;
        --micro-light-green: #34d399;
        --micro-emerald: #059669;
    }
    
    /* Modal Scrolling Fix */
    .modal {
        overflow-y: auto !important;
        padding: 2rem 0 !important;
    }
    
    .modal-content {
        max-width: 600px;
        max-height: 90vh;
        margin: 0 auto;
        overflow: visible;
    }
    
    .modal-body {
        max-height: calc(90vh - 180px);
        overflow-y: auto;
        padding: 1.5rem;
    }
    
    /* Custom scrollbar for modal */
    .modal-body::-webkit-scrollbar {
        width: 8px;
    }
    
    .modal-body::-webkit-scrollbar-track {
        background: rgba(16, 185, 129, 0.1);
        border-radius: 4px;
    }
    
    .modal-body::-webkit-scrollbar-thumb {
        background: rgba(16, 185, 129, 0.5);
        border-radius: 4px;
    }
    
    .modal-body::-webkit-scrollbar-thumb:hover {
        background: rgba(16, 185, 129, 0.7);
    }
    
    /* Override page title gradient for green theme */
    .page-header h1 {
        background: linear-gradient(135deg, #34d399, #fff) !important;
        -webkit-background-clip: text !important;
        -webkit-text-fill-color: transparent !important;
        background-clip: text !important;
    }
    
    /* Green themed card headers */
    .card-header h2,
    .content-card .card-header h2,
    .section-title {
        background: linear-gradient(135deg, #34d399, #fff) !important;
        -webkit-background-clip: text !important;
        -webkit-text-fill-color: transparent !important;
        background-clip: text !important;
    }
    
    /* Green themed content cards */
    .content-card {
        border: 2px solid rgba(16, 185, 129, 0.3) !important;
        background: var(--glass-bg) !important;
    }
    
    .content-card:hover {
        border-color: #10b981 !important;
        box-shadow: 0 10px 40px rgba(16, 185, 129, 0.4) !important;
    }
    
    /* Green themed card headers border */
    .card-header {
        border-bottom: 2px solid rgba(16, 185, 129, 0.3) !important;
    }
    
    /* Green themed stat cards */
    .stat-card {
        border: 2px solid rgba(16, 185, 129, 0.3) !important;
        background: var(--glass-bg) !important;
    }
    
    .stat-card:hover {
        border-color: #10b981 !important;
        box-shadow: 0 10px 40px rgba(16, 185, 129, 0.4) !important;
        transform: translateY(-5px);
    }
    
    .stat-card .stat-icon {
        background: linear-gradient(135deg, var(--micro-dark-green), var(--micro-green)) !important;
    }
    
    .stat-card .stat-content h3 {
        color: var(--micro-light-green) !important;
    }
    
    /* Green themed buttons */
    .btn-primary {
        background: linear-gradient(135deg, var(--micro-dark-green), var(--micro-green)) !important;
        border: none;
    }
    
    .btn-primary:hover {
        background: linear-gradient(135deg, var(--micro-green), var(--micro-light-green)) !important;
        transform: translateY(-2px);
    }
    
    /* Green themed borders and accents */
    .glass {
        border: 2px solid rgba(16, 185, 129, 0.3) !important;
    }
    
    .glass:hover {
        border-color: #10b981 !important;
        box-shadow: 0 10px 40px rgba(16, 185, 129, 0.4) !important;
    }
    
    /* Charts grid layout */
    .charts-grid {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 2rem;
        margin-bottom: 2rem;
    }
    
    @media (max-width: 968px) {
        .charts-grid {
            grid-template-columns: 1fr;
        }
    }
    
    /* Payout settings layout */
    .payout-settings {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1.5rem;
        align-items: end;
    }
    
    .setting-group {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }
    
    .setting-group label {
        font-weight: 600;
        color: var(--text-secondary);
        font-size: 0.9rem;
    }
    
    .setting-group select,
    .setting-group input {
        padding: 0.75rem;
        background: var(--glass-bg);
        border: 2px solid rgba(16, 185, 129, 0.3);
        border-radius: 8px;
        color: white;
        font-size: 1rem;
    }
    
    .setting-group select:focus,
    .setting-group input:focus {
        outline: none;
        border-color: var(--micro-green);
    }
    
    .payout-settings .btn {
        height: fit-content;
    }
    
    #sources-chart {
        max-height: 300px !important;
    }
    
    /* Green footer titles */
    .footer-section h3 {
        color: #10b981 !important;
    }
    
    /* Tab Navigation */
    .tabs-container {
        display: flex;
        gap: 1rem;
        margin-bottom: 2rem;
        border-bottom: 2px solid rgba(16, 185, 129, 0.3);
        padding-bottom: 0;
    }
    
    .tab-btn {
        background: transparent;
        border: none;
        color: var(--text-secondary);
        padding: 1rem 2rem;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        border-bottom: 3px solid transparent;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .tab-btn:hover {
        color: var(--micro-light-green);
        background: rgba(16, 185, 129, 0.05);
    }
    
    .tab-btn.active {
        color: var(--micro-light-green);
        border-bottom-color: var(--micro-green);
    }
    
    .tab-btn i {
        font-size: 1.1rem;
    }
    
    /* Tab Content */
    .tab-content {
        display: none;
    }
    
    .tab-content.active {
        display: block;
        animation: fadeIn 0.3s ease;
    }
    
    @keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(10px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    /* Wallet Balance Cards */
    .wallet-balances {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-bottom: 2rem;
    }
    
    .balance-card {
        background: var(--glass-bg);
        border: 2px solid rgba(16, 185, 129, 0.3);
        border-radius: 12px;
        padding: 1.5rem;
        text-align: center;
        transition: all 0.3s ease;
    }
    
    .balance-card:hover {
        border-color: var(--micro-green);
        box-shadow: 0 5px 20px rgba(16, 185, 129, 0.3);
        transform: translateY(-3px);
    }
    
    .balance-card .token-icon {
        font-size: 2rem;
        color: var(--micro-light-green);
        margin-bottom: 0.5rem;
    }
    
    .balance-card .balance-amount {
        font-size: 1.8rem;
        font-weight: 700;
        color: white;
        margin-bottom: 0.25rem;
    }
    
    .balance-card .balance-label {
        color: var(--text-secondary);
        font-size: 0.9rem;
    }
    
    /* Quick Actions */
    .quick-actions {
        display: flex;
        gap: 1rem;
        margin-bottom: 2rem;
        flex-wrap: wrap;
    }
    
    .quick-actions .btn {
        flex: 1;
        min-width: 150px;
    }
    
    /* Green themed navigation links */
    .nav-link:hover {
        background: rgba(16, 185, 129, 0.1) !important;
        border-color: var(--micro-green) !important;
    }
    
    .nav-link.active {
        background: rgba(16, 185, 129, 0.2) !important;
        border-color: #10b981 !important;
    }
    
    .nav-link:hover i,
    .nav-link:hover span {
        color: var(--micro-light-green) !important;
    }
    
    .nav-link.active i,
    .nav-link.active span {
        color: #34d399 !important;
    }
    
    /* Green themed mobile nav */
    .mobile-nav a:hover,
    .mobile-nav a.active {
        background: rgba(16, 185, 129, 0.1) !important;
        color: var(--micro-light-green) !important;
    }
    
    /* Override any remaining orange/red colors */
    .card-actions select {
        border: 2px solid rgba(16, 185, 129, 0.3);
        background: var(--glass-bg);
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 8px;
    }
    
    .card-actions select:focus {
        outline: none;
        border-color: var(--micro-green);
    }
    
    /* Green text for positive amounts */
    .positive {
        color: var(--micro-light-green) !important;
    }
    
    /* Transaction type styling */
    .transaction-type {
        padding: 0.25rem 0.75rem;
        border-radius: 12px;
        font-size: 0.85rem;
        font-weight: 600;
        text-transform: capitalize;
    }
    
    .type-earning {
        background: rgba(16, 185, 129, 0.2);
        color: var(--micro-light-green);
    }
    
    .type-withdrawal {
        background: rgba(239, 68, 68, 0.2);
        color: #fca5a5;
    }
    
    /* Status badges */
    .status {
        padding: 0.25rem 0.75rem;
        border-radius: 12px;
        font-size: 0.85rem;
        font-weight: 600;
        text-transform: capitalize;
    }
    
    .status-completed {
        background: rgba(16, 185, 129, 0.2);
        color: var(--micro-light-green);
    }
    
    .status-pending {
        background: rgba(251, 191, 36, 0.2);
        color: #fcd34d;
    }
    
    .status-failed {
        background: rgba(239, 68, 68, 0.2);
        color: #fca5a5;
    }
    
    /* Table styling */
    .earnings-table {
        width: 100%;
        border-collapse: collapse;
    }
    
    .earnings-table thead {
        border-bottom: 2px solid rgba(16, 185, 129, 0.3);
    }
    
    .earnings-table th {
        padding: 1rem;
        text-align: left;
        color: var(--micro-light-green);
        font-weight: 600;
    }
    
    .earnings-table td {
        padding: 1rem;
        border-bottom: 1px solid rgba(16, 185, 129, 0.1);
        color: var(--text-secondary);
    }
    
    .earnings-table tr:hover {
        background: rgba(16, 185, 129, 0.05);
    }
    
    /* Modal styling */
    .modal-content {
        border: 2px solid rgba(16, 185, 129, 0.3);
    }
    
    .modal-header h2 {
        background: linear-gradient(135deg, #34d399, #fff);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }
    
    .form-group label {
        color: var(--micro-light-green);
        font-weight: 600;
    }
    
    .form-group input,
    .form-group select {
        background: var(--glass-bg);
        border: 2px solid rgba(16, 185, 129, 0.3);
        color: white;
        padding: 0.75rem;
        border-radius: 8px;
        width: 100%;
    }
    
    .form-group input:focus,
    .form-group select:focus {
        outline: none;
        border-color: var(--micro-green);
    }
    
    /* Button secondary styling */
    .btn-secondary {
        background: rgba(16, 185, 129, 0.1) !important;
        border: 2px solid rgba(16, 185, 129, 0.3) !important;
        color: var(--micro-light-green) !important;
    }
    
    .btn-secondary:hover {
        background: rgba(16, 185, 129, 0.2) !important;
        border-color: var(--micro-green) !important;
    }
    
    /* Mobile Optimization - Complete Overhaul */
    @media (max-width: 768px) {
        /* Prevent horizontal scrolling and fix viewport */
        html, body {
            overflow-x: hidden !important;
            width: 100% !important;
            max-width: 100vw !important;
            position: relative !important;
        }
        
        .page-container {
            padding: 0 !important;
            width: 100% !important;
            max-width: 100vw !important;
            overflow-x: hidden !important;
        }
        
        .page-header {
            padding: 1rem !important;
            margin-bottom: 0.5rem !important;
            width: 100% !important;
            max-width: 100vw !important;
            overflow-x: hidden !important;
        }
        
        /* Ensure all sections fit within viewport */
        .section, .glass, .stats-grid, .earnings-overview {
            width: 100% !important;
            max-width: 100vw !important;
            overflow-x: hidden !important;
            margin-left: 0 !important;
            margin-right: 0 !important;
        }
        
        /* Make mobile title white */
        .page-header h1 {
            color: white !important;
            background: none !important;
            -webkit-background-clip: unset !important;
            -webkit-text-fill-color: white !important;
            background-clip: unset !important;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.8) !important;
        }
        
        .page-header h1 {
            font-size: 1.5rem !important;
        }
        
        /* Remove nested glass */
        .section.glass {
            background: transparent !important;
            border: none !important;
            padding: 0.5rem 1rem !important;
            box-shadow: none !important;
        }
        
        .glass {
            background: rgba(16, 185, 129, 0.05) !important;
            border: 1px solid rgba(16, 185, 129, 0.3) !important;
            padding: 1rem !important;
        }
        
        /* Stats horizontal scroll */
        [style*="display: grid"][style*="grid-template-columns"] {
            display: flex !important;
            overflow-x: auto !important;
            scroll-snap-type: x mandatory !important;
            gap: 1rem !important;
            padding: 0 1rem !important;
            margin-left: -1rem !important;
            margin-right: -1rem !important;
            scrollbar-width: none !important;
        }
        
        [style*="display: grid"]::-webkit-scrollbar {
            display: none !important;
        }
        
        [style*="display: grid"] > * {
            flex: 0 0 70% !important;
            scroll-snap-align: center !important;
            min-width: 200px !important;
        }
        
        /* Buttons */
        .btn {
            width: 100% !important;
            padding: 0.875rem 1rem !important;
            font-size: 0.95rem !important;
        }
        
        /* Forms */
        input, select, textarea {
            font-size: 16px !important;
            padding: 0.75rem !important;
        }
        
        /* Reduce font sizes */
        .section-title {
            font-size: 1.3rem !important;
        }
        
        p {
            font-size: 0.95rem !important;
        }
        
        /* Fix tabs container for mobile */
        .tabs-container {
            display: flex !important;
            overflow-x: auto !important;
            scroll-snap-type: x mandatory !important;
            gap: 0.5rem !important;
            padding: 0.75rem 1rem !important;
            margin: 1rem 0 !important;
            scrollbar-width: none !important;
            -webkit-overflow-scrolling: touch !important;
            background: rgba(0, 0, 0, 0.3) !important;
            border-radius: 12px !important;
            width: 100% !important;
            max-width: 100% !important;
            justify-content: flex-start !important;
            align-items: center !important;
        }
        
        .tabs-container::-webkit-scrollbar {
            display: none !important;
        }
        
        .tab-btn {
            flex: 0 0 auto !important;
            white-space: nowrap !important;
            padding: 0.6rem 0.8rem !important;
            font-size: 0.8rem !important;
            scroll-snap-align: center !important;
            color: white !important;
            background: rgba(0, 0, 0, 0.6) !important;
            border: 2px solid rgba(16, 185, 129, 0.3) !important;
            border-radius: 8px !important;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.8) !important;
            height: 45px !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            text-align: center !important;
            min-width: 100px !important;
            max-width: 140px !important;
            margin: 0 auto !important;
        }
        
        .tab-btn.active {
            background: rgba(16, 185, 129, 0.2) !important;
            border-color: rgba(16, 185, 129, 0.6) !important;
        }
        
        .tab-btn i {
            color: white !important;
            margin-right: 0.4rem !important;
            font-size: 0.8rem !important;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="page-container">
    <div class="page-header">
        <h1><i class="fas fa-coins"></i> Earnings & Wallet</h1>
        <p>Manage your earnings, wallet balance, and withdrawals</p>
        
        <!-- Demo Disclaimer -->
        <div style="background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(37, 99, 235, 0.05)); border: 2px solid rgba(59, 130, 246, 0.3); border-radius: 12px; padding: 1rem 1.5rem; margin-top: 1.5rem; text-align: center;">
            <i class="fas fa-info-circle" style="color: #3b82f6; margin-right: 0.5rem;"></i>
            <span style="color: #93c5fd; font-size: 0.95rem; font-weight: 500;">
                Demo Preview: Earnings and transaction data shown are simulated examples. Real earnings tracking and wallet management will be available upon official platform launch.
            </span>
        </div>
    </div>

    <!-- Tab Navigation -->
    <div class="tabs-container">
        <button class="tab-btn active" onclick="switchTab('overview')">
            <i class="fas fa-chart-pie"></i> Overview
        </button>
        <button class="tab-btn" onclick="switchTab('earnings')">
            <i class="fas fa-coins"></i> Earnings History
        </button>
        <button class="tab-btn" onclick="switchTab('transactions')">
            <i class="fas fa-exchange-alt"></i> Transactions
        </button>
    </div>

    <!-- TAB 1: OVERVIEW -->
    <div id="overview-tab" class="tab-content active">
    <!-- Earnings Stats -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-wallet"></i>
            </div>
            <div class="stat-content">
                <h3 id="total-earnings">$0</h3>
                <p>Total Earnings</p>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-calendar-day"></i>
            </div>
            <div class="stat-content">
                <h3 id="today-earnings">$0</h3>
                <p>Today's Earnings</p>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-calendar-week"></i>
            </div>
            <div class="stat-content">
                <h3 id="week-earnings">$0</h3>
                <p>This Week</p>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-icon">
                <i class="fas fa-calendar-alt"></i>
            </div>
            <div class="stat-content">
                <h3 id="month-earnings">$0</h3>
                <p>This Month</p>
            </div>
        </div>
    </div>

    <!-- Wallet Balances -->
    <div class="wallet-balances">
        <div class="balance-card">
            <div class="token-icon">
                <i class="fas fa-coins"></i>
            </div>
            <div class="balance-amount" id="wead-balance">0</div>
            <div class="balance-label">WEAD Tokens</div>
        </div>
        <div class="balance-card">
            <div class="token-icon">
                <i class="fab fa-bitcoin"></i>
            </div>
            <div class="balance-amount" id="bnb-balance">0</div>
            <div class="balance-label">BNB Balance</div>
        </div>
        <div class="balance-card">
            <div class="token-icon">
                <i class="fas fa-dollar-sign"></i>
            </div>
            <div class="balance-amount" id="usd-value">$0</div>
            <div class="balance-label">Total USD Value</div>
        </div>
    </div>
    
    <!-- Quick Actions -->
    <div class="quick-actions">
        <button class="btn btn-primary" onclick="showWithdrawModal()">
            <i class="fas fa-money-bill-wave"></i> Withdraw to Bank
        </button>
        <button class="btn btn-secondary" onclick="showSendModal()">
            <i class="fas fa-paper-plane"></i> Send Crypto
        </button>
        <button class="btn btn-secondary" onclick="showSwapModal()">
            <i class="fas fa-exchange-alt"></i> Swap Tokens
        </button>
    </div>

    <!-- Charts Grid -->
    <div class="charts-grid">
    <!-- Earnings Chart -->
    <div class="content-card">
        <div class="card-header">
            <h2>Earnings Over Time</h2>
            <div class="card-actions">
                <select id="earnings-period" onchange="updateEarningsChart()">
                    <option value="7">Last 7 days</option>
                    <option value="30">Last 30 days</option>
                    <option value="90">Last 90 days</option>
                    <option value="365">Last year</option>
                </select>
            </div>
        </div>
        <div class="card-content">
            <canvas id="earnings-chart"></canvas>
        </div>
    </div>

    <!-- Earnings Sources -->
    <div class="content-card">
        <div class="card-header">
            <h2>Earnings by Source</h2>
        </div>
        <div class="card-content">
            <canvas id="sources-chart"></canvas>
            </div>
        </div>
    </div>

    </div>
    <!-- END TAB 1: OVERVIEW -->
    
    <!-- TAB 2: EARNINGS HISTORY -->
    <div id="earnings-tab" class="tab-content">
        <!-- Recent Earnings -->
    <div class="content-card">
        <div class="card-header">
                <h2>Recent Earnings</h2>
        </div>
        <div class="card-content">
            <div class="table-container">
                <table class="earnings-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Type</th>
                            <th>Description</th>
                            <th>Amount</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                        <tbody id="earnings-table">
                        <!-- Data will be loaded here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Payout Settings -->
    <div class="content-card">
        <div class="card-header">
            <h2>Payout Settings</h2>
        </div>
        <div class="card-content">
            <div class="payout-settings">
                <div class="setting-group">
                    <label for="payout-method">Payout Method</label>
                    <select id="payout-method">
                        <option value="bank">Bank Transfer</option>
                        <option value="crypto">Cryptocurrency</option>
                        <option value="paypal">PayPal</option>
                    </select>
                </div>
                <div class="setting-group">
                    <label for="payout-threshold">Minimum Payout Threshold</label>
                    <input type="number" id="payout-threshold" value="50" min="10" step="10">
                </div>
                <div class="setting-group">
                    <label for="payout-frequency">Payout Frequency</label>
                    <select id="payout-frequency">
                        <option value="weekly">Weekly</option>
                        <option value="biweekly">Bi-weekly</option>
                        <option value="monthly">Monthly</option>
                    </select>
                </div>
                <button class="btn btn-primary" onclick="savePayoutSettings()">
                    <i class="fas fa-save"></i> Save Settings
                </button>
            </div>
        </div>
    </div>
    </div>
    <!-- END TAB 2: EARNINGS HISTORY -->
    
    <!-- TAB 3: TRANSACTIONS -->
    <div id="transactions-tab" class="tab-content">
        <!-- Transaction History -->
        <div class="content-card">
            <div class="card-header">
                <h2>All Transactions</h2>
                <div class="card-actions">
                    <select id="transaction-filter" onchange="filterTransactions()">
                        <option value="all">All Transactions</option>
                        <option value="earning">Earnings</option>
                        <option value="withdrawal">Withdrawals</option>
                        <option value="sent">Sent</option>
                        <option value="received">Received</option>
                        <option value="swap">Swaps</option>
                    </select>
                </div>
            </div>
            <div class="card-content">
                <div class="table-container">
                    <table class="earnings-table transactions-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Type</th>
                                <th>Description</th>
                                <th>Amount</th>
                                <th>Status</th>
                                <th>Hash</th>
                            </tr>
                        </thead>
                        <tbody id="transactions-table">
                            <!-- Data will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <!-- END TAB 3: TRANSACTIONS -->
    
</div>

<!-- Send Crypto Modal -->
<div id="send-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2><i class="fas fa-paper-plane"></i> Send Crypto</h2>
            <span class="close" onclick="closeSendModal()">&times;</span>
        </div>
        <div class="modal-body">
            <form id="send-form">
                <div class="form-group">
                    <label for="send-token">Select Token</label>
                    <select id="send-token" name="token" required onchange="updateSendBalance()">
                        <option value="WEAD">WEAD Token</option>
                        <option value="BNB">BNB (Binance Coin)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="send-amount">Amount</label>
                    <input type="number" id="send-amount" name="amount" min="0" step="0.000001" required>
                    <small style="color: var(--micro-light-green);">Available: <span id="send-available-balance">0</span></small>
                </div>
                <div class="form-group">
                    <label for="send-address">Recipient Address (BSC)</label>
                    <input type="text" id="send-address" name="address" placeholder="0x..." required>
                    <small style="color: var(--text-secondary);">Enter BSC wallet address</small>
                </div>
                <div class="form-group">
                    <label>Network Fee (Estimated)</label>
                    <div style="color: var(--micro-light-green); font-weight: 600;">~0.0005 BNB</div>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeSendModal()">Cancel</button>
            <button type="button" class="btn btn-primary" onclick="sendCrypto()">
                <i class="fas fa-paper-plane"></i> Send
            </button>
        </div>
    </div>
</div>

<!-- Swap Tokens Modal -->
<div id="swap-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2><i class="fas fa-exchange-alt"></i> Swap Tokens</h2>
            <span class="close" onclick="closeSwapModal()">&times;</span>
        </div>
        <div class="modal-body">
            <form id="swap-form">
                <div class="swap-container" style="display: flex; flex-direction: column; gap: 1rem;">
                    <div class="swap-input">
                        <label>From</label>
                        <div style="display: flex; gap: 0.5rem; align-items: center;">
                            <input type="number" id="swap-from-amount" name="from_amount" min="0" step="0.000001" required style="flex: 1;" oninput="calculateSwapAmount()">
                            <select id="swap-from-token" name="from_token" style="width: 120px;" onchange="calculateSwapAmount()">
                                <option value="WEAD">WEAD</option>
                                <option value="BNB">BNB</option>
                            </select>
                        </div>
                        <small style="color: var(--micro-light-green);">Available: <span id="swap-from-balance">0</span></small>
                    </div>
                    
                    <div style="text-align: center;">
                        <button type="button" class="btn btn-secondary" onclick="swapTokenDirection()" style="padding: 0.5rem; border-radius: 50%; width: 40px; height: 40px;">
                            <i class="fas fa-exchange-alt"></i>
                        </button>
                    </div>
                    
                    <div class="swap-input">
                        <label>To</label>
                        <div style="display: flex; gap: 0.5rem; align-items: center;">
                            <input type="number" id="swap-to-amount" name="to_amount" readonly style="flex: 1; background: rgba(16, 185, 129, 0.1);">
                            <select id="swap-to-token" name="to_token" style="width: 120px;" disabled>
                                <option value="BNB">BNB</option>
                                <option value="WEAD">WEAD</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div style="margin-top: 1.5rem; padding: 1rem; background: rgba(16, 185, 129, 0.1); border-radius: 8px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                        <span style="color: var(--text-secondary);">Exchange Rate:</span>
                        <span style="color: white; font-weight: 600;">1 WEAD = <span id="swap-rate">0.000125</span> BNB</span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span style="color: var(--text-secondary);">Network Fee:</span>
                        <span style="color: white; font-weight: 600;">~0.0005 BNB</span>
                    </div>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeSwapModal()">Cancel</button>
            <button type="button" class="btn btn-primary" onclick="executeSwap()">
                <i class="fas fa-exchange-alt"></i> Swap
            </button>
        </div>
    </div>
</div>

<!-- Withdraw Modal -->
<div id="withdraw-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2><i class="fas fa-money-bill-wave"></i> Withdraw Earnings</h2>
            <span class="close" onclick="closeWithdrawModal()">&times;</span>
        </div>
        <div class="modal-body">
            <form id="withdraw-form">
                <!-- Amount -->
                <div class="form-group">
                    <label for="withdraw-amount">Withdrawal Amount ($)</label>
                    <input type="number" id="withdraw-amount" name="amount" min="10" step="0.01" required oninput="calculateWithdrawalFee()">
                    <small style="color: var(--micro-light-green);">Available balance: $<span id="available-balance">0</span></small>
                </div>
                
                <!-- Withdrawal Method -->
                <div class="form-group">
                    <label for="withdraw-method">Withdrawal Method</label>
                    <select id="withdraw-method" name="method" required onchange="updateWithdrawalFields()">
                        <option value="">Select method...</option>
                        <option value="bank">🏦 Bank Transfer</option>
                        <option value="crypto">💰 Cryptocurrency (MetaMask)</option>
                        <option value="paypal">💳 PayPal</option>
                    </select>
                </div>
                
                <!-- Bank Transfer Fields -->
                <div id="bank-fields" class="payment-fields" style="display: none;">
                <div class="form-group">
                        <label for="bank-name">Bank Name</label>
                        <input type="text" id="bank-name" name="bank_name" placeholder="e.g., Chase Bank">
                    </div>
                    <div class="form-group">
                        <label for="account-holder">Account Holder Name</label>
                        <input type="text" id="account-holder" name="account_holder" placeholder="Full name on account">
                    </div>
                    <div class="form-group">
                        <label for="account-number">Account Number</label>
                        <input type="text" id="account-number" name="account_number" placeholder="Enter account number">
                    </div>
                    <div class="form-group">
                        <label for="routing-number">Routing Number</label>
                        <input type="text" id="routing-number" name="routing_number" placeholder="9-digit routing number">
                    </div>
                </div>
                
                <!-- Crypto Fields -->
                <div id="crypto-fields" class="payment-fields" style="display: none;">
                    <div class="form-group">
                        <label for="crypto-token">Select Token</label>
                        <select id="crypto-token" name="crypto_token">
                            <option value="WEAD">WEAD Token</option>
                            <option value="BNB">BNB (Binance Coin)</option>
                            <option value="USDT">USDT (Tether)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="crypto-address">Wallet Address (BSC Network)</label>
                        <div style="display: flex; gap: 0.5rem;">
                            <input type="text" id="crypto-address" name="crypto_address" placeholder="0x..." style="flex: 1;">
                            <button type="button" class="btn btn-secondary" onclick="useMetaMaskAddress()" style="white-space: nowrap;">
                                <i class="fas fa-wallet"></i> Use MetaMask
                            </button>
                        </div>
                        <small style="color: var(--text-secondary);">Make sure this is a BSC (BEP-20) compatible address</small>
                    </div>
                    <div style="padding: 0.75rem; background: rgba(16, 185, 129, 0.1); border-radius: 8px; margin-top: 0.5rem;">
                        <div style="display: flex; align-items: center; gap: 0.5rem; color: var(--micro-light-green);">
                            <i class="fas fa-info-circle"></i>
                            <span style="font-size: 0.9rem;">Crypto withdrawals are instant and only pay network gas fees</span>
                        </div>
                    </div>
                </div>
                
                <!-- PayPal Fields -->
                <div id="paypal-fields" class="payment-fields" style="display: none;">
                    <div class="form-group">
                        <label for="paypal-email">PayPal Email</label>
                        <input type="email" id="paypal-email" name="paypal_email" placeholder="your@email.com">
                    </div>
                    <div class="form-group">
                        <label for="paypal-confirm">Confirm PayPal Email</label>
                        <input type="email" id="paypal-confirm" name="paypal_confirm" placeholder="your@email.com">
                    </div>
                </div>
                
                <!-- Fee & Summary -->
                <div id="withdrawal-summary" style="display: none; margin-top: 1.5rem; padding: 1rem; background: rgba(16, 185, 129, 0.1); border-radius: 8px; border: 2px solid rgba(16, 185, 129, 0.3);">
                    <h3 style="color: var(--micro-light-green); margin-bottom: 1rem; font-size: 1.1rem;">Withdrawal Summary</h3>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                        <span style="color: var(--text-secondary);">Amount:</span>
                        <span style="color: white; font-weight: 600;">$<span id="summary-amount">0.00</span></span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                        <span style="color: var(--text-secondary);">Processing Fee:</span>
                        <span style="color: white; font-weight: 600;">$<span id="summary-fee">0.00</span></span>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                        <span style="color: var(--text-secondary);">Processing Time:</span>
                        <span style="color: white; font-weight: 600;" id="summary-time">-</span>
                    </div>
                    <div style="border-top: 2px solid rgba(16, 185, 129, 0.3); margin: 0.75rem 0; padding-top: 0.75rem;"></div>
                    <div style="display: flex; justify-content: space-between;">
                        <span style="color: var(--micro-light-green); font-weight: 700;">You'll Receive:</span>
                        <span style="color: var(--micro-light-green); font-weight: 700; font-size: 1.2rem;">$<span id="summary-total">0.00</span></span>
                    </div>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeWithdrawModal()">Cancel</button>
            <button type="button" class="btn btn-primary" onclick="processWithdrawal()" id="withdraw-submit-btn" disabled>
                <i class="fas fa-paper-plane"></i> Send Payment
            </button>
        </div>
    </div>
</div>

<script>
// Earnings Dashboard JavaScript
let earningsData = {};

// Load earnings on page load
document.addEventListener('DOMContentLoaded', function() {
    loadEarnings();
    initializeEarningsCharts();
    setActiveNavLink();
});

// Set active navigation link with green styling
function setActiveNavLink() {
    const currentPath = window.location.pathname;
    const navLinks = document.querySelectorAll('.nav-link');
    
    navLinks.forEach(link => {
        link.classList.remove('active');
        const href = link.getAttribute('href');
        
        if (href === currentPath) {
            link.classList.add('active');
            // Apply green styling
            link.style.background = 'rgba(16, 185, 129, 0.2)';
            link.style.borderColor = '#10b981';
            const icon = link.querySelector('i');
            if (icon) {
                icon.style.color = '#34d399';
            }
            const span = link.querySelector('span');
            if (span) {
                span.style.color = '#34d399';
            }
        }
    });
}

async function loadEarnings() {
    try {
        const response = await fetch('/api/earnings/stats', {
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('token')}`
            }
        });
        
        if (response.ok) {
            const data = await response.json();
            earningsData = data;
            updateEarningsDisplay(data);
        } else {
            console.error('Failed to load earnings');
            loadMockEarnings();
        }
    } catch (error) {
        console.error('Error loading earnings:', error);
        loadMockEarnings();
    }
}

function loadMockEarnings() {
    earningsData = {
        total_earnings: 1250.50,
        today_earnings: 25.30,
        week_earnings: 180.75,
        month_earnings: 750.25,
        earnings_over_time: [
            { date: '2024-01-01', amount: 15.50 },
            { date: '2024-01-02', amount: 22.30 },
            { date: '2024-01-03', amount: 18.75 },
            { date: '2024-01-04', amount: 28.90 },
            { date: '2024-01-05', amount: 35.20 },
            { date: '2024-01-06', amount: 31.80 },
            { date: '2024-01-07', amount: 25.30 }
        ],
        earnings_sources: [
            { source: 'Ad Views', amount: 800.50 },
            { source: 'Device Rentals', amount: 300.00 },
            { source: 'Referrals', amount: 150.00 }
        ],
        transactions: [
            {
                date: '2024-01-07',
                type: 'earning',
                description: 'Ad view revenue',
                amount: 25.30,
                status: 'completed'
            },
            {
                date: '2024-01-06',
                type: 'earning',
                description: 'Device rental payment',
                amount: 50.00,
                status: 'completed'
            },
            {
                date: '2024-01-05',
                type: 'withdrawal',
                description: 'Bank transfer',
                amount: -200.00,
                status: 'pending'
            },
            {
                date: '2024-01-04',
                type: 'earning',
                description: 'Ad view revenue',
                amount: 28.90,
                status: 'completed'
            }
        ]
    };
    
    updateEarningsDisplay(earningsData);
    updateEarningsCharts(earningsData);
    updateTransactionsTable(earningsData.transactions);
}

function updateEarningsDisplay(data) {
    document.getElementById('total-earnings').textContent = `$${data.total_earnings || 0}`;
    document.getElementById('today-earnings').textContent = `$${data.today_earnings || 0}`;
    document.getElementById('week-earnings').textContent = `$${data.week_earnings || 0}`;
    document.getElementById('month-earnings').textContent = `$${data.month_earnings || 0}`;
    document.getElementById('available-balance').textContent = data.total_earnings || 0;
}

function initializeEarningsCharts() {
    // Initialize earnings chart
    const earningsCtx = document.getElementById('earnings-chart').getContext('2d');
    window.earningsChart = new Chart(earningsCtx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: 'Earnings ($)',
                data: [],
                borderColor: '#10b981',
                backgroundColor: 'rgba(16, 185, 129, 0.2)',
                tension: 0.4,
                fill: true,
                pointBackgroundColor: '#34d399',
                pointBorderColor: '#10b981',
                pointHoverBackgroundColor: '#6ee7b7',
                pointHoverBorderColor: '#059669',
                pointRadius: 4,
                pointHoverRadius: 6
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        color: '#cbd5e1'
                    },
                    grid: {
                        color: 'rgba(16, 185, 129, 0.1)'
                    }
                },
                x: {
                    ticks: {
                        color: '#cbd5e1'
                    },
                    grid: {
                        color: 'rgba(16, 185, 129, 0.1)'
                    }
                }
            },
            plugins: {
                legend: {
                    labels: {
                        color: '#cbd5e1'
                    }
                }
            }
        }
    });

    // Initialize sources chart
    const sourcesCtx = document.getElementById('sources-chart').getContext('2d');
    window.sourcesChart = new Chart(sourcesCtx, {
        type: 'doughnut',
        data: {
            labels: [],
            datasets: [{
                data: [],
                backgroundColor: [
                    '#10b981',  // Emerald green
                    '#34d399',  // Light green
                    '#059669',  // Dark emerald
                    '#6ee7b7',  // Very light green
                    '#047857'   // Forest green
                ]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    labels: {
                        color: '#cbd5e1'
                    }
                }
            }
        }
    });
}

function updateEarningsCharts(data) {
    // Update earnings chart
    if (data.earnings_over_time) {
        window.earningsChart.data.labels = data.earnings_over_time.map(item => item.date);
        window.earningsChart.data.datasets[0].data = data.earnings_over_time.map(item => item.amount);
        window.earningsChart.update();
    }

    // Update sources chart
    if (data.earnings_sources) {
        window.sourcesChart.data.labels = data.earnings_sources.map(item => item.source);
        window.sourcesChart.data.datasets[0].data = data.earnings_sources.map(item => item.amount);
        window.sourcesChart.update();
    }
}

function updateTransactionsTable(transactions) {
    const tbody = document.getElementById('transactions-table');
    
    tbody.innerHTML = transactions.map(transaction => `
        <tr>
            <td>${transaction.date}</td>
            <td>
                <span class="transaction-type type-${transaction.type}">
                    <i class="fas fa-${transaction.type === 'earning' ? 'plus' : 'minus'}"></i>
                    ${transaction.type}
                </span>
            </td>
            <td>${transaction.description}</td>
            <td class="${transaction.amount >= 0 ? 'positive' : 'negative'}">
                ${transaction.amount >= 0 ? '+' : ''}$${Math.abs(transaction.amount)}
            </td>
            <td><span class="status status-${transaction.status}">${transaction.status}</span></td>
        </tr>
    `).join('');
}

function updateEarningsChart() {
    const period = document.getElementById('earnings-period').value;
    // Reload earnings data with new period
    loadEarnings();
}

function showWithdrawModal() {
    document.getElementById('withdraw-modal').style.display = 'block';
    // Load available balance
    const totalEarnings = earningsData.total_earnings || 0;
    document.getElementById('available-balance').textContent = totalEarnings.toFixed(2);
}

function closeWithdrawModal() {
    document.getElementById('withdraw-modal').style.display = 'none';
    document.getElementById('withdraw-form').reset();
    document.getElementById('withdrawal-summary').style.display = 'none';
    document.getElementById('withdraw-submit-btn').disabled = true;
    
    // Hide all payment fields
    document.getElementById('bank-fields').style.display = 'none';
    document.getElementById('crypto-fields').style.display = 'none';
    document.getElementById('paypal-fields').style.display = 'none';
}

// Update withdrawal fields based on selected method
function updateWithdrawalFields() {
    const method = document.getElementById('withdraw-method').value;
    
    // Hide all payment fields first
    document.getElementById('bank-fields').style.display = 'none';
    document.getElementById('crypto-fields').style.display = 'none';
    document.getElementById('paypal-fields').style.display = 'none';
    
    // Show relevant fields
    if (method === 'bank') {
        document.getElementById('bank-fields').style.display = 'block';
    } else if (method === 'crypto') {
        document.getElementById('crypto-fields').style.display = 'block';
    } else if (method === 'paypal') {
        document.getElementById('paypal-fields').style.display = 'block';
    }
    
    // Recalculate fees
    calculateWithdrawalFee();
}

// Use MetaMask address for crypto withdrawal
function useMetaMaskAddress() {
    const userWallet = localStorage.getItem('user_wallet');
    if (!userWallet) {
        alert('Please connect MetaMask first from the header!');
        return;
    }
    
    document.getElementById('crypto-address').value = userWallet;
    calculateWithdrawalFee();
}

// Calculate withdrawal fee based on method and amount
function calculateWithdrawalFee() {
    const amount = parseFloat(document.getElementById('withdraw-amount').value) || 0;
    const method = document.getElementById('withdraw-method').value;
    
    if (amount <= 0 || !method) {
        document.getElementById('withdrawal-summary').style.display = 'none';
        document.getElementById('withdraw-submit-btn').disabled = true;
        return;
    }
    
    let fee = 0;
    let processingTime = '';
    
    // Calculate fee based on method
    if (method === 'bank') {
        // Bank: $5 or 2%, whichever is greater
        fee = Math.max(5, amount * 0.02);
        processingTime = '3-5 business days';
    } else if (method === 'crypto') {
        // Crypto: Network gas fee (estimated)
        fee = 0.50; // Flat fee for simplicity
        processingTime = 'Instant';
    } else if (method === 'paypal') {
        // PayPal: 2.9% + $0.30
        fee = (amount * 0.029) + 0.30;
        processingTime = '1-2 business days';
    }
    
    const total = amount - fee;
    
    // Update summary
    document.getElementById('summary-amount').textContent = amount.toFixed(2);
    document.getElementById('summary-fee').textContent = fee.toFixed(2);
    document.getElementById('summary-time').textContent = processingTime;
    document.getElementById('summary-total').textContent = total.toFixed(2);
    document.getElementById('withdrawal-summary').style.display = 'block';
    
    // Enable submit button if valid
    const availableBalance = parseFloat(document.getElementById('available-balance').textContent);
    if (amount <= availableBalance && total > 0) {
        document.getElementById('withdraw-submit-btn').disabled = false;
    } else {
        document.getElementById('withdraw-submit-btn').disabled = true;
    }
}

async function processWithdrawal() {
    const amount = parseFloat(document.getElementById('withdraw-amount').value);
    const method = document.getElementById('withdraw-method').value;
    const availableBalance = parseFloat(document.getElementById('available-balance').textContent);
    
    // Validation
    if (!amount || amount <= 0) {
        alert('Please enter a valid amount');
        return;
    }
    
    if (amount > availableBalance) {
        alert('Insufficient balance');
        return;
    }
    
    if (!method) {
        alert('Please select a withdrawal method');
        return;
    }
    
    // Method-specific validation and processing
    if (method === 'bank') {
        await processBankWithdrawal(amount);
    } else if (method === 'crypto') {
        await processCryptoWithdrawal(amount);
    } else if (method === 'paypal') {
        await processPayPalWithdrawal(amount);
    }
}

async function processBankWithdrawal(amount) {
    const bankName = document.getElementById('bank-name').value;
    const accountHolder = document.getElementById('account-holder').value;
    const accountNumber = document.getElementById('account-number').value;
    const routingNumber = document.getElementById('routing-number').value;
    
    if (!bankName || !accountHolder || !accountNumber || !routingNumber) {
        alert('Please fill in all bank details');
        return;
    }
    
    // Validate routing number (9 digits)
    if (!/^\d{9}$/.test(routingNumber)) {
        alert('Routing number must be 9 digits');
        return;
    }
    
    const withdrawalData = {
        amount: amount,
        method: 'bank',
        bank_name: bankName,
        account_holder: accountHolder,
        account_number: accountNumber,
        routing_number: routingNumber
    };
    
    try {
        // In production, send to backend API
        console.log('Bank withdrawal:', withdrawalData);
        
        alert(
            `Bank Withdrawal Submitted!\n\n` +
            `Amount: $${amount.toFixed(2)}\n` +
            `Bank: ${bankName}\n` +
            `Account: ***${accountNumber.slice(-4)}\n\n` +
            `Processing time: 3-5 business days\n` +
            `You'll receive a confirmation email shortly.`
        );
        
        closeWithdrawModal();
        loadEarnings();
        loadAllTransactions();
        
    } catch (error) {
        console.error('Bank withdrawal error:', error);
        alert('Error processing bank withdrawal');
    }
}

async function processCryptoWithdrawal(amount) {
    const userWallet = localStorage.getItem('user_wallet');
    if (!userWallet) {
        alert('Please connect MetaMask first!');
        return;
    }
    
    const token = document.getElementById('crypto-token').value;
    const toAddress = document.getElementById('crypto-address').value;
    
    if (!toAddress) {
        alert('Please enter a wallet address');
        return;
    }
    
    // Validate BSC address
    if (!toAddress.match(/^0x[a-fA-F0-9]{40}$/)) {
        alert('Invalid BSC address format');
        return;
    }
    
    try {
        if (!window.ethereum) {
            alert('MetaMask not found!');
            return;
        }
        
        // Convert USD amount to token amount
        let tokenAmount;
        if (token === 'WEAD') {
            // Assuming 1 WEAD = $0.0375
            tokenAmount = amount / 0.0375;
        } else if (token === 'BNB') {
            // Assuming 1 BNB = $300
            tokenAmount = amount / 300;
        } else if (token === 'USDT') {
            // 1:1 with USD
            tokenAmount = amount;
        }
        
        const confirmed = confirm(
            `Crypto Withdrawal Confirmation\n\n` +
            `Amount: $${amount.toFixed(2)}\n` +
            `Token: ${tokenAmount.toFixed(6)} ${token}\n` +
            `To: ${toAddress}\n` +
            `Network: BSC (BEP-20)\n\n` +
            `This transaction is instant and irreversible.\n` +
            `Continue?`
        );
        
        if (!confirmed) return;
        
        // For BNB, send directly
        if (token === 'BNB') {
            const amountInWei = (tokenAmount * Math.pow(10, 18)).toString(16);
            
            const transactionParameters = {
                from: userWallet,
                to: toAddress,
                value: '0x' + parseInt(amountInWei).toString(16),
                gas: '0x5208',
            };
            
            const txHash = await window.ethereum.request({
                method: 'eth_sendTransaction',
                params: [transactionParameters],
            });
            
            alert(
                `Crypto Withdrawal Sent!\n\n` +
                `Transaction Hash: ${txHash}\n\n` +
                `View on BSCScan:\nhttps://bscscan.com/tx/${txHash}`
            );
            
            closeWithdrawModal();
            loadEarnings();
            loadAllTransactions();
            
        } else {
            // For WEAD/USDT, need contract integration
            alert(
                `${token} withdrawal coming soon!\n\n` +
                `For now, you can withdraw BNB.\n` +
                `${token} contract integration is in progress.`
            );
        }
        
    } catch (error) {
        console.error('Crypto withdrawal error:', error);
        if (error.code === 4001) {
            alert('Transaction rejected by user');
        } else {
            alert('Error processing crypto withdrawal: ' + error.message);
        }
    }
}

async function processPayPalWithdrawal(amount) {
    const paypalEmail = document.getElementById('paypal-email').value;
    const paypalConfirm = document.getElementById('paypal-confirm').value;
    
    if (!paypalEmail || !paypalConfirm) {
        alert('Please enter and confirm your PayPal email');
        return;
    }
    
    if (paypalEmail !== paypalConfirm) {
        alert('PayPal email addresses do not match');
        return;
    }
    
    // Validate email format
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(paypalEmail)) {
        alert('Invalid email format');
        return;
    }
    
    const withdrawalData = {
        amount: amount,
        method: 'paypal',
        paypal_email: paypalEmail
    };
    
    try {
        // In production, send to backend API
        console.log('PayPal withdrawal:', withdrawalData);
        
        alert(
            `PayPal Withdrawal Submitted!\n\n` +
            `Amount: $${amount.toFixed(2)}\n` +
            `PayPal: ${paypalEmail}\n\n` +
            `Processing time: 1-2 business days\n` +
            `You'll receive a confirmation email shortly.`
        );
        
        closeWithdrawModal();
        loadEarnings();
        loadAllTransactions();
        
    } catch (error) {
        console.error('PayPal withdrawal error:', error);
        alert('Error processing PayPal withdrawal');
    }
}

function savePayoutSettings() {
    const settings = {
        method: document.getElementById('payout-method').value,
        threshold: parseFloat(document.getElementById('payout-threshold').value),
        frequency: document.getElementById('payout-frequency').value
    };
    
    // Save settings (implement API call)
    console.log('Saving payout settings:', settings);
    alert('Payout settings saved successfully');
}

// Tab Switching Function
function switchTab(tabName) {
    // Hide all tabs
    document.querySelectorAll('.tab-content').forEach(tab => {
        tab.classList.remove('active');
    });
    
    // Remove active class from all tab buttons
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    
    // Show selected tab
    document.getElementById(`${tabName}-tab`).classList.add('active');
    
    // Add active class to clicked button
    event.target.closest('.tab-btn').classList.add('active');
    
    // Load specific data for each tab
    if (tabName === 'overview') {
        loadEarnings();
        loadWalletBalance();
    } else if (tabName === 'earnings') {
        loadEarningsTable();
    } else if (tabName === 'transactions') {
        loadAllTransactions();
    }
}

// Load wallet balance
function loadWalletBalance() {
    // Mock wallet data
    const walletData = {
        wead_balance: 1250.50,
        bnb_balance: 0.125,
        usd_value: 1375.25
    };
    
    document.getElementById('wead-balance').textContent = walletData.wead_balance.toFixed(2);
    document.getElementById('bnb-balance').textContent = walletData.bnb_balance.toFixed(4);
    document.getElementById('usd-value').textContent = `$${walletData.usd_value.toFixed(2)}`;
}

// Load earnings table for Tab 2
function loadEarningsTable() {
    const earningsTransactions = [
        {
            date: '2024-01-07',
            type: 'earning',
            description: 'Ad impressions - WeAD Rooftop Display #1',
            amount: 25.30,
            status: 'completed'
        },
        {
            date: '2024-01-07',
            type: 'earning',
            description: 'Ad views - WeAD Delivery Box Display #3',
            amount: 18.50,
            status: 'completed'
        },
        {
            date: '2024-01-06',
            type: 'earning',
            description: 'Daily earnings from all displays',
            amount: 50.00,
            status: 'completed'
        },
        {
            date: '2024-01-05',
            type: 'withdrawal',
            description: 'Bank transfer withdrawal',
            amount: -200.00,
            status: 'pending'
        },
        {
            date: '2024-01-04',
            type: 'earning',
            description: 'Weekly bonus earnings',
            amount: 75.00,
            status: 'completed'
        }
    ];
    
    const tbody = document.getElementById('earnings-table');
    tbody.innerHTML = earningsTransactions.map(tx => `
        <tr>
            <td>${tx.date}</td>
            <td>
                <span class="transaction-type type-${tx.type}">
                    <i class="fas fa-${tx.type === 'earning' ? 'plus-circle' : 'minus-circle'}"></i>
                    ${tx.type}
                </span>
            </td>
            <td>${tx.description}</td>
            <td class="${tx.amount >= 0 ? 'positive' : 'negative'}">
                ${tx.amount >= 0 ? '+' : ''}$${Math.abs(tx.amount).toFixed(2)}
            </td>
            <td><span class="status status-${tx.status}">${tx.status}</span></td>
        </tr>
    `).join('');
}

// Load all transactions for Tab 3 (Earnings + Crypto)
function loadAllTransactions() {
    const allTransactions = [
        {
            date: '2024-01-07',
            type: 'earning',
            description: 'Ad impressions revenue',
            amount: 25.30,
            status: 'completed',
            hash: '0x1a2b...3c4d'
        },
        {
            date: '2024-01-07',
            type: 'received',
            description: 'WEAD tokens received',
            amount: 50.00,
            status: 'confirmed',
            hash: '0x5e6f...7g8h'
        },
        {
            date: '2024-01-06',
            type: 'withdrawal',
            description: 'Bank transfer',
            amount: -200.00,
            status: 'pending',
            hash: 'N/A'
        },
        {
            date: '2024-01-06',
            type: 'sent',
            description: 'WEAD tokens sent',
            amount: -25.00,
            status: 'confirmed',
            hash: '0x9i0j...1k2l'
        },
        {
            date: '2024-01-05',
            type: 'swap',
            description: 'Swapped WEAD to BNB',
            amount: 100.00,
            status: 'confirmed',
            hash: '0x3m4n...5o6p'
        },
        {
            date: '2024-01-05',
            type: 'earning',
            description: 'Daily earnings',
            amount: 35.20,
            status: 'completed',
            hash: '0x7q8r...9s0t'
        }
    ];
    
    const tbody = document.getElementById('transactions-table');
    tbody.innerHTML = allTransactions.map(tx => `
        <tr>
            <td>${tx.date}</td>
            <td>
                <span class="transaction-type type-${tx.type}">
                    <i class="fas fa-${getTransactionIcon(tx.type)}"></i>
                    ${tx.type}
                </span>
            </td>
            <td>${tx.description}</td>
            <td class="${tx.amount >= 0 ? 'positive' : 'negative'}">
                ${tx.amount >= 0 ? '+' : ''}$${Math.abs(tx.amount).toFixed(2)}
            </td>
            <td><span class="status status-${tx.status}">${tx.status}</span></td>
            <td>
                ${tx.hash !== 'N/A' ? `<a href="https://bscscan.com/tx/${tx.hash}" target="_blank" class="tx-hash">${tx.hash}</a>` : 'N/A'}
            </td>
        </tr>
    `).join('');
}

function getTransactionIcon(type) {
    const icons = {
        'earning': 'plus-circle',
        'withdrawal': 'minus-circle',
        'sent': 'arrow-up',
        'received': 'arrow-down',
        'swap': 'exchange-alt'
    };
    return icons[type] || 'circle';
}

function filterTransactions() {
    const filter = document.getElementById('transaction-filter').value;
    console.log('Filtering transactions by:', filter);
    // Reload with filter
    loadAllTransactions();
}

// ===== SEND CRYPTO FUNCTIONS =====
function showSendModal() {
    // Check if MetaMask is connected
    const userWallet = localStorage.getItem('user_wallet');
    if (!userWallet) {
        alert('Please connect MetaMask first!');
        return;
    }
    
    document.getElementById('send-modal').style.display = 'block';
    updateSendBalance();
    loadWalletBalances();
}

function closeSendModal() {
    document.getElementById('send-modal').style.display = 'none';
    document.getElementById('send-form').reset();
}

function updateSendBalance() {
    const token = document.getElementById('send-token').value;
    const balance = token === 'WEAD' ? document.getElementById('wead-balance').textContent : document.getElementById('bnb-balance').textContent;
    document.getElementById('send-available-balance').textContent = `${balance} ${token}`;
}

async function sendCrypto() {
    const userWallet = localStorage.getItem('user_wallet');
    if (!userWallet) {
        alert('Please connect MetaMask first!');
        return;
    }
    
    const token = document.getElementById('send-token').value;
    const amount = document.getElementById('send-amount').value;
    const toAddress = document.getElementById('send-address').value;
    
    if (!amount || !toAddress) {
        alert('Please fill in all fields');
        return;
    }
    
    // Validate BSC address
    if (!toAddress.match(/^0x[a-fA-F0-9]{40}$/)) {
        alert('Invalid BSC address format');
        return;
    }
    
    try {
        if (!window.ethereum) {
            alert('MetaMask not found!');
            return;
        }
        
        // Convert amount to Wei (for BNB) or token decimals (for WEAD)
        const amountInWei = window.ethereum.utils ? 
            window.ethereum.utils.toWei(amount, 'ether') : 
            (parseFloat(amount) * Math.pow(10, 18)).toString(16);
        
        let txHash;
        
        if (token === 'BNB') {
            // Send BNB
            const transactionParameters = {
                from: userWallet,
                to: toAddress,
                value: '0x' + parseInt(amountInWei).toString(16),
                gas: '0x5208', // 21000 gas
            };
            
            txHash = await window.ethereum.request({
                method: 'eth_sendTransaction',
                params: [transactionParameters],
            });
        } else {
            // Send WEAD Token (ERC-20)
            const WEAD_CONTRACT = '0x...'; // TODO: Add actual WEAD contract address
            const tokenABI = [
                {
                    "constant": false,
                    "inputs": [
                        {"name": "_to", "type": "address"},
                        {"name": "_value", "type": "uint256"}
                    ],
                    "name": "transfer",
                    "outputs": [{"name": "", "type": "bool"}],
                    "type": "function"
                }
            ];
            
            // For now, show message that WEAD contract needs to be configured
            alert('WEAD token contract integration coming soon! For now, you can send BNB.');
            return;
        }
        
        alert(`Transaction sent! Hash: ${txHash}\n\nView on BSCScan: https://bscscan.com/tx/${txHash}`);
        closeSendModal();
        
        // Reload balances
        setTimeout(() => {
            loadWalletBalances();
            loadAllTransactions();
        }, 2000);
        
    } catch (error) {
        console.error('Send error:', error);
        if (error.code === 4001) {
            alert('Transaction rejected by user');
        } else {
            alert('Error sending crypto: ' + error.message);
        }
    }
}

// ===== SWAP TOKENS FUNCTIONS =====
function showSwapModal() {
    const userWallet = localStorage.getItem('user_wallet');
    if (!userWallet) {
        alert('Please connect MetaMask first!');
        return;
    }
    
    document.getElementById('swap-modal').style.display = 'block';
    loadSwapRate();
    updateSwapBalance();
}

function closeSwapModal() {
    document.getElementById('swap-modal').style.display = 'none';
    document.getElementById('swap-form').reset();
}

function loadSwapRate() {
    // Mock exchange rate (1 WEAD = 0.000125 BNB)
    // In production, fetch from DEX or price oracle
    const rate = 0.000125;
    document.getElementById('swap-rate').textContent = rate;
}

function updateSwapBalance() {
    const fromToken = document.getElementById('swap-from-token').value;
    const balance = fromToken === 'WEAD' ? document.getElementById('wead-balance').textContent : document.getElementById('bnb-balance').textContent;
    document.getElementById('swap-from-balance').textContent = `${balance} ${fromToken}`;
}

function swapTokenDirection() {
    const fromToken = document.getElementById('swap-from-token');
    const toToken = document.getElementById('swap-to-token');
    
    // Swap the values
    const temp = fromToken.value;
    fromToken.value = toToken.value;
    toToken.value = temp;
    
    // Clear amounts
    document.getElementById('swap-from-amount').value = '';
    document.getElementById('swap-to-amount').value = '';
    
    // Update balance and rate
    updateSwapBalance();
    calculateSwapAmount();
}

function calculateSwapAmount() {
    const fromAmount = parseFloat(document.getElementById('swap-from-amount').value) || 0;
    const fromToken = document.getElementById('swap-from-token').value;
    const rate = parseFloat(document.getElementById('swap-rate').textContent);
    
    let toAmount = 0;
    if (fromToken === 'WEAD') {
        // WEAD to BNB
        toAmount = fromAmount * rate;
    } else {
        // BNB to WEAD
        toAmount = fromAmount / rate;
    }
    
    document.getElementById('swap-to-amount').value = toAmount.toFixed(6);
    updateSwapBalance();
}

async function executeSwap() {
    const userWallet = localStorage.getItem('user_wallet');
    if (!userWallet) {
        alert('Please connect MetaMask first!');
        return;
    }
    
    const fromToken = document.getElementById('swap-from-token').value;
    const toToken = document.getElementById('swap-to-token').value;
    const fromAmount = document.getElementById('swap-from-amount').value;
    const toAmount = document.getElementById('swap-to-amount').value;
    
    if (!fromAmount || parseFloat(fromAmount) <= 0) {
        alert('Please enter a valid amount');
        return;
    }
    
    try {
        if (!window.ethereum) {
            alert('MetaMask not found!');
            return;
        }
        
        // Show confirmation
        const confirmed = confirm(
            `Swap ${fromAmount} ${fromToken} for ${toAmount} ${toToken}?\n\n` +
            `Exchange Rate: 1 WEAD = ${document.getElementById('swap-rate').textContent} BNB\n` +
            `Network Fee: ~0.0005 BNB`
        );
        
        if (!confirmed) return;
        
        // In production, this would interact with PancakeSwap or other DEX
        // For now, show message that DEX integration is needed
        alert(
            'DEX Integration Coming Soon!\n\n' +
            'This will connect to PancakeSwap on BSC to swap tokens.\n' +
            'For now, you can use PancakeSwap directly at pancakeswap.finance'
        );
        
        // TODO: Implement PancakeSwap Router integration
        // const PANCAKE_ROUTER = '0x10ED43C718714eb63d5aA57B78B54704E256024E';
        // Call swapExactTokensForTokens or swapExactETHForTokens
        
        closeSwapModal();
        
    } catch (error) {
        console.error('Swap error:', error);
        if (error.code === 4001) {
            alert('Transaction rejected by user');
        } else {
            alert('Error swapping tokens: ' + error.message);
        }
    }
}

// Load wallet balances from MetaMask
async function loadWalletBalances() {
    const userWallet = localStorage.getItem('user_wallet');
    if (!userWallet || !window.ethereum) {
        return;
    }
    
    try {
        // Get BNB balance
        const bnbBalance = await window.ethereum.request({
            method: 'eth_getBalance',
            params: [userWallet, 'latest']
        });
        
        // Convert from Wei to BNB
        const bnbInEther = parseInt(bnbBalance, 16) / Math.pow(10, 18);
        document.getElementById('bnb-balance').textContent = bnbInEther.toFixed(4);
        
        // TODO: Get WEAD token balance from contract
        // For now, use mock data
        const weadBalance = 1250.50;
        document.getElementById('wead-balance').textContent = weadBalance.toFixed(2);
        
        // Calculate USD value (mock)
        const bnbPrice = 300; // USD per BNB
        const weadPrice = 0.0375; // USD per WEAD (0.000125 BNB * 300)
        const usdValue = (bnbInEther * bnbPrice) + (weadBalance * weadPrice);
        document.getElementById('usd-value').textContent = `$${usdValue.toFixed(2)}`;
        
    } catch (error) {
        console.error('Error loading wallet balances:', error);
    }
}

// Close modals when clicking outside
window.onclick = function(event) {
    const withdrawModal = document.getElementById('withdraw-modal');
    const sendModal = document.getElementById('send-modal');
    const swapModal = document.getElementById('swap-modal');
    
    if (event.target === withdrawModal) {
        closeWithdrawModal();
    }
    if (event.target === sendModal) {
        closeSendModal();
    }
    if (event.target === swapModal) {
        closeSwapModal();
    }
}

// Load wallet balances on page load
document.addEventListener('DOMContentLoaded', function() {
    loadWalletBalances();
});
</script>
{% endblock %}


